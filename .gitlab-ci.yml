---
before_script:
- echo $CI_JOB_STAGE
- date
- ls
- pwd

after_script:
- date

variables:
    GIT_SSL_NO_VERIFY: "1"
    DEPLOY_DOMAIN: deploy.funcoff.club

stages:
    - prebuild
    - test
    - build
    - deploy-review
    - staging
    - deploy
    - clean-on-failure


.init_template: &init
    tags:
        - build2-cup-front


docker build:
    <<: *init
    stage: prebuild
    script:
        - echo "Prebuild checking... Getting docker container rdy."
        - docker container stop ${CI_PROJECT_NAME} || sleep 0.1
        - env
        - docker build -t ${CI_PROJECT_NAME} .
    only:
          #- master
          #- develop
        - merge_requests

testing website:
    <<: *init
    stage: test
    script:
        - echo "Doing some tests... Someone should add unit tests or whatever here"
          #- docker run -v $(pwd):/app -v /app/node_modules -d  --rm --name ${CI_PROJECT_NAME} -it ${CI_PROJECT_NAME}

        - docker run --rm --name ${CI_PROJECT_NAME} -d ${CI_PROJECT_NAME}
        - ./init-docker.sh
    only:
        - merge_requests
 
build artifact:
    <<: *init
    stage: build
    script:
        - docker build . -t ${CI_PROJECT_NAME}_prod -f Dockerfile.prod
        - docker stop ${CI_PROJECT_NAME}_prod || sleep 0.1
        - docker container rm ${CI_PROJECT_NAME}_prod || sleep 0.1
        - docker run --rm --name ${CI_PROJECT_NAME}_prod  -d ${CI_PROJECT_NAME}_prod ; docker exec ${CI_PROJECT_NAME}_prod ng build
        - docker cp ${CI_PROJECT_NAME}_prod:/app/dist/evj ./public
        - docker container stop ${CI_PROJECT_NAME}_prod
    only:
        - master
        - develop
          #- merge_requests
    artifacts:
        paths:
            - ./public

deploy review:
    <<: *init
    stage: deploy-review
    only:
        - merge_requests
    environment:
        name: review/${CI_COMMIT_REF_NAME}
        url: http://build.funcoff.club:8000
        on_stop: stop-review
    script:
        - sed -i -E "s/(<title>Evj)(<\/title>)/\1  |  ${CI_COMMIT_SHORT_SHA}\2/g" ./src/index.html

stop-review:
    <<: *init
    variables:
        GIT_STRATEGY: none
    stage: deploy-review
    only:
        - merge_requests
    script:
        - docker container stop ${CI_PROJECT_NAME}
    when: manual
    environment:
        name: review/${CI_COMMIT_REF_NAME}
        action: stop

staging:
    <<: *init
    stage: staging
    environment:
        name: staging
        url: http://${DEPLOY_DOMAIN}:88
    variables:
        CMD_REPLACE: sed -i -E "s/(<title>Evj)(<\/title>)/\1 | ${CI_COMMIT_SHORT_SHA} \2/g" /var/www/angular-staging.local/public/index.html
    script:
        - ssh root@${DEPLOY_DOMAIN} rm -rf /var/www/angular-staging.local/public
        - scp -r ./public root@${DEPLOY_DOMAIN}:/var/www/angular-staging.local
        - ssh root@${DEPLOY_DOMAIN} $CMD_REPLACE
        - ssh root@${DEPLOY_DOMAIN} "sed -i  's/:5555/:6555/g' /var/www/angular-staging.local/public/assets/config.json || sleep 0.1"
        - ssh root@${DEPLOY_DOMAIN} nginx -s reload
    only:
        - develop

prod:
    <<: *init
    stage: deploy
    environment:
        name: prod
        url: http://${DEPLOY_DOMAIN}:80
    variables:
        CMD_REPLACE: sed -i -E "s/(<title>Evj)(<\/title>)/\1 | ${CI_COMMIT_SHORT_SHA} \2/g" /var/www/angular.local/public/index.html
    script:
        - ssh root@${DEPLOY_DOMAIN} rm -rf /var/www/angular.local/public
        - scp -r ./public root@${DEPLOY_DOMAIN}:/var/www/angular.local
        - ssh root@${DEPLOY_DOMAIN} $CMD_REPLACE
        - ssh root@${DEPLOY_DOMAIN} "sed -i  's/:6555/:5555/g' /var/www/angular.local/public/assets/config.json || sleep 0.1"
        - ssh root@${DEPLOY_DOMAIN} nginx -s reload
    only:
        - master

release maker:
    <<: *init
    stage: release
    script:
        - env
        - ls
        - echo "Check if MILESTONE environment supplied"
          #- if [[ -z $MILESTONE  ]]; then echo "no variable detected"; exit 1; fi
        - cd ./release_notes
        - echo "Cooking tags to make future release of release branch!:))"
        - scp ./pull-master.sh ${SCP_HOST}:/tmp
        - ssh ${SCP_HOST} "bash /tmp/pull-master.sh $TAGNAME"
        - echo "Proceeding to making release notes"
        - echo "Setting locale to UTF-8 (docker fix)"
          # - export LANG=C.UTF-8
        - python3 release-notes.py
        - ls ./output
        - bash upload_release.sh  
          #only:
          #- release
    when:
        manual

clean on failure:
    <<: *init
    stage: clean-on-failure
    script:
        - docker container stop ${CI_PROJECT_NAME}
    when: on_failure
