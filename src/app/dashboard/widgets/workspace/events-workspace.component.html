<div id="snackbar"></div>

<div class="container pointer-event">
  <!-- loading data -->
  <div class="loading-shade" *ngIf="isLoading">
    <div class="item loading-6">
      <svg viewBox="25 25 50 50">
        <circle cx="50" cy="50" r="20"></circle>
      </svg>
    </div>
  </div>
  <evj-widget-header [title]="title" [id]="id"></evj-widget-header>

  <evj-frame-top></evj-frame-top>

  <ng-container *ngIf="isMock">
    <div class="mock"></div>
  </ng-container>


  <ng-container *ngIf="!isMock && event">

    <div class="change-shift" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()">

      <div class="workspace__header__block">
        <section class="workspace__blocks" style="margin-right: 10px;">

          <div class="workspace__block">
            <div class="workspace__block__title">
              Дата / время:
            </div>
            <div class="workspace__block__body">
              {{ event.eventDateTime | date:'dd-MM-yyyy HH:mm' }}
            </div>
          </div>

          <div class="workspace__block">
            <div class="workspace__block__title">
              Организация:
            </div>
            <div class="workspace__block__body">
              {{ event.organization }}
            </div>
          </div>

          <div class="workspace__block">
            <div class="workspace__block__title">
              Смена:
            </div>
            <div class="workspace__block__body">
              Бригада-3
            </div>
          </div>

          <div class="workspace__block">
            <div class="workspace__block__title">
              Подразделение:
            </div>
            <div class="workspace__block__body">
              {{ event.branch }}
            </div>
          </div>

          <div class="workspace__block">
            <div class="workspace__block__title">
              Место:
            </div>
            <div class="workspace__block__body">
              <!-- {{ event.place.name }} -->
              ГФУ-2 с БОР
            </div>
          </div>

          <div class="workspace__block">
            <div class="workspace__block__title">
              Зафиксировал:
            </div>
            <div class="workspace__block__body" style="max-width: 120px;">


              <div class="dropdown dropdown-dark">
                <select name="contactMethod" class="dropdown-select" [(ngModel)]="event.fixedBy"
                  [compareWith]="compareFn">
                  <option *ngFor="let p of user" [ngValue]="p">{{ p.lastName }} {{ p.firstName }}</option>
                </select>
              </div>

            </div>
          </div>

        </section>

        <section class="workspace__blocks">

          <div class="workspace__block__right">
            <div class="workspace__block__title">
              Старший оператор:
            </div>
            <div class="workspace__block__body">
              {{ event.responsibleOperator.lastName }} {{ event.responsibleOperator.firstName }}
            </div>
          </div>

          <div class="workspace__block__right">
            <div class="workspace__block__title">
              Статус:
            </div>
            <div class="workspace__block__body">
              <div class="dropdown dropdown-dark">
                <select name="contactMethod" class="dropdown-select" [(ngModel)]="event.status"
                  [compareWith]="compareFn">
                  <option *ngFor="let p of status" [ngValue]="p">{{ statuses[p.name] }}</option>
                </select>
              </div>
            </div>
          </div>

          <div class="workspace__block__right">
            <div class="workspace__block__title">
              Приоритет:
            </div>
            <div class="workspace__block__body">
              <div class="dropdown dropdown-dark">
                <select name="contactMethod" class="dropdown-select" [(ngModel)]="event.priority"
                  [compareWith]="compareFn">
                  <option *ngFor="let p of priority" [ngValue]="p">{{ priorities[p.name] }}</option>
                </select>
              </div>
            </div>
          </div>

          <div class="workspace__block__right">
            <div class="workspace__block__title">
              Система источник:
            </div>
            <div class="workspace__block__body">
              <div class="dropdown dropdown-dark">
                <select name="contactMethod" class="dropdown-select" [(ngModel)]="event.equipmentCategory"
                  [compareWith]="compareFn" (change)="changeCategory()">
                  <option *ngFor="let p of equipmentCategory" [ngValue]="p">{{ p.name }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div class="workspace__block__right">
            <div class="workspace__block__title">
              Ответственный:
            </div>
            <div class="workspace__block__body">
              {{ user[idUser].lastName }} {{ user[idUser].firstName }}
            </div>
          </div>

          <div class="workspace__block-border">
            <div class="block-border__title">
              Краткое описание причины
            </div>
            <div class="block-border__body">
              <textarea required class="gridster-item-content" placeholder="Введите значение..." minlength="3"
                [(ngModel)]="event.description">
              </textarea>
              <div class="block-border__footer">
              </div>
            </div>
          </div>

        </section>
      </div>

      <div class="workspace__block-border">
        <div class="block-border__title">
          Установленные факты:
        </div>
        <div class="block-border__body">
          <textarea class="gridster-item-content" placeholder="Введите значение..." minlength="6"
            [(ngModel)]="event.eventType">
          </textarea>
          <div class="block-border__footer">
          </div>
        </div>
      </div>


      <div class="incidents">
        <div class="workspace__block-border incidents__item">
          <div class="block-border__title">
            Тип происшествия:
          </div>
          <div class="block-border__body">
            <textarea class="gridster-item-content" placeholder="Введите значение..." minlength="6"
              [(ngModel)]="event.establishedFacts">
            </textarea>
            <div class="block-border__footer">
            </div>
          </div>
        </div>

        <div class="workspace__block-border incidents__item" style="margin-left: 10px;">
          <div class="block-border__title">
            Непосредственные / прямые причины:
          </div>
          <div class="block-border__body">
            <textarea class="gridster-item-content" placeholder="Введите значение..." minlength="6"
              [(ngModel)]="event.directReasons">
            </textarea>
            <div class="block-border__footer">
            </div>
          </div>
        </div>

      </div>

      <div class="blocks-bottom">

        <div class="block-bottom">

          <div class="change-shift__comment" style="height: 120px; min-height: 120px;">
            <div class="comment__title">
              Корректирующие мероприятия
            </div>
            <div class="comment__body">
              <div class="comment__display">

                <ul class="messages scroll-bar events" #scroll2>
                  <li class="message event" *ngFor="let retrieval of event.retrievalEvents; let i = index">
                    <div class="event__header">
                      <span> {{ getIndex(i) }}. <span class="event__sub">Ответственный</span>
                        <span style="padding-left:10px;">
                          {{ retrieval.responsibleOperator.lastName}}
                          {{ retrieval.responsibleOperator.firstName }}</span>
                      </span>

                      <span *ngIf="retrieval.status" class="event__sub-right">{{ statuses[retrieval.status.name] }}
                        <svg-icon class="event__delete" [applyCss]="true" src="./assets/edit.svg"
                          (click)="editRetrieval(retrieval)" (mousedown)="$event.stopPropagation()"
                          (touchstart)="$event.stopPropagation()"></svg-icon>
                        <svg-icon class="event__delete" [applyCss]="true" src="./assets/garbage_bad_pic.svg"
                          (click)="deleteRetrieval(event.id, retrieval.id)" (mousedown)="$event.stopPropagation()"
                          (touchstart)="$event.stopPropagation()"></svg-icon>
                      </span>
                    </div>
                    <div class="event__body">
                      <span>{{ retrieval.description }}</span>
                    </div>
                    <div class="event__footer">
                      <span class="event__sub">Срок исполнения</span> <span class="event__date">
                        <span>{{ retrieval.eventDateTime | date:'dd-MM-yyyy HH:mm' }}</span>

                      </span>
                    </div>
                  </li>
                </ul>

              </div>
              <div class="comment__new">
                <div class="workspace__submit">
                  <div class="submit__frame submit__frame-left"></div>
                  <div class="submit__frame submit__frame-right"></div>
                  <button type="submit gridster-item-content" (click)="addRetrieval(event.id)">
                    Добавить мероприятие
                  </button>
                </div>
                <!-- <div *ngIf="isNewRetrieval" class="workspace__submit">
                  <div class="submit__frame submit__frame-left"></div>
                  <div class="submit__frame submit__frame-right"></div>
                  <button type="submit gridster-item-content" (click)="saveRetrieval(event.id)">
                    Сохранить
                  </button>
                </div>
                <div *ngIf="isNewRetrieval" class="workspace__submit">
                  <div class="submit__frame submit__frame-left"></div>
                  <div class="submit__frame submit__frame-right"></div>
                  <button type="submit gridster-item-content" (click)="cancelRetrieval()">
                    Отменить
                  </button>
                </div> -->
              </div>
            </div>
          </div>

        </div>


        <div class="block-bottom" style="margin-left: 10px">

          <div class="workspace__block-border media">
            <div class="block-border__title">
              Медиа контент
            </div>
            <div class="media__items">
              <div class="media__item" (click)="openLineChart()">
                <svg-icon class="button__icon" src="./assets/line-chart.svg">
                </svg-icon>
              </div>
              <div class="media__item">
                <svg-icon class="button__icon" src="./assets/round-add-button.svg">
                </svg-icon>
              </div>
            </div>
          </div>


          <div class="change-shift__comment" style="height: 120px; min-height: 120px;">
            <div class="comment__title">
              Комментарий оператора
            </div>
            <div class="comment__body">
              <div class="comment__display">
                <div class="messages scroll-bar" #scroll>
                  <div class="message" *ngFor="let comment of comments">
                    {{ comment }}
                  </div>
                </div>
              </div>
              <div class="comment__new">
                <input type="text" class="comment__text gridster-item-content"
                  placeholder="Напишите свой комментарий..." (keypress)="onEnterPush($event)" #input />
                <button type="submit" class="button comment__file   gridster-item-content">
                  <svg-icon class="button__icon" src="./assets/icons/widgets/change-shift/add_file.svg"></svg-icon>
                </button>
                <button type="submit" class="button comment__submit  gridster-item-content"
                  (click)="onSendMessage($event)">
                  <svg-icon class="button__icon" src="./assets/icons/widgets/change-shift/send.svg"></svg-icon>
                </button>
              </div>
            </div>
          </div>

        </div>

      </div>

      <div class="workspace__save">
        <div class="workspace__submit">
          <div class="submit__frame submit__frame-left"></div>
          <div class="submit__frame submit__frame-right"></div>
          <button type="submit gridster-item-content" (click)="createEvent()" [disabled]="isLoading">
            Создать событие
          </button>
        </div>
        <div class="workspace__submit">
          <div class="submit__frame submit__frame-left"></div>
          <div class="submit__frame submit__frame-right"></div>
          <button class="btn-disabled" type="submit gridster-item-content" (click)="saveItem()" [disabled]="isLoading">
            Сохранить
          </button>
        </div>

      </div>

    </div>


    <div (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" id="overlay-retrieval"
      (click)="overlayClose()">
      <div class="overlay-retrieval__body" (click)="$event.stopPropagation()">

        <div *ngIf="isNewRetrieval" class="overlay-retrieval__header__block">

          <section class="overlay-retrieval__blocks">

            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Дата / время:
              </div>
              <div class="overlay-retrieval__block__body">
                {{ isNewRetrieval.eventDateTime | date:'dd-MM-yyyy HH:mm' }}
              </div>
            </div>

            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Организация:
              </div>
              <div class="overlay-retrieval__block__body">
                {{ isNewRetrieval.organization }}
              </div>
            </div>

            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Смена:
              </div>
              <div class="overlay-retrieval__block__body">
                Бригада-3
              </div>
            </div>

            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Подразделение:
              </div>
              <div class="overlay-retrieval__block__body">
                {{ isNewRetrieval.branch }}
              </div>
            </div>

            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Место:
              </div>
              <div class="overlay-retrieval__block__body">
                <!-- {{ event.place.name }} -->
                ГФУ-2 с БОР
              </div>
            </div>

            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Зафиксировал:
              </div>
              <div class="overlay-retrieval__block__body">
                <div class="dropdown dropdown-dark">
                  <select name="contactMethod" class="dropdown-select" [(ngModel)]="isNewRetrieval.fixedBy"
                    [compareWith]="compareFn">
                    <option *ngFor="let p of user" [ngValue]="p">{{ p.lastName }} {{ p.firstName }}</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Старший оператор:
              </div>
              <div class="overlay-retrieval__block__body">
                {{ isNewRetrieval.responsibleOperator.lastName }} {{ isNewRetrieval.responsibleOperator.firstName }}
              </div>
            </div>

            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Статус:
              </div>
              <div class="overlay-retrieval__block__body">
                <div class="dropdown dropdown-dark">
                  <select name="contactMethod" class="dropdown-select" [(ngModel)]="isNewRetrieval.status"
                    [compareWith]="compareFn">
                    <option *ngFor="let p of status" [ngValue]="p">{{ statuses[p.name] }}</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Приоритет:
              </div>
              <div class="overlay-retrieval__block__body">
                <div class="dropdown dropdown-dark">
                  <select name="contactMethod" class="dropdown-select" [(ngModel)]="isNewRetrieval.priority"
                    [compareWith]="compareFn">
                    <option *ngFor="let p of priority" [ngValue]="p">{{ priorities[p.name] }}</option>
                  </select>
                </div>
              </div>
            </div>


            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Срок исполнения
              </div>
              <div class="overlay-retrieval__block__body">
                <input type="datetime-local" class="dates-selector__date-input"
                  [ngModel]=" isNewRetrieval.eventDateTime | date:'yyyy-MM-ddTHH:mm'">
              </div>
            </div>

            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Ответственный:
              </div>
              <div class="overlay-retrieval__block__body">
                {{ user[idUser].lastName }} {{ user[idUser].firstName }}
              </div>
            </div>


            <div class="overlay-retrieval__block">
              <div class="overlay-retrieval__block__title">
                Система источник:
              </div>
              <div class="overlay-retrieval__block__body">
                <div class="dropdown dropdown-dark">
                  <select name="contactMethod" class="dropdown-select" [(ngModel)]="isNewRetrieval.equipmentCategory"
                    [compareWith]="compareFn" (change)="changeCategory()">
                    <option *ngFor="let p of equipmentCategory" [ngValue]="p">{{ p.name }}
                    </option>
                  </select>
                </div>
              </div>
            </div>

            <div class="overlay-retrieval__block overlay-retrieval__block-border">
              <div class="block-border__title">
                Краткое описание причины
              </div>
              <div class="block-border__body">
                <textarea class="gridster-item-content" placeholder="Введите значение..." minlength="3"
                  [(ngModel)]="isNewRetrieval.description">
                  </textarea>
                <div class="block-border__footer">
                </div>
              </div>
            </div>

            <div class="overlay-retrieval__block-border overlay-retrieval__block-border">
              <div class="block-border__title">
                Тип происшествия:
              </div>
              <div class="block-border__body">
                <textarea class="gridster-item-content" placeholder="Введите значение..." minlength="6"
                  [(ngModel)]="isNewRetrieval.establishedFacts">
                  </textarea>
                <div class="block-border__footer">
                </div>
              </div>
            </div>

            <div class="overlay-retrieval__block-border overlay-retrieval__block-border">
              <div class="block-border__title">
                Непосредственные / прямые причины:
              </div>
              <div class="block-border__body">
                <textarea class="gridster-item-content" placeholder="Введите значение..." minlength="6"
                  [(ngModel)]="isNewRetrieval.directReasons">
                  </textarea>
                <div class="block-border__footer">
                </div>
              </div>
            </div>

          </section>

        </div>

        <div class="overlay-retrieval__footer">
          <div class="workspace__submit">
            <div class="submit__frame submit__frame-left"></div>
            <div class="submit__frame submit__frame-right"></div>
            <button *ngIf="!isEdit" type="submit gridster-item-content" (click)="saveRetrieval(event.id)">
              Сохранить
            </button>
            <button *ngIf="isEdit" type="submit gridster-item-content" (click)="editSaveRetrieval()">
              Сохранить
            </button>
          </div>


          <div class="workspace__submit">
            <div class="submit__frame submit__frame-left"></div>
            <div class="submit__frame submit__frame-right"></div>
            <button type="submit gridster-item-content" (click)="overlayClose()">
              Отменить
            </button>
          </div>
        </div>

      </div>
    </div>


    <div (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" id="overlay-chart"
      (click)="overlayChartClose()">
      <div class="overlay-chart__body" (click)="$event.stopPropagation()">
        <evj-line-chart-workspace></evj-line-chart-workspace>
      </div>
    </div>

  </ng-container>

  <ng-container *ngIf="!isMock && !event">
    <div class="workspace__mock" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()">
      <div class="workspace__submit">
        <div class="submit__frame submit__frame-left"></div>
        <div class="submit__frame submit__frame-right"></div>
        <button type="submit gridster-item-content" (click)="createEvent()">
          Создать событие
        </button>
      </div>
    </div>
  </ng-container>

  <evj-frame-bottom></evj-frame-bottom>

</div>