<section
  class="workspace"
  (mousedown)="$event.stopPropagation()"
  (touchstart)="$event.stopPropagation()"
>
  <div class="workspace__header">
    <evj-ui-block class="workspace__header__block" status="normal">
      <mat-form-field class="status">
        <mat-label>Статус</mat-label>
        <mat-select
          panelClass="mat-select-custom"
          [(ngModel)]="ewService.event.status"
          [compareWith]="compareFn"
        >
          <mat-option *ngFor="let p of ewService.status" [value]="p"
            >{{ ewService.statuses[p.name] }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </evj-ui-block>
    <evj-ui-block class="workspace__header__block" status="{{ewService.event.priority.name}}">
      <mat-form-field class="{{ewService.event.priority.name}}">
        <mat-label>Приоритет</mat-label>
        <mat-select
          panelClass="mat-select-custom"
          [(ngModel)]="ewService.event.priority"
          [compareWith]="compareFn"
        >
          <mat-option *ngFor="let p of ewService.priority" [value]="p"
            >{{ ewService.priorities[p.name] }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </evj-ui-block>
    <evj-ui-block class="workspace__header__block" status="{{ewService.event.isAcknowledged}}">
      <mat-form-field class="card-{{ewService.event.isAcknowledged}}">
        <mat-label>Событие</mat-label>
        <mat-select
          panelClass="mat-select-custom"
          [(ngModel)]="ewService.event.isAcknowledged"
          [compareWith]="compareFn"
        >
          <mat-option [value]="true">
            Квитировано
          </mat-option>
          <mat-option [value]="false">
            Не квитировано
          </mat-option>
        </mat-select>
      </mat-form-field>
    </evj-ui-block>
  </div>

  <div class="workspace__body">
    <div class="workspace__body__left">
      <div class="select__block">
        <div class="first_block">
          <div class="categories">
            <evj-ui-block class="workspace__body__categories" status="normal">
              <mat-form-field class="categories_selectbox">
                <mat-label>Категория</mat-label>
                <mat-select
                  panelClass="mat-select-custom"
                  [(ngModel)]="ewService.event.category"
                  [compareWith]="compareFn"
                >
                  <mat-option *ngFor="let cat of ewService.category" [value]="cat">
                    {{ ewService.categories[cat.name] }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </evj-ui-block>
          </div>
          <div class="type">
            <evj-ui-block class="workspace__body__categories" status="normal">
              <mat-form-field class="categories_selectbox">
                <mat-label>Тип оборудования</mat-label>
                <mat-select
                  panelClass="mat-select-custom"
                  [(ngModel)]="ewService.event.equipmentCategory"
                  [compareWith]="compareFn"
                >
                  <mat-option *ngFor="let p of ewService.equipmentCategory" [value]="p"
                    >{{ p.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </evj-ui-block>
          </div>
        </div>
        <div class="second_block" *ngIf="ewService.event.category.name === 'equipmentStatus'">
          <div class="type_incident">
            <evj-ui-block class="workspace__header__block" status="normal">
              <mat-form-field>
                <mat-label>Тип происшествия</mat-label>
                <mat-select
                  panelClass="mat-select-custom"
                  [(ngModel)]="ewService.event.eventType"
                  [compareWith]="compareFn"
                >
                  <mat-option *ngFor="let p of ewService.eventTypes" [value]="p"
                    >{{ p.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </evj-ui-block>
          </div>
          <div class="number_position">
            <evj-ui-block class="workspace__header__block" status="normal">
              <div class="input_position">
                <mat-form-field class="example-full-width">
                  <mat-label>Номер позиции</mat-label>
                  <input
                    matInput
                    placeholder="Текст..."
                    [value]="ewService.event.positionNumber"
                    [(ngModel)]="ewService.event.positionNumber"
                  />
                </mat-form-field>
              </div>
              <div class="position_icon">
                <svg-icon
                  src="./assets/icons/edit.svg"
                  [svgStyle]="{ 'width.px':25, 'height.px':20 }"
                ></svg-icon>
              </div>
            </evj-ui-block>
          </div>
        </div>
      </div>

      <evj-event-description
        class="description"
        [ngClass]="{'description_small':ewService.event.category.name === 'equipmentStatus'}"
        [description]="ewService.event.description"
        [isRetrievalEvent]="false"
        (changedDescription)="onChangeEventDescription($event)"
      ></evj-event-description>

      <div class="facts">
        <evj-chat
          [messages]="ewService.event.facts"
          title="Установленные факты"
          placeholder="Укажите факты..."
          [displayGraphImage]="!!ewService.event.graphValues"
          [onClickItem]="openLineChart"
          (addingMessage)="onSendMessage($event,'facts')"
        ></evj-chat>
      </div>

      <div class="comments">
        <evj-chat
          [messages]="ewService.event.comments"
          title="Комментарии"
          placeholder="Напишите свой комментарий..."
          (addingMessage)="onSendMessage($event,'comments')"
        ></evj-chat>
      </div>
    </div>

    <div class="workspace__body__right">
      <div class="info_block">
        <div class="creator">
          <div class="creator_title">
            Автор
          </div>
          <div class="creator_body">
            {{ ewService.event.responsibleOperator?.lastName }} {{
            ewService.event.responsibleOperator?.firstName }}
          </div>
        </div>
        <div class="deadline">
          <div class="date-info">
            <div class="deadline-title">Срок выполнения</div>
            <evj-time-data-picker
              [data]="ewService.event.deadline"
              (dateTimePicker)="dateTimePicker($event)"
            ></evj-time-data-picker>
          </div>
          <div class="deadline_bottom_angles"></div>
        </div>
      </div>
      <div class="place">
        <evj-ui-block class="workspace__body__categories" status="normal">
          <mat-form-field class="categories_selectbox">
            <mat-label>Место</mat-label>
            <mat-select
              panelClass="mat-select-custom"
              [(ngModel)]="ewService.event.unit"
              [compareWith]="compareFn"
            >
              <mat-option *ngFor="let cat of ewService.units" [value]="cat">
                {{ cat.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </evj-ui-block>
      </div>
      <div class="responsible">
        <evj-events-responsible-select></evj-events-responsible-select>
      </div>
      <div class="events-correct">
        <div class="events-correct-block">
          <div class="event_info">
            <div class="event_info_title">Корректирующие мероприятия</div>
            <div class="event_info_date">
              <div class="event_info_date_title">Начало события</div>
              <div class="event_info_date_body">
                {{ewService.event.eventDateTime | date:'dd-MM-yyyy HH:mm' }}
              </div>
            </div>
          </div>
          <div class="events">
            <ng-container *ngFor="let retrieval of ewService.event.retrievalEvents">
              <div
                class="events_content"
                [class.events_closed]="retrieval.innerNotification.status.name === 'closed'"
              >
                <div class="events_container" (click)="onLoadEvent(retrieval.innerNotification.id)">
                  <div class="events_info">
                    <div class="events_info_title">
                      <div>Краткое описание</div>
                      <div style="margin-left: 10px">
                        <svg-icon
                          *ngIf="retrieval.timerPercentage > 99"
                          src="./assets/icons/widgets/workspace/attantion.svg"
                          [svgStyle]="{ 'width.px':18, 'height.px':18, 'margin-top.px': 2 }"
                        ></svg-icon>
                      </div>
                    </div>
                    <div class="events_info_body">
                      {{ retrieval.innerNotification.description }}
                    </div>
                  </div>
                  <div class="events_status">
                    <div
                      class="events_status-{{retrieval.innerNotification.priority.name}}"
                      *ngIf="retrieval.innerNotification.status"
                    >
                      {{ ewService.statuses[retrieval.innerNotification.status.name] }}
                    </div>
                    <div class="events_status_datetime">
                      <div class="datetime_title">Срок исполнения</div>
                      <div class="datetime_body">
                        {{ retrieval.innerNotification.deadline | date:'dd-MM-yyyy HH:mm' }}
                      </div>
                    </div>
                    <div class="events_status_responsible">
                      <div class="responsible_title">Ответственный</div>
                      <div class="responsible_body" *ngIf="retrieval.innerNotification.fixedBy">
                        {{ retrieval.innerNotification.fixedBy.lastName }} {{
                        retrieval.innerNotification.fixedBy.firstName }} {{
                        retrieval.innerNotification.fixedBy.middleName }}
                      </div>
                    </div>
                  </div>
                </div>
                <div class="events_menu">
                  <div class="events_check" *ngIf="retrieval.innerNotification.isAcknowledged">
                    <svg-icon
                      src="./assets/icons/widgets/workspace/accept.svg"
                      [svgStyle]="{ 'width.px':15, 'height.px':15 }"
                    >
                    </svg-icon>
                  </div>
                  <div class="events_button">
                    <div clas="events_button_delete" (click)="overlayConfirmationOpen()">
                      <svg-icon
                        class="delete_button_icon"
                        src="./assets/icons/widgets/workspace/delete.svg"
                        [svgStyle]="{ 'width.px':16, 'height.px':16 }"
                      >
                      </svg-icon>
                    </div>
                    <div
                      clas="events_button_update"
                      (click)="onEditRetrieval(retrieval.innerNotification)"
                    >
                      <svg-icon
                        class="edit_button_icon"
                        src="./assets/icons/widgets/workspace/edit.svg"
                        [svgStyle]="{ 'width.px':20, 'height.px':20 }"
                      >
                      </svg-icon>
                    </div>
                  </div>
                </div>
                <div
                  ngClass="progress-line-{{retrieval.innerNotification.priority.name}}"
                  [style.width.%]="retrieval.timerPercentage"
                ></div>
              </div>

              <!--DELETE EVENT-->
              <div
                (mousedown)="$event.stopPropagation()"
                (touchstart)="$event.stopPropagation()"
                id="overlay-confirmation"
                *ngIf="ewService.isOverlayConfirmOpen"
              >
                <div class="overlay-confirmation__body" (click)="$event.stopPropagation()">
                  <span>Вы действительно хотите удалить выбранное Мероприятие?</span>
                  <div style="display: flex;">
                    <div class="workspace__submit">
                      <div class="submit__frame submit__frame-left"></div>
                      <div class="submit__frame submit__frame-right"></div>
                      <button
                        type="submit gridster-item-content"
                        (click)="ewService.deleteRetrievalEvent(retrieval)"
                      >
                        Удалить
                      </button>
                    </div>
                    <div class="workspace__submit">
                      <div class="submit__frame submit__frame-left"></div>
                      <div class="submit__frame submit__frame-right"></div>
                      <button
                        type="submit gridster-item-content"
                        (click)="overlayConfirmationClose()"
                      >
                        Отменить
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <!--DELETE EVENT-->
            </ng-container>
          </div>
          <div class="events_bottom_info">
            <div class="add_events">
              <svg-icon
                src="./assets/icons/add_button.svg"
                class="add_button_icon"
                [svgStyle]="{ 'width.px':20, 'height.px':20 }"
                (click)="addRetrieval()"
              ></svg-icon>
            </div>
            <div class="end_events">
              <div class="end_events_title">Завершение события</div>
              <div class="end_events_body" *ngIf="ewService.event.eventEndDateTime">
                {{ewService.event.eventEndDateTime | date:'dd-MM-yyyy HH:mm'}}
              </div>
            </div>
          </div>
        </div>
        <div class="events-correct-progress">
          <div class="line_progress">
            <div class="top_frame_line"></div>
            <div class="middle_line" #progress>
              <div class="progress" [style.height.px]="progressLineHeight"></div>
            </div>
            <div class="bottom_frame_line"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<div
  (mousedown)="$event.stopPropagation()"
  (touchstart)="$event.stopPropagation()"
  id="overlay-chart"
  *ngIf="ewService.isOverlayChartOpen"
  (click)="overlayChartClose()"
>
  <div
    class="overlay-chart__body"
    (click)="$event.stopPropagation()"
    *ngIf="ewService.event.graphValues"
  >
    <evj-line-chart-workspace
      [dataChartAttribute]="ewService.event.graphValues"
    ></evj-line-chart-workspace>
  </div>
</div>
