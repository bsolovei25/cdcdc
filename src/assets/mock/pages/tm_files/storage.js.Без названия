/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require,exports,module){"use strict";var a=require("jquery"),b=require("application/application-context"),c=require("system/data/storage-context"),d=require("system/diagnostics/log-manager"),e=d.getLogger(module.id);function f(){this.db=null,this._dbName="",this.transaction=null,this._request=null,this.session=null,this.storageContext=null}f.factory=function a(d){var e=new f;return e.session=(d||b).session,e.storageContext=c.factory(),e},f.fromUser=function(c){var d=a.extend({},b.session,{userId:c});return f.factory({session:d})},f.prototype.open=function b(){var c=new a.Deferred;return this._request=window.indexedDB.open(this.dbName(),this.storageContext.version),this._request.onsuccess=h.bind(null,this,c),this._request.onerror=i.bind(null,this),this._request.onupgradeneeded=this.storageContext.upgradeNeeded.bind(this.storageContext),this._request.onblocked=g.bind(null,c),c.promise()};function g(a){a.reject()}function h(a,b){try{a.db=a._request.result}catch(a){
if(!(a instanceof InvalidStateError))throw a}finally{b.resolve()}}function i(a,b){e.error(b),a.close()}f.prototype.dbName=function a(){return""===this._dbName&&(this._dbName=this.session.apiServer+this.session.datasourceId+this.session.userId+"_meridium_idb"),this._dbName},f.prototype.close=function a(){null!==this.db&&void 0!==this.db.close&&(this.db.close(),this.db=null,this.transaction=null)},f.prototype.startTransaction=function a(b,c){this.transaction=this.db.transaction(b,c||"readonly")},f.prototype.objectStore=function a(b){return this.transaction.objectStore(b)},f.prototype.get=function b(c,d,e){var f=a.Deferred();this.startTransaction(c);var g=this.objectStore(c);""!==(e||"")&&(g=g.index(e));var h;return h=null===d||void 0===d?g.get():g.get(d),n(h,f),f.promise()};function j(a,b){e.error(b.message),a.reject(b.message)}function k(a,b){b?a.resolve(b.target.result):a.resolve()}f.prototype.cursor=function a(b,c,d){this.startTransaction(b);var e=this.objectStore(b)
;return""!==(d||"")&&(e=e.index(d)),null===c||void 0===c?e.openCursor():e.openCursor(c)},f.prototype.getAll=function b(c,d,e){var f=a.Deferred(),g=this.cursor(c,d,e),h=[];return g.onsuccess=l.bind(null,f,h),g.onerror=j.bind(null,f),f.promise()};function l(a,b,c){var d=c.target.result;d?(b.push({key:d.primaryKey,value:d.value}),d.continue()):a.resolve(b)}f.prototype.keyCursor=function a(b,c,d){this.startTransaction(b);var e=this.objectStore(b);return e=e.index(d),null===c||void 0===c?e.openKeyCursor():e.openKeyCursor(c)},f.prototype.getAllKeys=function b(c,d,e){var f=a.Deferred(),g=this.keyCursor(c,d,e),h=[];return g.onsuccess=m.bind(null,f,h),g.onerror=j.bind(null,f),f.promise()};function m(a,b,c){var d=c.target.result;d?(b.push(d.primaryKey),d.continue()):a.resolve(b)}f.prototype.put=function b(c,d,e){var f=a.Deferred();this.startTransaction(c,"readwrite");var g=this.objectStore(c),h;return h=null===e||void 0===e?g.put(d):g.put(d,e),n(h,f),f.promise()},
f.prototype.insert=function b(c,d){var e=a.Deferred();return this.startTransaction(c,"readwrite"),n(this.objectStore(c).add(d),e),e.promise()},f.prototype.delete=function b(c,d){var e=a.Deferred();this.startTransaction(c,"readwrite");var f=this.objectStore(c),g=f.delete(d);return g.onsuccess=k.bind(null,e),g.onerror=j.bind(null,e),e.promise()},f.prototype.deleteAll=function b(c,d){var e=a.Deferred(),f=this,g=[];return d.forEach(function(a){g.push(f.delete(c,a))}),a.when.apply(a,g).done(k.bind(null,e)).fail(j.bind(null,e)),e.promise()},f.prototype.deleteRange=function b(c,d,e){var f=a.Deferred(),g=this;return this.getAllKeys(c,d,e).done(function(a){g.deleteAll(c,a).done(function(){f.resolve(a)}).fail(f.reject.bind(f))}).fail(f.reject.bind(f)),f.promise()},f.prototype.clear=function b(c){var d=a.Deferred();return this.startTransaction(c,"readwrite"),n(this.objectStore(c).clear(),d),d.promise()};function n(a,b){a.onsuccess=k.bind(null,b),a.onerror=j.bind(null,b)}return f});