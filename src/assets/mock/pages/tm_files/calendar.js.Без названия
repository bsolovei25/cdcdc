/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("lodash"),c=require("moment"),d=require("full-calendar"),e=require("react"),f=require("react-dom"),g=require("application/application-events"),h=require("query/execution/query-execution-engine"),i=require("./services/calendar-service"),j=require("./dtos/calendar-event-dto"),k=require("query/services/dto/parameter-container-dto"),l=require("query/services/dto/query-container-dto"),m=require("ui/elements/page-filter/page-filter-connection"),n=require("./utils"),o=require("system/globalization/translator"),p=require("globalize"),q=require("system/ui/busy-indicator"),r=e.DOM.div,s=e.DOM.button,t=e.DOM.span;function u(a){v.call(this,a),this.appEvents=Object.resolve(g),this.calendarService=Object.resolve(i),this.utils=Object.resolve(n),this.translator=Object.resolve(o),this.pageFilterConnection=Object.resolve(m),this.aggregateQueryParams=null,this.queryExecutionEngine=null,this.catalogItemKey=null,
this.catalogItemPath=null,a.catalogItemKey?this.catalogItemKey=a.catalogItemKey:a.catalogItemPath&&(this.catalogItemPath=a.catalogItemPath),this.eventDtos=[],a.map&&(this.fieldNamingMap=a.map,window.sessionStorage.setItem("calendar-field-map",JSON.stringify(a.map))),this.isFcInitilized=!1,this.start="",this.end="",this.categories=[],this.selectedCategories=[],this.isCategoryUpdate=!1,this.queryContainer=null,this.showRefreshButton=a.showRefreshButton,this.showExpandButton=a.showExpandButton,this.indicator=Object.resolve(q)}var v=Object.inherit(e.Component,u);u.prototype.render=function(){return w([y(this),x(this),z(this)])},u.prototype.componentDidMount=function(){var a=this;a.element=f.findDOMNode(a),a.pageFilterConnection.open(O.bind(null,a),a.element)},u.prototype.componentWillUnmount=function(){this.pageFilterConnection.close(),this.pageFilterConnection=null};function w(a){return r({className:"calendar-widget-container",key:"widget-container",style:{height:"100%"}},a)}
function x(a){return r({className:"full-calendar-widget",key:"content",style:{height:"calc(100% - 30px)"}})}function y(a){return a.showRefreshButton&&a.showExpandButton?r({className:"calendar-widget-header",key:"widget-header"},t({},"LOG CALENDAR"),s({className:"btn btn-icon icon-refresh",key:"refresh-btn",onClick:B.bind(null,a)}),s({className:"btn btn-icon icon-open-in-new-window",key:"expand-btn",onClick:C.bind(null,a)})):r({className:"calendar-widget-header",key:"widget-header"})}function z(){return r({className:"calendar-widget-legend",key:"legend"})}function A(a,b){b.navigationUrl&&a.appEvents.navigate.raise(b.navigationUrl,{tab:!0})}function B(b){a(b.element).find(".full-calendar-widget").fullCalendar("refetchEvents")}function C(a){var b="#calendar-expanded-view?catalogItemKey="+a.catalogItemKey;a.appEvents.navigate.raise(b,{tab:!0})}function D(b){var c=a.Deferred()
;return null!==b.catalogItemKey?c.resolve():null===b.catalogItemKey&&null!==b.catalogItemPath&&b.calendarService.getCatalogItem(b.catalogItemPath).done(function(d){b.catalogItemKey=d.key,b.queryContainer=new l(a.parseJSON(JSON.stringify(d.query.layout.queryContainer))),c.resolve(d.key)}).fail(function(){c.reject()}),c}function E(a,d,e,f,g){var i=c(d).format("YYYY-MM-DD HH:mm:ss");if(a.catalogItemKey&&!a.isCategoryUpdate){var k=Q(a.queryContainer.columnDesigns,a.fieldNamingMap.start);k&&(a.fieldNamingMap.end?a.queryContainer.columnDesigns[k].resultFilterExpression=">= (# :dt '"+i+"') OR ("+a.fieldNamingMap.start+" < (# :dt '"+i+"') AND "+a.fieldNamingMap.end+" > (# :dt '"+i+"')) ":a.queryContainer.columnDesigns[k].resultFilterExpression=">= (# :dt '"+i+"')"),a.start=d,a.end=e;var l={suppressPrompts:!0};a.aggregateQueryParams&&(l.parameters=a.aggregateQueryParams,l.suppressPrompts=!0),a.queryExecutionEngine=new h({queryContainer:a.queryContainer}),
a.queryExecutionEngine.execute(l).done(function(c){a.eventDtos=j.toEventDtos(c.rowset,a.fieldNamingMap);var d=b.uniq(b.map(a.eventDtos,"category"));a.categories={},b.each(d,function(c,d){var e=b.filter(a.eventDtos,{category:c})[0].color,f=a.fieldNamingMap.color?e:a.utils.getRandomColor(d);a.categories[c]=f}),b.each(a.eventDtos,function(b){b.color=a.categories[b.category]}),F(a,d),g(a.eventDtos)})}else a.isCategoryUpdate&&(a.isCategoryUpdate=!1,g(J(a)))}function F(b,c){var d=a(b.element).find(".calendar-widget-legend");G(b,d),H(b,d,c)}function G(a,b){b.empty(),a.selectedCategories=[]}function H(b,c,d){for(var e=0;e<d.length;e++)if(d[e]&&0===c.find('[id="'+d[e]+'"]').length){var f=a('<mi-checkbox-noko value="'+d[e]+'" text="'+d[e]+'" id="'+(d[e]?d[e].split(" ").join("_"):"UNKNOWN")+'"></mi-checkbox-noko>');window.CustomElements&&!window.CustomElements.useNative&&window.CustomElements.upgrade(f.get(0)),f.on("checkedChange",I.bind(null,b)),c.append(f),
f.find(".checkbox-label").css("background-color",b.categories[d[e]])}}function I(c,d,e,f){e?c.selectedCategories.push(f):b.pull(c.selectedCategories,f),c.isCategoryUpdate=!0,a(c.element).find(".full-calendar-widget").fullCalendar("refetchEvents")}function J(a){var b=[];if(a.selectedCategories.length)for(var c=0;c<a.eventDtos.length;c++)a.selectedCategories.indexOf(a.eventDtos[c].category)!==-1&&b.push(a.eventDtos[c]);else b=a.eventDtos;return b}function K(b){b.element&&(a(b.element).find(".full-calendar-widget").fullCalendar({defaultView:"agendaDay",header:{left:"title, prev, next",center:"",right:"today"},buttonText:{today:b.translator.translate("TODAY"),month:b.translator.translate("CAL_MONTH"),week:b.translator.translate("CAL_WEEK"),day:b.translator.translate("CAL_DAY"),list:b.translator.translate("LIST")},monthNames:p.culture().calendar.months.names,monthNamesShort:p.culture().calendar.months.namesAbbr,dayNames:p.culture().calendar.days.names,
dayNamesShort:p.culture().calendar.days.namesAbbr,columnFormat:"dddd",eventLimit:!0,views:{month:{eventLimit:3}},events:E.bind(null,b),eventClick:A.bind(null,b),allDaySlot:!1,defaultTimedEventDuration:"00:30:00",height:a(b.element).find(".full-calendar-widget").height(),eventRender:L,viewRender:M.bind(null,b),loading:N.bind(null,b)}),b.isFcInitilized=!0)}function L(b,c,d){a(c).addClass("cal-event"),c.attr("title",b.title),"month"!==d.name?a(c).find(".fc-time").show():a(c).find(".fc-time").hide(),null===b.end&&a(c).addClass("cal-event-no-end-date-style1")}function M(a,b,c){a.indicator.attachTo(c[0])}function N(a,b,c){b?a.indicator.show():a.indicator.hide()}function O(a,c){a.pageFilterConnection.remote.isConnected()&&(c&&c.parmDesigns&&c.parmDesigns.length?a.aggregateQueryParams=c:a.aggregateQueryParams=void 0,P(a),a.isFcInitilized?b.delay(B.bind(null,a),500):D(a).done(K.bind(null,a)))}function P(b){var c=a(b.element).parents("mi-widget").attr("id")
;window.sessionStorage.setItem(c,JSON.stringify(b.aggregateQueryParams||""))}function Q(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id===b)return c;return null}return u});