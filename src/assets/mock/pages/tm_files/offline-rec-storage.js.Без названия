/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require,exports,module){"use strict";var a=require("jquery"),b=require("ramda"),c=require("system/data/storage"),d="offline-form-struture",e="offline-risk-assessment-recommendations",f="offline-proof-test-pictures",g="offline-proof-tests",h=require("../../adapters/main-application/offline-form-data-adapter");function i(){}function j(a,b,c,d,f){var g=h.fromJson(f);delete g.records[c.clientId],b.put(e,g).done(A.bind(null,d)).always(C.bind(null,b))}function k(a,b,c,d,e,f){e.get(b,d).done(A.bind(null,c)).always(C.bind(null,e,f))}i.prototype.getAllOfflineFormDataFromStorage=function b(){var d=a.Deferred(),f=a.Deferred(),g=Object.resolve(c);return g.open().done(n.bind(null,this,e,f,g)).fail(f.reject.bind(f)),f.done(m.bind(null,this,d)).fail(B.bind(null,d)),d.promise()},i.prototype.getAllProofTestsFromStorage=function b(){var d=a.Deferred(),e=a.Deferred(),f=Object.resolve(c);return f.open().done(n.bind(null,this,g,e,f)).fail(e.reject.bind(e)),
e.done(m.bind(null,this,d)).fail(B.bind(null,d)),d.promise()},i.prototype.canSaveOfflineRecommendationToStorage=function b(d){var f=a.Deferred(),g=a.Deferred(),h=Object.resolve(c);return h.open().done(n.bind(null,this,e,g,h)).fail(g.reject.bind(g)),g.done(l.bind(null,this,f,d)).fail(B.bind(null,f)),f.promise()};function l(a,c,d,e){var f=b.pluck("value")(e),g=h.fromJsonCollection(f),i=!0;if(g.length>0)for(var j=0;j<Object.keys(g[0].records).length;j++){var k=g[0].records[Object.keys(g[0].records)[j]];if(k.clientId===d&&"SYNCING"===k.syncStatus){i=!1;break}}c.resolve(i)}i.prototype.getAllRefDocImagesDataFromStorage=function b(){var d=a.Deferred(),e=a.Deferred(),g=Object.resolve(c);return g.open().done(n.bind(null,this,f,e,g)).fail(e.reject.bind(e)),e.done(m.bind(null,this,d)).fail(B.bind(null,d)),d.promise()};function m(a,c,d){var e=b.pluck("value")(d),f=h.fromJsonCollection(e);c.resolve(f)}function n(a,b,c,d){d.getAll(b).done(A.bind(null,c)).always(function(){d&&d.close()})}
i.prototype.getOfflineFormDataFromStorage=function b(d,f){var g=a.Deferred(),h=a.Deferred(),i=Object.resolve(c);return i.open().done(k.bind(null,this,e,h,d,i)).fail(h.reject.bind(h)),h.done(t.bind(null,g,f)).fail(B.bind(null,g)),g.promise()},i.prototype.getFormLayout=function b(d){var e=this,f=Object.resolve(c),g=a.Deferred();return f.open().done(u.bind(null,e,f,g,d)).fail(g.reject.bind(g)),g},i.prototype.saveOfflineData=function b(d){var e=a.Deferred(),f=Object.resolve(c);return f.open().done(y.bind(null,this,e,d,f)).fail(e.reject.bind(e)),e.promise()},i.prototype.getAllOfflineDataFromStorage=function b(){var d=a.Deferred(),f=a.Deferred(),g=Object.resolve(c);return g.open().done(n.bind(null,this,e,f,g)).fail(f.reject.bind(f)),f.done(function(a){d.resolve(a)}).fail(B.bind(null,d)),d.promise()},i.prototype.savePicture=function b(d,e){var g=a.Deferred(),h=Object.resolve(c),i=a.Deferred();return h.open().done(k.bind(null,this,f,g,d,h)).fail(g.reject.bind(g)),
g.done(s.bind(null,this,i,d,e,h)),i.promise()},i.prototype.getPicturesFromStorage=function b(d){var e=a.Deferred(),g=Object.resolve(c);return g.open().done(k.bind(null,this,f,e,d,g)).fail(e.reject.bind(e)),e.promise()},i.prototype.savePictures=function b(d,e){var g=a.Deferred(),h=Object.resolve(c),i=a.Deferred();return h.open().done(k.bind(null,this,f,g,d,h)).fail(g.reject.bind(g)),g.always(r.bind(null,this,i,d,e,h)),i.promise()},i.prototype.deleteOfflineRecommendations=function b(d,f){var g=a.Deferred(),h=a.Deferred(),i=Object.resolve(c);return i.open().done(n.bind(null,this,e,h,i)).fail(h.reject.bind(h)),h.done(p.bind(null,this,g,d,f,i)).fail(B.bind(null,g)),g.promise()};function o(a,b,c){return!(Object.keys(a).map(function(b){return a[b]}).filter(function(a){return a.entityKey!==c&&a.additionalInfo.assetKey===b}).length>0)}function p(a,d,f,g,i,j){var k=b.pluck("value",j),l=h.fromJsonCollection(k),m=[];l.length>0&&a.getAllProofTestsFromStorage().done(function(h){var j=[]
;h&&h.length>0&&(j=Object.keys(h[0].records).map(function(a){return h[0].records[a]}));for(var k=0;k<Object.keys(l[0].records).length;k++){var n=l[0].records[Object.keys(l[0].records)[k]];n.additionalInfo.assetKey===f&&o(j,f,g)&&m.push(n)}for(var p=0;p<m.length;p++)delete l[0].records[m[p].clientId];var q=b.pluck("clientId")(m);q.length>0?a.deletePictures(q).done(function(a){a?a.put(e,l[0]).done(A.bind(null,d)).always(C.bind(null,a)):(a=Object.resolve(c),a.open().done(function(){a.put(e,l[0]).done(A.bind(null,d)).always(C.bind(null,a))}))}):(i=Object.resolve(c),i.open().done(function(){i.put(e,l[0]).done(A.bind(null,d)).always(C.bind(null,i))}))})}i.prototype.deletePictures=function b(d,e){var f=a.Deferred();return d=Array.isArray(d)?d:[d],e?q(this,e,d,f):(e=Object.resolve(c),e.open().done(q.bind(null,this,e,d,f)).fail(f.reject.bind(f))),f.promise()};function q(a,b,c,d){b.deleteAll(f,c).done(d.resolve.bind(d)).fail(d.reject.bind(d))}function r(a,b,c,d,e,g){g?g.pictures=d:g={clientId:c,
pictures:d},e.put(f,g).done(z.bind(null,b)),g=null}function s(a,b,c,d,e,g){if(g){for(var h=!1,i=0;i<g.pictures.length;i++){var j=g.pictures[i];d.pictureId===j.pictureId&&(g.pictures[i]=d,h=!0)}h===!1&&g.pictures.push(d)}else g={clientId:c,pictures:[d]};console.log("Picture ID "+d.pictureId),e.put(f,g).done(z.bind(null,b)),g=null}function t(a,b,c){for(var d=h.fromJson(c),e=0;e<Object.keys(d.records).length;e++){var f=d.records[Object.keys(d.records)[e]];f.entityKey===b&&a.resolve(d,f)}}function u(a,b,c,e){b.getAll(d).done(v.bind(null,a,c,e)).fail(c.reject.bind(c)).always(b.close.bind(b))}function v(a,b,c,d){for(var e=0;e<d.length;e++){if(d[e].value.formID===c){b.resolve(d[e].value);break}}}function w(b,c,d){var f=a.Deferred(),g=a.Deferred();return k(b,e,g,c.formKey,d,!1),g.done(x.bind(null,d,c,f)).fail(B.bind(null,f)),f.promise()}function x(a,b,c,d){var f=h.fromJson(d);if(!f)return void a.put(e,b).done(A.bind(null,c));for(var g=0;g<Object.keys(b.records).length;g++){
for(var i=b.records[Object.keys(b.records)[g]],j=i.clientId,k=!1,l=0;l<Object.keys(f.records).length;l++){if(f.records[Object.keys(f.records)[l]].clientId===j){f.records[Object.keys(f.records)[l]]=i,k=!0;break}}k===!0?a.put(e,f).done(z.bind(null,c)):(f.records[i.clientId]=i,a.put(e,f).done(z.bind(null,c)))}}function y(b,c,e,f){for(var g=[],i=[],j=0;j<e.length;j++)if(e[j]){var k=e[j].offlineForms,l=e[j].offlineFormData.length>0?e[j].offlineFormData:h.fromJson(e[j].offlineFormData);if(k)for(var m=0;m<k.length;m++)i.push(f.put(d,k[m]));if(l.length>0)for(var n=0;n<l.length;n++)i.push(w(b,l[n],f));else i.push(w(b,l,f));e.length>1?g.push([k,l]):g=[k,l]}var o=a.when.apply(b,i);o.done(A.bind(null,c,g)),o.fail(B.bind(null,c)),o.always(C.bind(null,f))}function z(a){a.resolve()}function A(a,b){a.resolve(b)}function B(a,b){a.reject(b)}function C(a,b){(b=b!==!0&&b!==!1||b)&&a.close()}return i});