/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("lodash"),b=require("jquery"),c=require("knockout"),d=require("./widget-view-model"),e=require("./query-widget-editor"),f=require("mi-assert"),g=require("ui/elements/page-filter/page-filter-connection"),h=require("application/application-events"),i=require("text!../views/query-widget.html");require("ui/elements/resultgrid/resultgrid-view-model");function j(b){k.call(this,b,i,e),this.query=c.observable(),this.path=c.observable(),this.pathSubscription=null,this.resultGrid=null,this.pageFilterConnection=Object.resolve(g),this.gridInstance=null,this.$gridLayoutItem=null,this.debouncedWidgetResizeFunction=a.debounce(o.bind(null,this),250),this.applicationEvents=Object.resolve(h),this.queryParams=null}var k=Object.inherit(d,j);j.prototype.afterAttach=function a(c){try{Element.upgrade("mi-resultgrid",c),this.pathSubscription=this.path.subscribe(t.bind(null,this)),this.resultGrid=c.element.querySelector("mi-resultgrid"),
this.resultGrid.gridLoadedCB=p.bind(null,this),this.$gridLayoutItem=b("mi-grid-layout-item"),this.$gridLayoutItem.on("element-resized",this.debouncedWidgetResizeFunction),this.pageFilterConnection.open(q.bind(null,this),c.element),this.queryParams&&n(this)}catch(a){k.prototype.onError.call(this,a)}},j.prototype.beforeDetach=function a(){try{l(this),this.pathSubscription.dispose(),this.pathSubscription=null,this.pageFilterConnection.close(),this.resultGrid=null,this.gridInstance=null,this.$gridLayoutItem.off("element-resized"),this.$gridLayoutItem=null}catch(a){k.prototype.onError.call(this,a)}finally{this.pathSubscription=null,this.resultGrid=null,this.gridInstance=null,this.$gridLayoutItem=null}};function l(a){m(a)&&(a.queryParams=a.resultGrid.rawQueryData.queryContainer.parmContainer)}function m(a){return a.resultGrid&&a.resultGrid.rawQueryData&&a.resultGrid.rawQueryData.queryContainer&&a.resultGrid.rawQueryData.queryContainer.parmContainer}function n(a){
a.resultGrid&&(a.resultGrid.queryParams=a.queryParams,a.resultGrid.setAttribute("suppressprompts","true")),a.refresh()}j.prototype.deserialize=function a(){try{var b=this.widget.properties();f.ok(b,"properties"),b.path&&this.path(b.path),b.query&&b.query.path&&this.path(b.query.path)}catch(a){k.prototype.onError.call(this,a)}},j.prototype.serialize=function a(){try{return l(this),n(this),{path:this.path()}}catch(a){k.prototype.onError.call(this,a)}},j.prototype.refresh=function a(){try{s(this)&&this.resultGrid&&this.resultGrid.refresh(this.encodePath(this.path()))}catch(a){k.prototype.onError.call(this,a)}},j.prototype.redraw=function(){o(this)},j.prototype.goto=function a(){try{this.applicationEvents.navigate.raise("catalog-item/"+this.encodePath(this.path()),{tab:!0})}catch(a){k.prototype.onError.call(this,a)}};function o(a){a.gridInstance&&a.gridInstance.repaint()}function p(a,b){a.gridInstance=b}function q(a,b){b&&b.parmDesigns&&b.parmDesigns.length&&(a.resultGrid.queryParams=b),
a.resultGrid.refresh(a.encodePath(a.path()))}function r(a){s(a)&&a.query(a.encodePath(a.path()))}function s(b){if(a.isFunction(b.path)&&b.path()&&""!==b.path())return!0}function t(a,b){u(a),r(a)}function u(a){a.queryParams=null,a.resultGrid.queryParams=null}return j});