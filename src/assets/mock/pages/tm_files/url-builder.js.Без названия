/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("lodash"),b=require("jquery"),c=require("application/application-events"),d=require("spa/conductor"),e=require("system/error/error-message"),f=require("spa/ko/knockout-view-model"),g=require("knockout"),h=require("system/knockout/knockout-manager"),i=require("spa/region"),j=require("system/ui/dialog-view-model"),k=require("system/globalization/translator"),l=require("query/services/query-service"),m=require("dashboard/view-models/url-builder/view-models/url-format-view-model"),n=require("dashboard/view-models/url-builder/view-models/url-feature-view-model"),o=require("dashboard/view-models/url-builder/view-models/url-type-view-model"),p=require("dashboard/view-models/url-builder/view-models/url-parm-view-model"),q=require("ui/elements/wizard/view-model"),r=require("text!dashboard/view-models/url-builder/view-models/views/url-builder.html");require("system/lang/string"),require("system/lang/object");function s(a,b){t.call(this,r),
this.kom=a,this.applicationEvents=b,this.translator=Object.resolve(k),this.queryService=Object.resolve(l),this.region=null,this.canClickDone=null,this.steps={names:[],viewModels:[]},this.wizard=null,this.urlFormatVM=null,this.urlFeatureVM=null,this.urlTypeVM=null,this.urlParmVM=null,this.urlFormat=null,this.parm1Valid=null,this.parm2Valid=null,this.parm3Valid=null,this.parm1Value=null,this.parm2Value=null,this.parm2Value=null,this.pattern=null,this.manualURL=null,this.queryContainer=null,this.columnDesign=null,this.columnIdx=this.kom.observable(),this.designProperty=this.kom.observable(),this.canShowAPM=null,this.canShowManual=null,this.container=null,this.selectedFeature=null,this.selectedRoute=null,this.features=null,this.routes=null,this.columns=null,this.dfd=null,this.dialog=null,this.result=null,this.urlInput=this.kom.observable()}var t=Object.inherit(f,s);s.factory=function(){return new s(Object.resolve(h),Object.resolve(c))},s.prototype.show=function(){var a={height:"90%",
width:"90%"},c=this.translate("URL_BUILDER");return this.dialog=new j(this,c,a),this.dialog.show(),this.dfd=b.Deferred(),this.dfd.promise()},s.prototype.close=function(){this.dialog=null},s.prototype.open=function(){},s.prototype.load=function(a){var c=new b.Deferred,d=this;return this.canClickDone=this.kom.observable(!0),this.steps.names=this.kom.observableArray(),this.steps.viewModels=this.kom.observableArray(),this.urlFeatureVM=Object.resolve(n),this.urlFeatureVM.load(this),this.steps.names.push(this.translate("SELECT_URL_FEATURE")),this.steps.viewModels.push(this.urlFeatureVM),this.urlTypeVM=Object.resolve(o),this.urlTypeVM.load(this),this.steps.names.push(this.translate("SELECT_URL_TYPE")),this.steps.viewModels.push(this.urlTypeVM),this.urlParmVM=Object.resolve(p),this.urlParmVM.load(this),this.steps.names.push(this.translate("SPECIFY_PARMS")),this.steps.viewModels.push(this.urlParmVM),this.urlFormat=this.kom.observable(),this.selectedFeature=this.kom.observable(),
this.selectedRoute=this.kom.observable(),this.columns=this.kom.observableArray(),this.parm1Valid=this.kom.observable(!1),this.parm2Valid=this.kom.observable(!1),this.parm3Valid=this.kom.observable(!1),this.parm1Value=this.kom.observable(),this.parm2Value=this.kom.observable(),this.parm3Value=this.kom.observable(),this.pattern=this.kom.observable(),this.queryService.getUrlContainer().done(x.bind(null,d)).fail(A.bind(null,d)),c.promise()},s.prototype.unload=function(){this.dfd=null,this.result=null,this.kom.disposeObservables()},s.prototype.activate=function(){this.canShowAPM=this.kom.pureComputed(u.bind(null,this)),this.canShowManual=this.kom.pureComputed(v.bind(null,this))},s.prototype.deactivate=function(a){this.kom.disposeSubscriptions(),this.kom.disposeComputeds()},s.prototype.attach=function(a){t.prototype.attach.call(this,a),this.region=a,this.wizard=this.region.element.querySelector("mi-wizard"),Element.upgrade(this.wizard),this.region=a,this.urlFormat("apm")},
s.prototype.detach=function(a){t.prototype.detach.call(this,a)},s.prototype.canUnload=function(){return!0},s.prototype.setInitialUrl=function(){var a="{"+this.selectedRoute().parm1Caption+"}",b="{"+this.selectedRoute().parm2Caption+"}",c="{"+this.selectedRoute().parm3Caption+"}",d=this.pattern().replace("{1}",a).replace("{2}",b).replace("{3}",c);this.urlInput(d)},s.prototype.translate=function(a){return this.translator.translate(a)},s.prototype.cancel=function(){this.dialog.closeDialog()},s.prototype.done=function(){y(this)&&this.dialog.closeDialog()},s.prototype.onFormatSelected=function(a){var b=this;this.urlFormat(a),"ext"===a&&this.wizard.setAttribute("data-active",3)},s.prototype.onFeatureSelected=function(b){var c=this;b&&(this.selectedFeature&&this.selectedFeature()&&b.key===this.selectedFeature().key||(this.selectedFeature(b),this.routes=a.filter(this.container.routes,w.bind(null,c)),this.selectedRoute(null)))},s.prototype.onRouteSelected=function(a){var b=this
;a&&(this.selectedRoute(a),this.selectedRoute().parm1Caption.length>0?this.parm1Valid(!0):this.parm1Valid(!1),this.selectedRoute().parm2Caption.length>0?this.parm2Valid(!0):this.parm2Valid(!1),this.selectedRoute().parm3Caption.length>0?this.parm3Valid(!0):this.parm3Valid(!1),this.pattern(this.selectedRoute().pattern))},s.prototype.isParmValid=function(){return!0},s.prototype.activeChanged=function(a){if(this.region){this.features=this.container.features;var b=parseInt(this.region.$element.find("mi-wizard").attr("data-active"));"ext"===this.urlFormat()?2===b?(this.wizard.setAttribute("data-active",0),this.steps.viewModels()[0].attach(this.region)):1===b?(this.wizard.setAttribute("data-active",3),this.steps.viewModels()[3].attach(this.region)):this.steps.viewModels()[b].attach(this.region):this.steps.viewModels()[b].attach(this.region)}},s.prototype.wizardCompleted=function(a){this.dfd.resolve(this.urlInput()),this.done()};function u(a){return!!a.urlFormat&&"apm"===a.urlFormat()}
function v(a){return!!a.urlFormat&&"ext"===a.urlFormat()}function w(a,b){return b.featureKey===a.selectedFeature().key}function x(a,b){a.container=b,a.features=a.container.features,a.steps.viewModels()[0].attach(a.region),a.region.$element.find("h1").attr("hidden",!0),a.wizard.setAttribute("data-steps",a.steps.names().toString())}function y(a){if(!a.urlFormat||!a.urlFormat()||0===a.urlFormat().length)return void z(a,a.translate("ERROR_SELECT_URL_FORMAT"));if("ext"===a.urlFormat())return!0;if(!a.selectedFeature||!a.selectedFeature())return void z(a,a.translate("ERROR_SELECT_URL_FEATURE"));if(!a.selectedRoute||!a.selectedRoute())return void z(a,a.translate("ERROR_SELECT_URL_TYPE"));var b=a.selectedRoute().pattern;return b=b.replace(/\{key/g,"{"),!0}function z(a,b){var c=2,d=b,f=new e(c,d);a.applicationEvents.errorOccured.raise(a,f)}function A(a,b){z(a,b.statusText)}return s});