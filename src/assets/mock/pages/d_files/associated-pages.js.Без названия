/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("system/lang/converter"),c=require("./associated-pages-service"),d=require("./hyperlink-dto");require("ui/elements/slide-panel-right/right-sidePanel-control"),require("ui/elements/tree/view-model");var e=require("application/application-events"),f=require("system/globalization/translator"),g=Object.create(HTMLElement.prototype);g.createdCallback=function(){var b=this,d=a.Deferred();b.appEvents=Object.resolve(e),b.navigate=b.appEvents.navigate,b.$el=a(b),b.data=[],b.familykey=b.getFamilyKey(),b.entitykey=b.getEntityKey(),b.associatedPagesService=Object.resolve(c),b.translator=Object.resolve(f),k(b),a(b).append('<mi-slidepanelright sliderenable="true" icon="icon-duplicate-entries" title="'+b.translator.translate("ASSOCIATED_PAGES_TITLE")+'"><div class="assoc-page-placeholder"></div></mi-slidepanelright>'),b.rightPanelControl=a(b).find("mi-slidepanelright")[0],Element.upgrade(b.rightPanelControl),h(b,b.familykey,d),
d.done(n.bind(null,b))},g.attributeChangedCallback=function(b,c,d){var e=this,f=a.Deferred();"familykey"===b?(e.familykey=d,e.data=[],e.dataKeys={},l(d),a(".assoc-page-placeholder",this).empty(),h(e,e.familykey,f),f.done(n.bind(null,e))):"entitykey"===b&&(e.entitykey=d,m(d))},g.attachedCallback=function(){};function h(a,b,c){""!==b&&a.associatedPagesService.getAssocPages(b).done(function(b){o(b,a),c.resolve()}).fail(function(a){console.error(a)})}g.getFamilyKey=function a(){return this.getAttribute("familykey")},g.getEntityKey=function a(){return this.getAttribute("entitykey")},g.loadAssociatedPages=function b(c,d,e,f,g){var h=a.Deferred(),i,j,k=c.tree.value[e];if(k&&k.hyperLinkKey&&(i=k.hyperLinkKey),k&&k.url&&(j=k.url),i){var l=c.dataKeys[i];0===l.length&&(q(c,j),h.resolve(null)),h.resolve(l)}else h.resolve(c.data);return a(c).find("mi-tree").on("selected",q.bind(null,c)),h},g.initAssociatedPages=function b(c,d,e){
var f=a('<mi-tree selector="none" multiselect="false"  key="hyperLinkKey" description="displayText" page="1"  page-size="25" scroll-percent="0.75" root-name="'+c.translator.translate("NO_ASSOCIATED_PAGES")+'" has-children="hasChildren"custom-filter="false" custom-search="false" allow-add="false"></mi-tree>');c.tree=f.get(0),Element.upgrade(c.tree),d.appendChild(c.tree),a(d).find("mi-tree")[0].loader=c.loadAssociatedPages.bind(null,c,e),i(c),a(c).change(function(){i(c)}),a("div.sliderPanel").mouseover(function(){a("mi-list-group.nav-list-group  .list-group").css("overflow-x","auto")}).mouseout(function(){a("div.rm-datasheet-container").css("overflow","auto"),a("div.rm-datasheet-container").css("overflow-x","hidden")})};function i(b){var c;if(0===b.data.length)a(a(b).find(".list-group-item")[0]).find("i").hide();else for(a(a(b).find(".list-group-item")[0]).hide(),c=0;c<b.data.length;c++)j(b,c)}function j(b,c){
b.data[c].isDefaultMenu===!0&&a(a(a(b).find(".list-group")[1]).find(".list-group-item")[c]).css({"font-weight":"bold"})}function k(a){a._value=null,Element.defineProperty(a,"value",{get:function(){return this._value}.bind(a),set:function(a){this._value=a,l(this)}.bind(a)})}function l(a){a.value&&(a.querySelector(".familykey").textContent=a.value.familykey)}function m(a){a.value&&(a.querySelector(".entitykey").textContent=a.value.entitykey)}function n(b){var c,d,e,f,g;e=a(b).find(".assoc-page-placeholder")[0],f=document.createElement("div"),f.className="assoc-pages",e.appendChild(f),c=document.createElement("h1"),c.className="assoc-page-title-box",f.appendChild(c),d=document.createTextNode(b.translator.translate("ASSOCIATED_PAGES_TITLE")),c.appendChild(d),b.initAssociatedPages(b,e.firstElementChild,b.familykey)}function o(a,b){var c=[];b.dataKeys={};for(var e=0;e<a.length;e++){var f=new d(a[e]);c.push(f),b.dataKeys[f.hyperLinkKey]=f.children,f.children.length&&p(b,f.children)}b.data=c}
function p(a,b){for(var c=0;c<b.length;c++){var d=b[c];a.dataKeys[d.hyperLinkKey]=d.children,d.children.length&&p(a,d.children)}}function q(a,b){if(b){var c=!1;if((b.indexOf("webmacros/macrorunner")>-1||0===b.indexOf("!"))&&(c=!0),"#"===b.charAt(0)||"!"===b.charAt(0))if(/\{[0-9]\}/.test(b)&&(b=b.replace(/\{[0-9]\}/,a.entitykey),b=b.replace(/\{[0-9]\}/,a.familykey),c?(b=b.substring(1),a.navigate.raise(b,{isActionRoute:!0})):a.navigate.raise(b,{tab:!0})),(/\[ENTY_KEY\]/.test(b)||/\[enty_key\]/.test(b)||/\[FMLY_KEY\]/.test(b)||/\[fmly_key\]/.test(b))&&(b=b.replace("[ENTY_KEY]",a.entitykey),b=b.replace("[FMLY_KEY]",a.familykey),b=b.replace("[enty_key]",a.entitykey),b=b.replace("[fmly_key]",a.familykey)),/\[([A-Z]|[a-z]|[0-9]|\_)*\]/.test(b)){var d=/\[([A-Z]|[a-z]|[0-9]|\_)*\]/g.exec(b),e=d[0],f=e.slice(1,e.length-1);a.associatedPagesService.getDataSheetDetails(a.entitykey).done(function(g){
for(var h=0;h<g.fields.length;h++)g.fields[h].id.toLowerCase()!==f.toLowerCase()||(b=b.replace(e,g.fields[h].dbValue),null===(d=/\[([A-Z]|[a-z]|[0-9]|\_)*\]/g.exec(b)))||(e=d[0],f=e.slice(1,e.length-1),h=-1);c?(b=b.substring(1),a.navigate.raise(b,{isActionRoute:!0})):a.navigate.raise(b,{tab:!0})}).fail(function(a){console.error(a)})}else c?(b=b.substring(1),a.navigate.raise(b,{isActionRoute:!0})):a.navigate.raise(b,{tab:!0});else window.open(b)}}return document.registerElement("mi-associated-pages",{prototype:g}),g});