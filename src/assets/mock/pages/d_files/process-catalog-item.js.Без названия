/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("ui/elements/chart/services/chart-service"),c=require("ui/elements/chart/models/chart-config-adapter"),d=require("ui/elements/chart/process-query"),e=require("dataset/services/dataset-services"),f=require("application/application-events");function g(a,c,d){this.chartService=Object.resolve(b),this.errorOccured=Object.resolve(f).errorOccured,this.datasetService=Object.resolve(e),this.deferred=null,this.processQuery=null,this.catalogItem=a,this.config=null,this.parameters=c||null,this.isFiltered=d||!1,this.reload=!1}g.prototype.load=function(b,c,d){var e;return this.deferred=a.Deferred(),b&&(this.config=b),c&&(this.reload=!0,this.processQuery=null),d&&(this.parameters=null),this.catalogItem.graph&&this.config.datasetKey&&(this.catalogItem.graph.queryKey=null,this.catalogItem.graph.datasetKey=this.config.datasetKey),this.catalogItem.graph&&this.catalogItem.graph.queryKey?(e=a.Deferred(),
e.resolve()):this.catalogItem.graph&&this.catalogItem.graph.datasetKey?e=this.datasetService.fetchDatasetKey(this.catalogItem.graph.datasetKey):this.catalogItem.key?e=this.chartService.getByKey(this.catalogItem.key):this.catalogItem.path&&(e=this.chartService.getByPath(this.catalogItem.path)),e.done(i.bind(null,this)).fail(h.bind(null,this)),this.deferred.promise()},g.prototype.processData=function(b,c){var d=a.Deferred();return this.processQuery.processCategoryCaptions(this.processQuery,b,c,d),d};function h(a,b,c,d){a.deferred.reject(b,c,d)}function i(a,b){if(!b&&(void 0===a.catalogItem.key||null===a.catalogItem.key))return void h(a,{status:404});b&&b.resultGrid&&a.config.datasetKey?a.catalogItem.graph.dataset=b.resultGrid:b&&(a.catalogItem=b),a.catalogItem.graph&&a.reload===!1&&(a.config=c.deserialize(a.catalogItem.graph.config)),a.catalogItem.graph&&!a.catalogItem.graph.datasetKey&&a.config.datasetKey?(a.catalogItem.graph.datasetKey=a.config.datasetKey,
a.catalogItem.graph.queryKey="",a.datasetService.fetchDatasetKey(a.catalogItem.graph.datasetKey).done(i.bind(null,a)).fail(h.bind(null,a))):a.processQuery&&a.processQuery.queryKey===a.catalogItem.graph.queryKey||(a.processQuery=new d(a.catalogItem.graph,a.parameters,a.isFiltered)),a.config.queryKey&&(a.config.queryKey=null),a.processQuery&&a.processQuery.load(a.config).done(j.bind(null,a))}function j(a,b){b.config=a.config,b.catalogItem=a.catalogItem,a.deferred.resolve(b)}return g});