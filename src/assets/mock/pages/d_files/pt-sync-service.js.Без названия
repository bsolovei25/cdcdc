/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("ramda"),c=require("system/lang/event"),d=require("./offline-proof-test-service"),e=require("platform/offline-forms/layout/adapters/offline-record-json-adapter"),f=require("system/http/ajax-client"),g=require("application/application-service"),h=require("application/application-context"),i="api/internal/safety",j=require("./offline-rec-sync-service");function k(){this.ptOfflineService=Object.resolve(d),this.ajaxClient=Object.resolve(f),this.applicationService=Object.resolve(g),this.recSyncService=Object.resolve(j),this.isExecuting=!1,this.syncCompleted=new c,this.serverProofTestRecords=[]}k.singleton=!0,k.prototype.execute=function(){var a=this;this.recSyncService.execute(),h.connectionStatus.connected?a.isExecuting===!1&&(a.isExecuting=!0,a.getRecordsToSync().then(o.bind(null,a)).done(function(){l(a),a.syncCompleted.raise()})):(a.getRecordsToReset().then(p.bind(null,a)).done(function(){l(a),a.syncCompleted.raise()
}),a.isExecuting=!1)};function l(a){a.isExecuting=!1}k.prototype.getRecordsToSync=function b(){var c=a.Deferred();return this.ptOfflineService.getAllOfflineFormDataFromStorage().done(m.bind(null,this,c)),c.promise()},k.prototype.getRecordsToReset=function b(){var c=a.Deferred();return this.ptOfflineService.getAllOfflineFormDataFromStorage().done(n.bind(null,this,c)),c.promise()};function m(a,b,c){for(var d=c,e=[],f=0;f<d.length;f++)for(var g=Object.keys(d[f].records).length,h=0;h<g;h++){var i=d[f].records[Object.keys(d[f].records)[h]];"SYNC_PENDING"===i.syncStatus&&e.push({formData:d[f],record:i})}b.resolve(e)}function n(a,b,c){for(var d=c,e=[],f=0;f<d.length;f++)for(var g=Object.keys(d[f].records).length,h=0;h<g;h++){var i=d[f].records[Object.keys(d[f].records)[h]];"SYNCING"===i.syncStatus&&e.push({formData:d[f],record:i})}b.resolve(e)}function o(c,d){if(!d||0===d.length)return void l(c);var f=a.Deferred();c.serverProofTestRecords=[]
;for(var g=0;g<d.length;g++)c.serverProofTestRecords.push(e.toServerObject(d[g].record)),d[g].record.syncStatus="SYNCING",d[g].formData.records[d[g].record.clientId]=d[g].record;var h=b.uniq(b.pluck("formData")(d));h&&h.length<=0&&l(c);for(var i=0;i<h.length;i++){var j=[{offlineFormData:h[i],offlineForms:[]}];c.ptOfflineService.saveOfflineData(j).done(r.bind(null,c,f,c.serverProofTestRecords,d)).fail(q.bind(null,c,c.serverProofTestRecords,d))}return f.promise()}function p(b,c){var d=a.Deferred();if(c&&0!==c.length)return q(b,c),d.promise()}function q(a,b){l(a);for(var c=0;c<b.length;c++){"SYNCING"===b[c].record.syncStatus&&(b[c].record.syncStatus="SYNC_PENDING"),b[c].formData.records[b[c].record.clientId]=b[c].record;var d=[{offlineFormData:b[c].formData,offlineForms:[]}];a.ptOfflineService.saveOfflineData(d)}}function r(a,b,c,d){a.ajaxClient.post(i+"/offline",c).done(s.bind(null,a,b,d)).fail(x.bind(null,b))}function s(a,b,c,d){t(a,b,c,d)}function t(a,b,c,d){
for(var e=0;e<c.length;e++){for(var f=!1,g=c[e].record,h=0;h<d.length;h++){var i=d[h];i.entityKey===g.entityKey&&(i.errors&&i.errors.length>0&&(g.errors=i.errors,f=!0),f=u(i.relatedRecordErrors,g,f))}c[e].record.syncStatus=f?"SYNC_COMPLETE_W_ERRORS":"SYNC_COMPLETE",c[e].formData.records[c[e].record.clientId]=c[e].record;var j=[{offlineFormData:c[e].formData,offlineForms:[]}];a.ptOfflineService.saveOfflineData(j)}a.isExecuting=!1}function u(a,b,c){for(var d=0;d<a.length;d++){for(var e=a[d],f=0;f<b.relatedRecords.length;f++){var g=b.relatedRecords[f];if(g.familyKey===e.familyKey){for(var h=Object.keys(g.records).length,i=0;i<h;i++){var j=g.records[Object.keys(g.records)[i]];if(j.clientId===e.clientID){j.errors=e.errors;break}}break}}c=!0}return c}function v(a,b,c,d,e){e<d.length-1?(e++,t(a,b,c,d,e)):b.resolve()}function w(a,b){a.resolve(b)}function x(a,b){a.reject(b)}return k});