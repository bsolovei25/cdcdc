/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("lodash"),b=require("ramda"),c=require("query/model/query-result"),d=require("query/model/column-result"),e=require("query/model/row"),f=require("query/model/cell"),g=require("system/globalization/translator"),h=require("ui/elements/chart/services/chart-service"),i=require("application/application-context"),j=require("system/text/formatter"),k=/<a [^>]+>([^<]+)<\/a>/,l=/\[|\]/g,m=/[\s|\[|\]|_|\-|.]/g,n=/^[A-Z]/,o=/'([^']*)'/g,p=/[#']/g,q=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,r=/"/g,s=/href='(.*?)'/,t=/onclick='(.*?)'/,u=/^([^:]+):|^#|^(.\/)|^(..\/)|^!/gm,v=/^(%20|\s)*(data|javascript)/im,w=/[^\x20-\x7E]/gim;function x(){this.CHART_TYPE_COLUMN="column",this.CHART_TYPE_STACKED_COLUMN="stacked-column",this.CHART_TYPE_BAR="bar",this.CHART_TYPE_TIME_SERIES="timeSeries",this.CHART_TYPE_STACKED_BAR="stacked-bar",this.CHART_TYPE_AREA="area",this.CHART_TYPE_AREA_SPLINE="areaspline",this.CHART_TYPE_STACKED_AREA="stacked-area",
this.CHART_TYPE_RADAR="radar",this.CHART_TYPE_POLAR="polar",this.CHART_TYPE_LINE="line",this.CHART_TYPE_PIE="pie",this.CHART_TYPE_DONUT="donut",this.CHART_TYPE_BUBBLE="bubble",this.CHART_TYPE_SCATTER="scatter",this.CHART_TYPE_PYRAMID="pyramid",this.CHART_TYPE_STOCK="stock",this.CHART_TYPE_STOCK_AREA="stock-area",this.CHART_TYPE_STOCK_STACKED_AREA="stacked-stock",this.CHART_TYPE_HEATMAP="heatmap",this.CHART_METHOD_COUNT="count",this.CHART_METHOD_PERCENT="percent",this.CHART_METHOD_SUM="sum",this.translator=Object.resolve(g),this.chartService=Object.resolve(h),this.timezones=[],this.CHART_AXIS_FORMATS=[{format:"",display:this.translator.translate("CHART_NO_FORMAT")},{format:"n",display:this.translator.translate("CHART_NUMBER")},{format:"c",display:this.translator.translate("CHART_CURRENCY")},{format:"p",display:this.translator.translate("CHART_PERCENTAGE")}],
this.CHART_COLORS=["#61adff","#fa913c","#8ad998","#ffdc50","#ff5a4f","#c0deff","#fdd3b1","#d0f0d6","#fff1b9","#ffbdb9","#6999c7","#e08437","#84bb88","#e6c74a","#da524b","#a0ceff","#fcbd8a","#b9e8c1","#ffea96","#ff9c95","#5880a7","#b86c2b","#6d9e72","#bda53d","#b4443c","#81bdff","#fba763","#a1e1ad","#ffe373","#ff7b72","#42617f","#854e18","#4f7755","#8d7c2b","#953730"],this.CHART_INDICATOR_COLORS=["#007aff","#ff9500","#4cd964","#ffcc00","#ff3b30"],this.CHART_TYPES=[{display:this.translator.translate("BAR_CHART"),chartTypes:[{name:this.CHART_TYPE_COLUMN,display:this.translator.translate("CHART_COLUMN"),icon:"icons-mi-chart-column"},{name:this.CHART_TYPE_BAR,display:this.translator.translate("CHART_BAR"),icon:"icons-mi-chart-bar"},{name:this.CHART_TYPE_STACKED_COLUMN,display:this.translator.translate("CHART_STACkED_COLUMN"),icon:"icons-mi-chart-stacked-column"},{name:this.CHART_TYPE_STACKED_BAR,display:this.translator.translate("CHART_STACKED_BAR"),icon:"icons-mi-chart-stacked-bar"},{
name:this.CHART_TYPE_TIME_SERIES,display:this.translator.translate("COLOR_SCALE"),icon:"icons-mi-chart-time-series"}]},{display:this.translator.translate("LINE_CHART"),chartTypes:[{name:this.CHART_TYPE_LINE,display:this.translator.translate("CHART_LINE"),icon:"icons-mi-chart-line"},{name:this.CHART_TYPE_AREA,display:this.translator.translate("CHART_AREA"),icon:"icons-mi-chart-area"},{name:this.CHART_TYPE_STACKED_AREA,display:this.translator.translate("CHART_STACKED_AREA"),icon:"icons-mi-chart-stacked-area"}]},{display:this.translator.translate("PIE_CHART"),chartTypes:[{name:this.CHART_TYPE_PIE,display:this.translator.translate("CHART_PIE"),icon:"icons-mi-chart-pie"},{name:this.CHART_TYPE_DONUT,display:this.translator.translate("CHART_DONUT"),icon:"icons-mi-chart-donut"},{name:this.CHART_TYPE_PYRAMID,display:this.translator.translate("CHART_PYRAMID"),icon:"icons-mi-chart-pyramid"}]},{display:this.translator.translate("RADAR_CHART"),chartTypes:[{name:this.CHART_TYPE_RADAR,
display:this.translator.translate("CHART_RADAR"),icon:"icons-mi-chart-radar"},{name:this.CHART_TYPE_POLAR,display:this.translator.translate("CHART_POLAR"),icon:"icons-mi-chart-polar"}]},{display:this.translator.translate("SCATTER_CHART"),chartTypes:[{name:this.CHART_TYPE_SCATTER,display:this.translator.translate("CHART_SCATTER"),icon:"icons-mi-chart-scatter"},{name:this.CHART_TYPE_BUBBLE,display:this.translator.translate("CHART_BUBBLE"),icon:"icons-mi-chart-bubble"}]},{display:this.translator.translate("STOCK_CHARTS"),chartTypes:[{name:this.CHART_TYPE_STOCK,display:this.translator.translate("CHART_STOCK_LINE"),icon:"icons-mi-stock-chart-line"},{name:this.CHART_TYPE_STOCK_AREA,display:this.translator.translate("CHART_STOCK_AREA"),icon:"icons-mi-stock-chart-area"},{name:this.CHART_TYPE_STOCK_STACKED_AREA,display:this.translator.translate("CHART_STOCK_STACKED_AREA"),icon:"icons-mi-stock-chart-area-stacked"}]},{display:this.translator.translate("HEATMAP_CHARTS"),chartTypes:[{
name:this.CHART_TYPE_HEATMAP,display:this.translator.translate("CHART_HEATMAP"),icon:"icons-mi-heatmap-chart"}]}],this.PIE_LEGEND_TYPES=[{position:0,display:this.translator.translate("NO_LEGEND")},{position:1,display:this.translator.translate("TOP")}],this.LEGEND_TYPES=[{position:0,display:this.translator.translate("NO_LEGEND")},{position:1,display:this.translator.translate("TOP")},{position:2,display:this.translator.translate("TOP_RIGHT")},{position:3,display:this.translator.translate("RIGHT")},{position:4,display:this.translator.translate("BOTTOM_RIGHT")},{position:5,display:this.translator.translate("BOTTOM")},{position:6,display:this.translator.translate("BOTTOM_LEFT")},{position:7,display:this.translator.translate("LEFT")},{position:8,display:this.translator.translate("TOP_LEFT")}]}x.prototype.getLegendVerticalPosition=function(a){switch(a){case 0:case 8:case 1:case 2:return"top";case 7:case 3:return"middle";case 6:case 5:case 4:return"bottom"}},
x.prototype.getLegendHorizontalPosition=function(a){switch(a){case 0:case 8:case 7:case 6:return"left";case 1:case 5:return"center";case 2:case 3:case 4:return"right"}},x.prototype.allow3d=function(a){return[this.CHART_TYPE_COLUMN,this.CHART_TYPE_STACKED_COLUMN,this.CHART_TYPE_BAR,this.CHART_TYPE_STACKED_BAR,this.CHART_TYPE_PIE,this.CHART_TYPE_DONUT].indexOf(a)>-1},x.prototype.translateChartType=function(a){return a===this.CHART_TYPE_STACKED_COLUMN?this.CHART_TYPE_COLUMN:a===this.CHART_TYPE_STACKED_BAR?this.CHART_TYPE_BAR:a===this.CHART_TYPE_STACKED_AREA?this.CHART_TYPE_AREA:a===this.CHART_TYPE_RADAR?this.CHART_TYPE_LINE:a===this.CHART_TYPE_POLAR?this.CHART_TYPE_COLUMN:a===this.CHART_TYPE_TIME_SERIES?this.CHART_TYPE_COLUMN:a};var y=b.curry(function a(b,c,d){b!==d.getLocalizedAlias()&&b!==d.getAlias()||c.push(d)});x.prototype.getTranslatedColumnData=function(a,c){var d,e=[];return a.chart.state.rawData&&(d=a.chart.state.rawData.getColumns(),b.forEach(y(c,e),d)),b.head(e)},
x.getHyperlinkColumnIndexes=function(a){var b,c,d,e,f,g=[],h=a.getColumns(),i;for(c=0;c<a.getRows().length;c++)for(e=a.getRows()[c],d={},b=0;b<e.getCells().length;b++)h[b].getIsDisplayed()&&(i=h[b].getFieldId().replace(l,""),d[i]=e.getCells()[b].getDbValue(),""!==(f=e.getCells()[b].getHyperlinkRoute())&&(this.isInArray(b,g)||(g[g.length]=b)));return g};function z(a,c){for(var d=[],g=0;g<a.length;g++){for(var h=new e,i=[],j=Object.keys(a[g]),l,m=0;m<j.length;m++){var n=new f,o=a[g][j[m]]?a[g][j[m]].toString():"",p=b.map(b.invoker(0,"getAlias"),c),u=b.findIndex(b.equals(j[m]),p);o=q.test(o)?o.replace(q,""):o;if(k.test(o)&&(l=o.replace(r,"'"),l=l.replace(s,A),l=l.replace(t,""))){var v=s.exec(l);null!==v&&n.setHyperlinkRoute(v[1]);var w=k.exec(o||"");null!==w&&(o=w[1])}n.setColumn(c[u]),n.setDbValue(o),n.setValue(o),i.push(n)}h.setCells(i),d.push(h)}return d}function A(a,b){var c=b.replace(w,""),d=c.match(u),e;return d?(e=d[0],v.test(e)?"":"href='"+b+"'"):""}function B(a){
for(var b=[],c=0;c<a.length;c++){var e=new d;e.setAlias(a[c].alias),e.setLocalizedAlias(a[c].alias),e.setIsDisplayed(!0),"character"===a[c].dataType?e.setFieldDataType("System.String"):"number"===a[c].dataType?e.setFieldDataType("System.Integer"):"date"===a[c].dataType?e.setFieldDataType("System.DateTime"):"boolean"===a[c].dataType&&e.setFieldDataType("System.Boolean"),e.setFieldId(D(a[c].id)),b.push(e)}return b}x.formatDataset=function(a){var b=new c;return b.setRowCount(a.data.length),b.setColumns(B(a.columns)),b.setRows(z(a.data,b.getColumns())),b};function C(a){return a.toLowerCase()}function D(a){return a.replace(m,"").replace(n,C)}x.formatGridData=function(a){var c,d,e,f,g=[],h=[],i,j;for(a.data?j=b.keys(a.data[0]):a[0]&&(a.data=a[0].data,j=b.keys(a.data[0])),d=0;d<a.data.length;d++){for(f=a.data[d],e={},c=0;c<j.length;c++)if(i=D(j[c]),e[i]=f[j[c]],e[i]=F(e[i]),0===d){var k={},l=E(j[c],a.data);k.id=D(j[c]),k.alias=j[c],l&&(k.isActionColumn="true"),h.push(k)}g[g.length]=e}return{
columns:h,data:g}};function E(a,c){return b.compose(b.any(K),b.flatten,b.map(b.prop(a)))(c)}function F(b){var c=Object.resolve(j);return G(b)&&a.isFinite(b)&&(b=c.format(b,"g",i.user.cultureId)),b}function G(a){return a%1!=0}x.rowSetToJSON=function(a,b){var c,d,e,f,g=[],h=[],i=b.getColumns(),j,k,m,n,o;for(d=0;d<b.getRows().length;d++){for(f=b.getRows()[d],e={},c=0;c<f.getCells().length;c++)if(i[c].getIsDisplayed()&&(o=i[c].getTypeName(),j=i[c].getFieldId().replace(l,""),j=""!==j?j:D(i[c].getAlias().replace(l,"")),m=f.getCells()[c].getHyperlinkRoute(),n=x.getFormattedValueFromQuery(a,f,[c],0),e[j]=x.formatHyperlink(n,m),k=i[c].getLocalizedAlias()||i[c].getAlias(),0===d)){var p={};p.id=j,k&&(p.alias=k),""!==m&&(p.isActionColumn="true"),h.push(p)}g[g.length]=e}return{columns:h,data:g}};function H(a,b){var c=Object.resolve(j);return I(b)?a=c.format(a,"g",i.user.cultureId):J(b)&&!x.isHTML(a)&&""!==a&&null!==a&&(a=c.format(new Date(a),i.user.formats.dateTime,i.user.cultureId)),a}
function I(a){return"System.Int32"===a||"System.Double"===a}function J(a){return"System.DateTime"===a}x.extractHyperlinkValue=function(a){var b=k.exec(a||"");return null!==b&&(a=b[1]),a},x.extractHyperlinkHref=function(a,b,c){return a.getCells()[b[c]]?a.getCells()[b[c]].getHyperlinkRoute():""},x.extractChartName=function(a,b,c,d){var e=b[c[d]];return a.series[e]?a.series[e].name:""};function K(a){return a&&(a.indexOf("#")>-1||a.indexOf("http")>-1||a.indexOf("!")>-1)}return x.isHTML=function(a){var b=document.createElement("div");b.innerHTML=a;for(var c=b.childNodes,d=c.length;d--;)if(1===c[d].nodeType)return!0;return!1},x.isInArray=function(a,b){return b.indexOf(a)>-1},x.closestByNodeName=function(a,b){for(;a.nodeName!==b;)if(!(a=a.parentNode))return null;return a},x.prototype.showXAxisLabels=function(a){var b=[this.CHART_TYPE_BAR,this.CHART_TYPE_STACKED_BAR,this.CHART_TYPE_POLAR,this.CHART_TYPE_RADAR,this.CHART_TYPE_TIME_SERIES];return a.showXaxisLabels||b.indexOf(a.chartType)>-1},
x.prototype.typeOfPieChart=function(a){return[this.CHART_TYPE_PIE,this.CHART_TYPE_DONUT,this.CHART_TYPE_PYRAMID].indexOf(a)>-1},x.getRowValueFromQuery=function(a,b,c){return a.getCells()[b[c]]?a.getCells()[b[c]].getDbValue():null},x.getFormattedValueFromQuery=function(a,b,c,d){var e=b.getCells()[c[d]]?b.getCells()[c[d]].getValue():null,f=b.getCells()[c[d]]?b.getCells()[c[d]].getColumn().getDisplayUomCaption():null;return a&&a.isUomVisible&&""!==f&&e&&(e=e+" ("+f+")"),e},x.formatHyperlink=function(a,b){return""===b?a:a?"<a href='"+b+"'>"+a+"</a>":null},x.setYValueFromFormatted=function(a,b){return isNaN(b.replace(/['"]+/g,""))?a:b},x});