/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("lodash"),b=require("jquery"),c=require("knockout"),d=require("metrics/services/kpi-service"),e=require("metrics/models/kpi-data-model"),f=require("system/text/formatter"),g=require("system/globalization/translator"),h=require("highcharts");require("kobindings"),require("system/knockout/knockout-helpers");var i={name:"",chartType:"Dial"};function j(h,j){var n=this;n.subscriptions=[],n.isBusy=c.observable(!1),n.rootElement=b(j),n.isResized=h.resize,n.isRefreshed=h.refresh,n.kpiModel=c.observable(Object.resolve(e)),n.kpiService=Object.resolve(d),n.formatter=Object.resolve(f),n.translator=Object.resolve(g),n.properties=c.unwrap(h.properties?a.defaults(c.unwrap(h.properties),i):a.clone(i)),n.kpiChartOptions="Bullet"===c.unwrap(n.properties.chartType)?c.computed(a.partial(p,n)):c.computed(a.partial(o,n)),m(n,c.unwrap(n.properties.name)),c.isObservable(n.properties.name)&&n.subscriptions.push(n.properties.name.subscribe(m.bind(null,n))),
c.isObservable(n.isResized)&&n.subscriptions.push(n.isResized.subscribe(k.bind(null,n))),c.isObservable(n.isRefreshed)&&n.subscriptions.push(n.isRefreshed.subscribe(l.bind(null,n)))}j.prototype.dispose=function b(){var c=this;a.each(c.subscriptions,function(a){a.dispose()}),c.subscriptions=null};function k(a){var b=a.rootElement.outerWidth(!0),d=a.rootElement.outerHeight(!0),e=Math.floor(Math.min(b/2,d))-1,f=a.rootElement.find(".kpi-widget-gauge").highcharts();f&&("Dial"===c.unwrap(a.properties.chartType)?f.setSize(2*e,e):f.setSize(.95*b,d))}function l(a){m(a,c.unwrap(a.properties.name))}function m(a,b){""!==b?(a.isBusy(!0),a.kpiService.getKpiDataByName(b).done(n.bind(null,a)).fail(function(b){a.isBusy(!1)})):a.kpiModel(null)}function n(b,d){b.isBusy(!1),b.kpiChartOptions="Bullet"===c.unwrap(b.properties.chartType)?c.computed(a.partial(p,b)):c.computed(a.partial(o,b)),b.kpiModel().loadFromDTO(d[0]),b.kpiModel.valueHasMutated(),k(b)}function o(b){var c={chart:{type:"gauge",
backgroundColor:"transparent",spacing:[20,10,40,10]},lang:{noData:b.translator.translate("NO_DATA_TO_DISPLAY")},title:null,pane:{center:["50%","95%"],size:"190%",startAngle:-90,endAngle:90,background:[{backgroundColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#FaFaFa"],[.5,"#EeEeEe"],[.51,"rgba(255, 255, 255, 0)"]]},borderWidth:0,outerRadius:"100%",innerRadius:"20"}]},tooltip:{enabled:!1},plotOptions:{gauge:{animation:!1,dataLabels:{borderWidth:0,borderRadius:0,enabled:!0,zIndex:5,padding:0,style:{color:"black",fontSize:"26px",fontWeight:"normal",textShadow:null},crop:!1,overflow:"none",formatter:null},dial:{radius:"95%",backgroundColor:"black",borderWidth:0,baseWidth:16,topWidth:2,baseLength:"0.5%",rearLength:"0%"},pivot:{radius:6,backgroundColor:"#FFFFFF",borderColor:"black",borderWidth:4},overshoot:1}},yAxis:{min:null,max:null,lineWidth:0,minorTickInterval:null,tickPositions:[],tickWidth:0,plotBands:[],labels:{distance:10}},credits:{enabled:!1},series:[{name:"Current",data:[]
}]};if(b.kpiModel()){var d=b.kpiModel(),e=[],f=null,g=null,h=[];if(d.showScore)e=a.map(d.measurementRange,"startScore"),d.measurementRange.length>0&&(f=a.minBy(d.measurementRange,"startScore").startScore,g=a.maxBy(d.measurementRange,"endScore").endScore),e.push(g),h=a.map(d.measurementRange,function(a){return{from:a.startScore,to:a.endScore,color:r(a,d.lastMeasurementScore),thickness:"20%"}}),c.yAxis.labels.formatter=function(){return b.formatter.format(this.value,"N2")},c.series[0].data.push(d.lastMeasurementScore),c.plotOptions.gauge.dataLabels.formatter=function(){var c=b.formatter.format(d.lastMeasurementScore,"N2");return a.isFinite(d.deltaScorePercentage)&&(c+=" (",Math.abs(d.deltaScorePercentage)>=.005&&(d.deltaScorePercentage>=0?c+="+":c+="-"),c+=b.formatter.format(Math.abs(d.deltaScorePercentage),"P0"),c+=")"),c};else{e=a.map(d.measurementRange,"startValue"),d.measurementRange.length>0&&(f=a.minBy(d.measurementRange,"startValue").startValue,
g=a.maxBy(d.measurementRange,"endValue").endValue),e.push(g);var i=c.plotOptions.gauge.dial.radius.split("%");h=a.map(d.measurementRange,function(a){return{from:a.startValue,to:a.endValue,color:q(a,d.lastMeasurementValue),thickness:"20%"}}),c.yAxis.labels.formatter=function(){return b.formatter.format(this.value,d.numberFormat)},c.series[0].data.push(d.lastMeasurementValue),c.plotOptions.gauge.dataLabels.formatter=function(){var c=b.formatter.format(d.lastMeasurementValue,d.numberFormat);return a.isFinite(d.deltaPercentage)&&(c+=" (",Math.abs(d.deltaPercentage)>=.005&&(d.deltaPercentage>=0?c+="+":c+="-"),c+=b.formatter.format(Math.abs(d.deltaPercentage),"P0"),c+=")"),c}}c.yAxis.min=f,c.yAxis.max=g,c.yAxis.plotBands=h,c.yAxis.tickPositions=e,c.plotOptions.gauge.dataLabels.style.color=d.lastMeasurementColor}return c}function p(b){h.SVGRenderer.prototype.symbols.line=function(a,b,c,d){return["M",a/3-c/2,b+d/2,"L",2*a+c,b+d/2,"z"]};var c={chart:{type:"bar",backgroundColor:"transparent",
spacing:[20,10,10,40],marginBottom:50,marginTop:20},lang:{noData:b.translator.translate("NO_DATA_TO_DISPLAY")},credits:{enabled:!1},exporting:{enabled:!1},legend:{enabled:!1},title:{text:""},yAxis:{gridLineWidth:0,labels:{align:"center",style:{color:"black",fontSize:"26px",fontWeight:"normal",textShadow:null,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}},tooltip:{enabled:!1},plotOptions:{bar:{color:"rgba(0, 0, 0, 0.5)",borderWidth:0},scatter:{marker:{symbol:"line",lineWidth:4,lineHeight:10,lineColor:"#000000"}}}};if(b.kpiModel()){var d=b.kpiModel(),e=[],f=null,g=null,i=[],j={},k=null;d.showScore?(e=a.map(d.measurementRange,"startScore"),d.measurementRange.length>0&&(f=a.minBy(d.measurementRange,"startScore").startScore,g=a.maxBy(d.measurementRange,"endScore").endScore),e.push(g),i=a.map(d.measurementRange,function(a){return{from:a.startScore,to:a.endScore,color:r(a,d.lastMeasurementScore),thickness:"3%"}}),j=a.find(d.measurementRange,function(a){
if("Stretch-Target"===a.name)return a.endScore}),k=j?j.endScore:null,j||(j=a.find(d.measurementRange,function(a){if("Target-Stretch"===a.name)return a.startScore}),k=j?j.startScore:null),c.yAxis={min:f,max:g,title:{enabled:!1},tickPositions:e,tickPositioner:function(){return e},plotBands:i,labels:{formatter:function(){return b.formatter.format(this.value,"N2")},rotation:-30}},c.series=[{type:"bar",data:[d.lastMeasurementScore],pointWidth:5},{type:"scatter",data:[k]}]):(e=a.map(d.measurementRange,"startValue"),d.measurementRange.length>0&&(f=a.minBy(d.measurementRange,"startValue").startValue,g=a.maxBy(d.measurementRange,"endValue").endValue),e.push(g),i=a.map(d.measurementRange,function(a){return{from:a.startValue,to:a.endValue,color:q(a,d.lastMeasurementValue),thickness:"3%"}}),j=a.find(d.measurementRange,function(a){if("Stretch-Target"===a.name)return a.endValue}),k=j?j.endValue:null,j||(j=a.find(d.measurementRange,function(a){if("Target-Stretch"===a.name)return a.startValue}),
k=j?j.startValue:null),c.yAxis={min:f,max:g,title:{enabled:!1},tickPositions:e,tickPositioner:function(){return e},plotBands:i,labels:{formatter:function(){return b.formatter.format(this.value,d.numberFormat)},rotation:-30}},c.series=[{type:"bar",data:[d.lastMeasurementValue],pointWidth:5},{type:"scatter",data:[k]}]),c.xAxis={labels:{enabled:!1},tickWidth:"0"}}return c}function q(a,b){return b>=a.startValue&&b<=a.endValue?h.Color(a.color).get("rgba"):h.Color(a.mutedColor).get("rgba")}function r(a,b){return b>=a.startScore&&b<=a.endScore?h.Color(a.color).get("rgba"):h.Color(a.mutedColor).get("rgba")}return j});