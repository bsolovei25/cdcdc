/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("lodash"),c=require("system/data/storage"),d=require("system/lang/converter"),e=require("rounds/common/dto/route-info-dto").RouteInfoDTO,f=require("rounds/common/dto/route-detail-dto").RouteDetailDTO,g="asset-care-routes",h="asset-care-measurement-locations",i="asset-care-ml-routeKey",j="asset-care-inspection-routes",k="asset-care-inspection-readings",l="asset-care-inspection-reading-route",m="asset-care-inspection-reading-pendingChange",n="asset-care-inspection-route-pendingChange",o="offline-checkpoint-pictures",p=require("ramda"),q=require("bluebird"),r=require("ui/elements/date-time/timezone-handler");function s(){}s.prototype.saveMeasurementLocations=function(b){var d=Object.resolve(c),e=a.Deferred();return d.open().done(D.bind(null,d,e,b)).fail(e.reject.bind(e)),e.promise()},s.prototype.saveRoutes=function(b){var d=Object.resolve(c),e=a.Deferred()
;return d.open().done(E.bind(null,d,e,b)).fail(e.reject.bind(e)),e.promise()},s.prototype.saveRoute=function(b){var c=a.Deferred();return this.getInspectionRoute(b.routeKey).done(ma.bind(null,this,c,b)),c.promise()},s.prototype.getUserRoutes=function(){var b=Object.resolve(c),d=a.Deferred();return b.open().done(F.bind(null,b,d)).fail(d.reject.bind(d)),d.promise()},s.prototype.getRouteDetail=function(b){var d=a.Deferred(),e=Object.resolve(c);return q.resolve(e.open()).then(H.bind(null,e,b)).then(t.bind(null,this,b)).spread(I.bind(null,d)).catch(d.reject.bind(d)).finally(e.close.bind(e)),d.promise()};function t(a,b,c){return new q(function(d,e){q.resolve(a.getUserRoute(b)).then(function(a){d([c,a])}).catch(e)})}s.prototype.getUserRoute=function(b){var d=a.Deferred(),e=Object.resolve(c);return e.open().done(K.bind(null,e,b,d)).fail(d.reject.bind(d)),d.promise()},s.prototype.saveReading=function(b,c){var d=a.Deferred()
;return this.getInspectionRoute(c.routeKey).done(na.bind(null,this,d,c,b)),d.promise()},s.prototype.deleteReading=function(b){var d=a.Deferred(),e=Object.resolve(c);return e.open().done(O.bind(null,e,d,b)).fail(d.reject.bind(d)),d.promise()},s.prototype.deleteRouteForUnsubscribe=function(a,b){var d=Object.resolve(c);return d.open().done(u.bind(null,d,a,b)).fail(a.reject.bind(a)),a.promise()};function u(a,b,c){a.delete(g,c).done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}s.prototype.deleteImageForUnsubscribe=function(a,b){var d=Object.resolve(c);return d.open().done(v.bind(null,d,a,b)).fail(a.reject.bind(a)),a.promise()};function v(a,b,c){a.getAll(h).done(w.bind(null,a,b,c)).fail(b.reject.bind(b)).always(a.close.bind(a))}function w(a,c,e,f){var g,h=[],i=[],j=[],k;for(g=0;g<f.length;g++)h[h.length]=f[g].value;for(h.sort(J),g=0;g<h.length;g++)0!==h[g].relRefDocKey&&(h[g].routeKey===e?i.push(d.toString(h[g].relRefDocKey)):j.push(d.toString(h[g].relRefDocKey)))
;k=b.difference(i,j),a.deleteAll(o,k).done(c.resolve.bind(c)).fail(c.reject.bind(c)).always(a.close.bind(a))}s.prototype.updateCachedRoute=function(b,d){var e=a.Deferred(),f=Object.resolve(c);return f.open().done(P.bind(null,f,e,b,d)).fail(e.reject.bind(e)),e.promise()},s.prototype.getInspectionRoute=function(b){var d=a.Deferred(),e=Object.resolve(c);return e.open().done(ba.bind(null,e,d,b)).fail(d.reject.bind(d)),d.promise()},s.prototype.markDone=function(b){var d=a.Deferred(),e=Object.resolve(c);return e.open().done(ca.bind(null,e,d,b)).fail(d.reject.bind(d)),d.promise()},s.prototype.updateCachedRouteDates=function(b,d,e){var f=a.Deferred(),g=Object.resolve(c);return g.open().done(Q.bind(null,g,f,b,d,e)).fail(f.reject.bind(f)),f.promise()},s.prototype.updateInspectionCachedRouteDates=function(b,d,e){var f=a.Deferred(),g=Object.resolve(c);return g.open().done(R.bind(null,g,f,b,d,e)).fail(f.reject.bind(f)),f.promise()},s.prototype.updateLastDateForMarkDoneRoute=function(b,d){
var e=a.Deferred(),f=Object.resolve(c);return f.open().done(S.bind(null,f,e,b,d)).fail(e.reject.bind(e)),e.promise()},s.prototype.clearRoute=function(b){var d=a.Deferred(),e=Object.resolve(c);return e.open().done(da.bind(null,e,d,b)).fail(d.reject.bind(d)),d.promise()},s.prototype.updateCachedReading=function(b){var d=a.Deferred(),e=Object.resolve(c);return e.open().done(Z.bind(null,e,d,b)).fail(d.reject.bind(d)),d.promise()},s.prototype.getReading=function(b){var d=a.Deferred(),e=Object.resolve(c);return e.open().done($.bind(null,e,d,b)).fail(d.reject.bind(d)),d.promise()},s.prototype.getReadings=function(b){var d=a.Deferred(),e=Object.resolve(c);return e.open().done(_.bind(null,e,d,b)).fail(d.reject.bind(d)),d.promise()},s.prototype.getReadingsToUpload=function(){var b=a.Deferred(),d=Object.resolve(c);return d.open().done(ga.bind(null,d,b)).fail(b.reject.bind(b)),b.promise()},s.prototype.getAllRoutesWithReadings=function(){var b=a.Deferred(),d=Object.resolve(c)
;return d.open().done(ha.bind(null,d,b)).fail(b.reject.bind(b)),b.promise()},s.prototype.getRouteWithReading=function(b){var d=a.Deferred(),e=Object.resolve(c);return e.open().done(la.bind(null,e,d,b)).fail(d.reject.bind(d)),d.promise()},s.prototype.getCompletedRoutesToUpload=function(){var b=a.Deferred(),d=Object.resolve(c);return d.open().done(ia.bind(null,d,b)).fail(b.reject.bind(b)),b.promise()},s.prototype.clearSubscriptions=function(){var b=a.Deferred(),d=Object.resolve(c);return d.open().done(ka.bind(null,d,b)).fail(b.reject.bind(b)),b.promise()},s.prototype.clearCachedMLsFromRoute=function(b){var d=a.Deferred(),e=Object.resolve(c);return e.open().done(x.bind(null,e,d,b)).fail(d.reject.bind(d)),d.promise()};function x(a,b,c){a.getAllKeys(h,c,i).done(y.bind(null,a,b)).fail(b.reject.bind(b))}function y(a,b,c){a.deleteAll(h,c).done(b.resolve.bind(b)).fail(b.reject.bind(b))}s.prototype.saveOfflinePictures=function(b){var d=Object.resolve(c),e=a.Deferred()
;return d.open().done(z.bind(null,d,e,b)).fail(e.reject.bind(e)),e.promise()};function z(b,c,d){var e=[],f=d,g,h={};for(g=0;g<Object.keys(f).length;g++)h={key:Object.keys(f)[g],pic:Object.keys(f).map(A.bind(null,f,g))[g]},e[e.length]=b.put(o,h);a.when.apply(a,e).done(c.resolve.bind(c)).fail(c.reject.bind(c)).always(b.close.bind(b))}function A(a,b,c){return a[c]}s.prototype.getOfflinePicture=function(a,b){var d=Object.resolve(c);return d.open().done(B.bind(null,d,a,b)).fail(a.reject.bind(a)),a.promise()};function B(a,b,c){a.get(o,c).done(C.bind(null,b,c)).fail(b.reject.bind(b)).always(a.close.bind(a))}function C(a,b,c){a.resolve(c.pic)}function D(b,c,d){var e=[],f=d.measurementLocations,g;for(g=0;g<f.length;g++)e[e.length]=b.put(h,f[g]);a.when.apply(a,e).done(c.resolve.bind(c)).fail(c.reject.bind(c)).always(b.close.bind(b))}function E(b,c,d){var e=[],f;for(f=0;f<d.length;f++)e[e.length]=b.put(g,d[f])
;a.when.apply(a,e).done(c.resolve.bind(c)).fail(c.reject.bind(c)).always(b.close.bind(b))}function F(a,b){a.getAll(g).done(G.bind(null,b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function G(a,b){var c,d=[];for(c=0;c<b.length;c++)d[d.length]=new e(b[c].value);a.resolve(d)}function H(a,b){return q.resolve(a.getAll(h,b,i))}function I(a,b,c){var d,e=[],g;for(d=0;d<b.length;d++)e[e.length]=b[d].value;e.sort(J),g=new f({checkPoints:e},c.key),g.routeNextDate=c.isScheduled?c.nextDate:null,a.resolve(g)}function J(a,b){for(var c=a.branchSequence.split("."),d=b.branchSequence.split("."),e=0;e<Math.max(c.length,d.length);e++){if(!c[e])return-1;if(!d[e])return 1;if(c[e]-d[e]!=0)return c[e]-d[e]}return 0}function K(a,b,c){a.get(g,b).done(L.bind(null,c)).fail(c.reject.bind(c)).always(a.close.bind(a))}function L(a,b){a.resolve(new e(b))}function M(a,b,c){a.put(j,c).done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function N(a,b,c){
a.put(k,c).done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function O(a,b,c){a.delete(k,c).done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function P(a,b,c,d){a.get(j,c).done(Y.bind(null,a,b,d)).fail(b.reject.bind(b)).always(a.close.bind(a))}function Q(a,b,c,d,e){a.get(g,c).done(W.bind(null,a,b,d,e))}function R(a,b,c,d,e){a.get(j,c).done(U.bind(null,a,b,d,e))}function S(a,b,c,d){a.get(g,c).done(X.bind(null,a,b,d)).fail(b.reject.bind(b)).always(a.close.bind(a))}function T(a,b,c,d){if(p.isNil(d)||0===d.length)return void b.resolve();d[0]&&(c.nextDate=d[0]),d[1]&&(c.overdueDate=d[1]),a.put(g,c).done(b.resolve.bind(b)).fail(b.reject.bind(b))}function U(a,b,c,e,f){if(p.isNil(f))return void b.resolve();var g=Object.resolve(r),h=[];e&&h.push(q.resolve(g.getUserTzDate(d.toDate(e)))),c&&h.push(q.resolve(g.getUserTzDate(d.toDate(c)))),q.all(h).then(V.bind(null,a,b,f)).catch(b.reject.bind(b)).finally(a.close.bind(a))}function V(a,b,c,d){
if(p.isNil(d)||0===d.length)return void b.resolve();d[0]&&(c.nextDate=d[0]),d[1]&&(c.overdueDate=d[1]),a.put(j,c).done(b.resolve.bind(b)).fail(b.reject.bind(b))}function W(a,b,c,e,f){if(p.isNil(f))return void b.resolve();var g=Object.resolve(r),h=[];e&&h.push(q.resolve(g.getUserTzDate(d.toDate(e)))),c&&h.push(q.resolve(g.getUserTzDate(d.toDate(c)))),q.all(h).then(T.bind(null,a,b,f)).catch(b.reject.bind(b)).finally(a.close.bind(a))}function X(a,b,c,d){if(p.isNil(d))return void b.resolve();d.lastDate=c,a.put(g,d).done(b.resolve.bind(b)).fail(b.reject.bind(b))}function Y(a,b,c,d){d&&(d.historyKey=c,a.put(j,d).done(b.resolve.bind(b)).fail(b.reject.bind(b)))}function Z(a,b,c){a.put(k,c).done(b.resolve.bind(b)).fail(b.reject.bind(b))}function $(a,b,c){a.get(k,c).done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function _(a,b,c){a.getAll(k,c,l).done(aa.bind(null,b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function aa(a,b){var c,d=[]
;for(c=0;c<b.length;c++)d[d.length]=b[c].value;a.resolve(d)}function ba(a,b,c){a.get(j,c).done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function ca(a,b,c){a.put(j,c).done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function da(a,b,c){a.delete(j,c).done(ea.bind(null,a,b,c)).fail(b.reject.bind(b))}function ea(a,b,c){a.getAllKeys(k,c,l).done(fa.bind(null,a,b)).fail(b.reject.bind(b))}function fa(a,b,c){a.deleteAll(k,c).done(b.resolve.bind(b)).fail(b.reject.bind(b))}function ga(a,b){a.getAll(k,"true",m).done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function ha(a,b){a.getAll(j).done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function ia(a,b){a.getAll(j,"true",n).done(ja.bind(null,b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function ja(a,b){var c,d=[];for(c=0;c<b.length;c++)d[d.length]=b[c].value;a.resolve(d)}function ka(b,c){var d,e;d=b.clear(g),e=b.clear(h),
a.when(d,e).done(c.resolve.bind(c)).fail(c.reject.bind(c))}function la(a,b,c){a.get(j,c).done(b.resolve.bind(b)).fail(b.reject.bind(b))}function ma(a,b,d,e){var f=Object.resolve(c);p.isNil(e)||(d.comment=e.comment,d.pendingChange=e.pendingChange,d.closeDate=e.closeDate,e.overdueDate&&(d.overdueDate=e.overdueDate),e.nextDate&&(d.nextDate=e.nextDate)),f.open().done(M.bind(null,f,b,d)).fail(b.reject.bind(b))}function na(a,b,d,e,f){var g=Object.resolve(c);g.open().done(N.bind(null,g,b,e)).fail(b.reject.bind(b))}return s});