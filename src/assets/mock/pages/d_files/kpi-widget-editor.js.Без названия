/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("lodash"),b=require("jquery"),c=require("./widget-editor"),d=require("metrics/kpi-list-view-model"),e=require("system/ui/dialog-box"),f=require("system/globalization/translator"),g=require("toastr"),h=require("../views/kpi-widget-editor-view");require("ui/elements/localize/localize-element"),require("ui/elements/list-group/view-model");function i(a){j.call(this,a,h.html),this.editorView=Object.resolve(h),this.translator=Object.resolve(f),this.backup.key=this.kom.observable(),this.backup.kpiName=this.kom.observable(),this.toEnableSave=this.kom.observable(),this.availableKPIListGroup=null,this.selectedKPIListGroup=null,this.selectedKPIsOnLeft=[],this.selectedKPIsOnRight=this.kom.observableArray([]),this.availableitems=[]}var j=Object.inherit(c,i);function k(a,c,d){var e=b.Deferred();return e.resolve(l(a,a.availableitems,c,d)),e.promise()}function l(b,c,d,e){return a.take(a.drop(c,(d-1)*e),e)}i.prototype.setValue=function(a,b){
null!==b.target._searchList&&(b.target._searchList._value=null,b.target._searchList.searchResult=[])};function m(a){var c=b.Deferred(),e=Object.resolve(d);return"Dial"===a.widgetVM.kpiChartType()&&a.widgetVM.key()?e.kpiService.getKpiDetails(a.widgetVM.key()).done(function(b){a.selectedKPIListGroup.items=[b],a.selectedKPIsOnRight(a.selectedKPIListGroup.items),a.toEnableSave(a.selectedKPIsOnRight()[0])}).fail(function(a){}):(a.selectedKPIListGroup.items=a.widgetVM.selectedKpis(),a.selectedKPIsOnRight(a.selectedKPIListGroup.items),a.toEnableSave(a.selectedKPIsOnRight()[0])),c.resolve(a.selectedKPIListGroup.items),c.promise()}function n(c,d,e,f){var g=b.Deferred(),h=d.trim().toLowerCase(),i=[];return i=h?a.filter(c.availableitems,function(a){return a.name.toLowerCase().indexOf(h)!==-1}):c.availableitems,g.resolve(l(c,i,e,f)),g.promise()}i.prototype.moveAvailableKPIs=function c(){var d=b.Deferred(),e=this;if("Dial"===e.widgetVM.kpiChartType()){
if(e.selectedKPIsOnLeft.length>1||e.selectedKPIListGroup.items.length>0)return void g.warning(e.translator.translate("KPI_DASHBOARD_DIAL_SELECTION"))}else{if(a.uniqBy(a.union(e.selectedKPIListGroup.items,e.selectedKPIsOnLeft),function(a){return a.key}).length>10)return void g.warning(e.translator.translate("KPI_DASHBOARD_BULLET_SELECTION"))}e.selectedKPIListGroup.items=a.uniqBy(a.union(e.selectedKPIListGroup.items,e.selectedKPIsOnLeft),function(a){return a.key}),e.availableitems=a.filter(e.availableitems,function(a){return e.selectedKPIsOnLeft.indexOf(a)===-1}),e.availableKPIListGroup.items=a.filter(e.availableKPIListGroup.items,function(a){return e.selectedKPIsOnLeft.indexOf(a)===-1}),e.selectedKPIsOnRight(e.selectedKPIListGroup.items),e.availableKPIListGroup.selectedItems=[],e.selectedKPIsOnLeft=[],e.toEnableSave(e.selectedKPIsOnRight()[0]),b(".kpi-list > .search-list")[0]&&b(".kpi-list > .search-list")[0].reload(),d.resolve(e.selectedKPIListGroup.items)},
i.prototype.onSelectedKPIsFromLeft=function a(b){this.selectedKPIsOnLeft=b.target.selectedItems},i.prototype.moveSelectedKPIs=function b(){var c=this;c.availableKPIListGroup.items=a.uniqBy(a.union(c.availableKPIListGroup.items,c.selectedKPIListGroup.selectedItems),function(a){return a.key}),c.availableKPIListGroup.items=a.sortBy(c.availableKPIListGroup.items,function(a){return a.name.toLowerCase()}),c.availableitems=c.availableKPIListGroup.items,c.selectedKPIsOnRight(a.difference(c.selectedKPIListGroup.items,c.selectedKPIListGroup.selectedItems)),c.selectedKPIListGroup.items=c.selectedKPIsOnRight(),c.widgetVM.widget.name(""),c.toEnableSave(c.selectedKPIsOnRight()[0])},i.prototype.moveKPIUp=function b(){var c=this;if(1===c.selectedKPIListGroup.selectedItems.length){var d=c.selectedKPIListGroup.selectedItems[0],e=a.findIndex(c.selectedKPIsOnRight(),{key:d.key});if(e>0){var f=c.selectedKPIsOnRight()[e];c.selectedKPIsOnRight()[e]=c.selectedKPIsOnRight()[e-1],c.selectedKPIsOnRight()[e-1]=f}
c.selectedKPIListGroup.items=c.selectedKPIsOnRight(),c.selectedKPIListGroup.selectedItems=[d]}},i.prototype.moveKPIDown=function b(){var c=this;if(1===c.selectedKPIListGroup.selectedItems.length){var d=c.selectedKPIListGroup.selectedItems[0],e=a.findIndex(c.selectedKPIsOnRight(),{key:d.key});if(e<c.selectedKPIsOnRight().length-1){var f=c.selectedKPIsOnRight()[e];c.selectedKPIsOnRight()[e]=c.selectedKPIsOnRight()[e+1],c.selectedKPIsOnRight()[e+1]=f}c.selectedKPIListGroup.items=c.selectedKPIsOnRight(),c.selectedKPIListGroup.selectedItems=[d]}},i.prototype.afterLoad=function(){o(this)},i.prototype.afterSave=function(){var b=this,c=b.widgetVM.translator.translate("KPI_WIDGET");if("Bullet"===b.widgetVM.kpiChartType()){var d=[];a.each(b.selectedKPIListGroup.items,function(c){var e=a.pick(c,"name","key");e.chartType=b.widgetVM.kpiChartType(),d.push(e)}),b.widgetVM.selectedKpis(d),""===b.widgetVM.widget.name()?b.widgetVM.widget.name(c):b.widgetVM.widget.name(b.widgetVM.widget.name())
}else b.selectedKPIListGroup.items.length>0?(b.widgetVM.kpiName(b.selectedKPIListGroup.items[0].name),b.widgetVM.key(b.selectedKPIListGroup.items[0].key),b.widgetVM.widget.name()===c||""===b.widgetVM.widget.name()?b.widgetVM.widget.name(b.widgetVM.kpiName()):b.widgetVM.widget.name(b.widgetVM.widget.name()),b.widgetVM.selectedKpis([{name:b.widgetVM.kpiName(),key:b.widgetVM.key(),chartType:b.widgetVM.kpiChartType()}])):b.widgetVM.selectedKpis([]),b.selectedKPIListGroup.items.length>1&&g.warning(b.translator.translate("KPI_DASHBOARD_DIAL_SELECTION"));p(this)},i.prototype.afterCancel=function(){q(this)},i.prototype.afterAttach=function(a){var c=this;this.editorView.attach(a),j.prototype.handleRequiredFields.call(this,this.toEnableSave),Element.upgrade(a.element.querySelectorAll("mi-localize")),c.region=a,c.loadKPIList(),c.availableKPIListGroup=c.region.$element.find("mi-list-group")[0],Element.upgrade(c.availableKPIListGroup),c.availableKPIListGroup.loader=k.bind(null,c),
c.availableKPIListGroup.searchCallback=n.bind(null,c),b(this.availableKPIListGroup).on("selected",this.onSelectedKPIsFromLeft.bind(this)),c.selectedKPIListGroup=c.region.$element.find("mi-list-group")[1],Element.upgrade(c.selectedKPIListGroup),c.selectedKPIListGroup.loader=m.bind(null,c)},i.prototype.afterDetach=function(){this.editorView.detach()},i.prototype.loadKPIList=function(){var a=Object.resolve(d),b=this;a.kpiService.getKpiList(0,0,null,!1,null).done(function(a){b.availableitems=a,b.availableKPIListGroup.reload()}).fail(function(a){})};function o(a){a.backup.key(a.widgetVM.key()),a.backup.kpiName(a.widgetVM.kpiName())}function p(a){a.backup.key(null),a.backup.kpiName(null)}function q(a){a.widgetVM.key(a.backup.key()),a.widgetVM.kpiName(a.backup.kpiName())}return i});