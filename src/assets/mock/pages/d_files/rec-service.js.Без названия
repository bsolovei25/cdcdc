/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require,exports,module){"use strict";var a=require("jquery"),b=require("rounds/data-collection/services/rec-storage"),c=require("system/http/ajax-client"),d=require("application/application-context"),e=require("rounds/data-collection/dto/rec-options-dto"),f=require("rounds/data-collection/dto/rec-offline-dto").RecOfflineDTO,g=require("rounds/data-collection/rec-offline/offline-recommendation-view-model").OfflineRecommendationViewModel,h="api/internal/recommendations/opr",i=require("system/lang/event"),j=require("rounds/data-collection/rec-offline/rec-offline-events"),k=require("system/globalization/translator"),l=require("toastr"),m=require("ramda"),n=require("system/lang/converter");function o(){this.storage=Object.resolve(b),this.ajaxclient=Object.resolve(c),this.recSavedEvent=new i,this.recEvents=Object.resolve(j),this.translator=Object.resolve(k)}o.prototype.saveRecommendation=function(b){var c;return d.connectionStatus.connected||(b.pendingChange="true"),
c=a.Deferred(),""!==b.entityKey?this.storage.getRecommendation(b.entityKey).done(p.bind(null,this,b,c)).fail(c.reject.bind(c)):setTimeout(p.bind(null,this,b,c),0),c.promise()};function p(a,b,c,d){""===b.createdate?b.createdate=n.toDateString(new Date,"yyyy-MM-ddTHH:mm:ss.fff"):b.createdate=n.toDateString(b.createdate,"yyyy-MM-ddTHH:mm:ss.fff"),d&&(b.autoincrementkey=d.autoincrementkey);var e=a.storage.saveRecommendation(b);e.done(c.resolve.bind(c)),e.done(z.bind(null,a,e,b))}o.prototype.uploadOfflineRecommendations=function(){var b=a.Deferred();return this.recEvents.syncEvent.raise(b),this.storage.getAllPendingRecommendations().done(w.bind(null,this,b)),b.promise()},o.prototype.saveRecommendations=function(a){return this.ajaxclient.post(h,a)},o.prototype.getRelatedRecommendations=function(b){var c=a.Deferred();return this.ajaxclient.get(h+"/multiple?mlkey="+b).done(A.bind(null,this,c,b)).fail(E.bind(null,this,c,b)),c.promise()},o.prototype.getOfflineRelatedRecommendations=function(b){
var c=a.Deferred();return E(this,c,b),c.promise()},o.prototype.getAllRecommendationsForRoute=function(b){var c=a.Deferred();return this.ajaxclient.get(h+"/route?routekey="+b).done(q.bind(null,c)).fail(c.reject.bind(c)),c.promise()};function q(a,b){a.resolve(f.fromDataCollection(b))}o.prototype.getRecOptions=function(){var b=a.Deferred();return this.storage.getRecOptions().done(r.bind(null,this,b)),b.promise()},o.prototype.getOfflineRecommendationForm=function(a){return this.ajaxclient.get(h+"/offline?familyid="+a)},o.prototype.saveLayoutToLocal=function(a){return this.storage.saveLayoutInfo(a)},o.prototype.getLayoutFromDB=function(a){return this.storage.getLayoutFromDB(a)};function r(a,b,c){var d=null;void 0===c||null===c?a.ajaxclient.get(h+"/options").done(r.bind(null,a,b)).fail(b.reject.bind(b)):(d=new e(c),a.storage.saveRecOptions(d),b.resolve(d))}function s(a,b,c){c=new f(c),
"Delete"===c.tracking?a.storage.deleteRecommendation(c.autoincrementkey):a.storage.saveRecommendation(c,c.autoincrementkey).done(t.bind(null,a,c))}function t(a,b){a.recSavedEvent.raise(new g(b))}function u(a,b){b.pendingChange="true",a.storage.saveRecommendation(b,b.autoincrementkey)}function v(a,b){a.ajaxclient.post(h,b)}function w(a,b,c){0===c.length?b.resolve():a.ajaxclient.post(h+"/multiple",c).done(x.bind(null,a)).done(y.bind(null,a,b))}function x(a,b){var c=void 0===b.length?[b]:b;m.none(m.propEq("tracking","Delete"),c)?l.success(a.translator.translate("REC_SAVED")):l.error(a.translator.translate("RECOMMENDATIONS_NOT_CREATED"))}function y(a,b,c){a.storage.saveAllRecommendations(c).done(b.resolve.bind(b,c)).fail(b.reject.bind(b,c))}function z(a,b,c,e){d.connectionStatus.connected&&(c.autoincrementkey=e,a.ajaxclient.post(h,c).done(x.bind(null,a)).done(s.bind(null,a,b)).fail(u.bind(null,a,c,b)))}function A(a,b,c,d){
a.storage.getAllPendingRecommendations().done(B.bind(null,b,c,d)).fail(b.reject.bind(b))}function B(a,b,c,d){var e,f;e=d.filter(D.bind(null,b)),e.sort(C),f=e.concat(c),a.resolve(f)}function C(a,b){return b.autoincrementkey-a.autoincrementkey}function D(a,b){return b.relatedMLKey===a}function E(a,b,c){a.storage.getRelatedRecommendations(c).done(b.resolve.bind(b)).fail(b.reject.bind(b))}return o});