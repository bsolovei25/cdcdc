/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("lodash"),b=require("jquery"),c=require("knockout"),d=require("./widget-view-model"),e=require("./chart-widget-editor"),f=require("../models/commands/goto-route-command"),g=require("mi-assert"),h=require("application/application-events"),i=require("text!../views/chart-widget.html");require("ui/elements/chart/chart-view-model");function j(b){k.call(this,b,i,e),this.path=c.observable(),this.pathSubscription=null,this.region=null,this.chartElement=null,this.$gridLayoutItem=null,this.debouncedWidgetResizeFunction=a.debounce(p.bind(null,this),250),this.applicationEvents=Object.resolve(h),this.gotoRouteCommand=Object.resolve(f,"graph"),this.chartConfig=null}var k=Object.inherit(d,j);j.prototype.afterAttach=function a(c){try{Element.upgrade("mi-chart",c),this.pathSubscription=this.path.subscribe(u.bind(null,this)),this.region=c,this.chartElement=b(this.region.$element).find("mi-chart").get(0),this.$gridLayoutItem=b("mi-grid-layout-item"),
this.$gridLayoutItem.on("element-resized",this.debouncedWidgetResizeFunction),q(this)}catch(a){k.prototype.onError.call(this,a)}},j.prototype.beforeDetach=function a(){try{l(this),this.pathSubscription.dispose(),this.pathSubscription=null,this.$gridLayoutItem.off("element-resized"),this.$gridLayoutItem=null,this.chartElement=null}catch(a){k.prototype.onError.call(this,a)}finally{this.pathSubscription=null,this.$gridLayoutItem=null,this.chartElement=null}};function l(a){if(a.chartElement){var b=a.chartElement.saveState(),c,d;m(b)&&(d=b.processData.processQuery.queryContainer.parmContainer,c=b.config,c.queryParams=d,c.catalogPath=a.encodePath(a.path()),a.chartConfig=c)}}function m(a){return a.processData.processQuery&&a.processData.processQuery.queryContainer&&a.processData.processQuery.queryContainer.parmContainer}j.prototype.deserialize=function a(){try{var b=this.widget.properties();g.ok(b,"properties"),b.path&&this.path(b.path)}catch(a){k.prototype.onError.call(this,a)}},
j.prototype.serialize=function a(){try{return l(this),r(this),{path:this.path()}}catch(a){k.prototype.onError.call(this,a)}},j.prototype.refresh=function a(){try{n(this)}catch(a){k.prototype.onError.call(this,a)}};function n(a){o(a)&&a.chartElement.reload()}function o(a){return a.chartElement&&a.chartElement.state&&a.chartElement.state.chartData&&a.chartElement.state.chartData.length}j.prototype.redraw=function(){p(this)},j.prototype.goto=function a(){this.gotoRouteCommand.execute(this.region.element,this.encodePath(this.path()))},j.prototype.icon=function a(){try{return"dashboard-icon-chart2"}catch(a){k.prototype.onError.call(this,a)}};function p(a){a&&a.chartElement&&a.chartElement.draw()}function q(a){a.region&&(r(a),t(a,a.chartConfig||{catalogPath:a.encodePath(a.path()),delegateLoadToFilter:!0}))}function r(a){a.chartElement&&s(a)&&(a.chartElement.skipFilterLoad=!0)}function s(a){
return a.chartConfig&&a.chartConfig.queryParams.parmDesigns&&a.chartConfig.queryParams.parmDesigns.length}function t(a,b){a.chartElement.catalogItem={},a.chartElement.load(b)}function u(a,b){v(a)}function v(a){t(a,{catalogPath:a.encodePath(a.path()),delegateLoadToFilter:!1})}return j});