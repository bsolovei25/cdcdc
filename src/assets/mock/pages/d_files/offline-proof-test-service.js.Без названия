/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("ramda"),c=require("system/http/ajax-client"),d=require("../../adapters/main-application/offline-form-data-adapter"),e=require("platform/offline-forms/layout/adapters/offline-form-data-json-adapter"),f=require("system/data/storage"),g="offline-form-struture",h="offline-proof-tests",i="api/internal/safety";function j(a){this.ajaxClient=a,this.storage=Object.resolve(f)}j.dependsOn=[c],j.prototype.saveProofTestsToIndexedDB=function b(c){var d=a.Deferred();return this.ajaxClient.get(i+"/offline/"+c).done(k.bind(null,this,d)).fail(A.bind(null,d)),d.promise()},j.prototype.saveBulkProofTestsToIndexedDB=function b(c){var d=a.Deferred();return this.ajaxClient.post(i+"/bulkoffline/",JSON.stringify(c)).done(l.bind(null,this,d)).fail(A.bind(null,d)),d.promise()};function k(a,b,c){a.saveOfflineData([c]).done(z.bind(null,b)).fail(A.bind(null,b))}function l(a,b,c){a.saveOfflineData(c).done(z.bind(null,b)).fail(A.bind(null,b))}
j.prototype.saveOfflineData=function b(c){var d=a.Deferred(),e=Object.resolve(f);return e.open().done(m.bind(null,this,d,c,e)).fail(d.reject.bind(d)),d.promise()};function m(b,c,e,f){for(var h=[],i=[],j=0;j<e.length;j++)if(e[j]){for(var k=e[j].offlineForms,l=e[j].offlineFormData.length>0?e[j].offlineFormData:d.fromJson(e[j].offlineFormData),m=0;m<k.length;m++)i.push(f.put(g,k[m]));if(l.length>0)for(var o=0;o<l.length;o++)i.push(n(b,l[o],f));else i.push(n(b,l,f));e.length>1?h.push([k,l]):h=[k,l]}var p=a.when.apply(b,i);p.done(z.bind(null,c,h)),p.fail(A.bind(null,c)),p.always(v.bind(null,f))}function n(b,c,d){var e=a.Deferred(),f=a.Deferred();return u(b,h,f,c.formKey,d,!1),f.done(o.bind(null,d,c,e)).fail(A.bind(null,e)),e.promise()}function o(a,b,c,e){var f=d.fromJson(e);if(!f)return void a.put(h,b).done(z.bind(null,c));for(var g=0;g<Object.keys(b.records).length;g++){for(var i=b.records[Object.keys(b.records)[g]],j=i.entityKey,k=!1,l=0;l<Object.keys(f.records).length;l++){
if(f.records[Object.keys(f.records)[l]].entityKey===j){f.records[Object.keys(f.records)[l]]=i,k=!0;break}}k===!0?a.put(h,f).done(p.bind(null,c)):(f.records[i.clientId]=i,a.put(h,f).done(p.bind(null,c)))}}function p(a){a.resolve()}j.prototype.saveOfflineFormForFamily=function b(c){var d=a.Deferred();return this.ajaxClient.post(i+"/offlineforms/",JSON.stringify(c)).done(q.bind(null,this,d)).fail(A.bind(null,d)),d.promise()};function q(a,b,c){a.saveOfflineForms(c).done(z.bind(null,b)).fail(A.bind(null,b))}j.prototype.saveOfflineForms=function b(c){var d=a.Deferred(),e=Object.resolve(f);return e.open().done(r.bind(null,this,d,c,e)).fail(d.reject.bind(d)),d.promise()};function r(b,c,d,e){for(var f=[],h=[],i=0;i<d.length;i++)if(d[i])for(var j=d[i].offlineForms,k=0;k<j.length;k++)h.push(e.put(g,j[k]));var l=a.when.apply(b,h);l.done(z.bind(null,c,f)),l.fail(A.bind(null,c)),l.always(v.bind(null,e))}j.prototype.deleteOfflineRecord=function b(c,d){var e=a.Deferred(),g=Object.resolve(f)
;return g.open().done(s.bind(null,this,e,c,d,g)).fail(e.reject.bind(e)),e.promise()};function s(b,c,d,e,f){var g=a.Deferred();u(b,h,g,d.formKey,f,!1),g.done(t.bind(null,b,f,e,c))}function t(a,b,c,e,f){var g=d.fromJson(f);delete g.records[c.clientId],b.put(h,g).done(z.bind(null,e)).always(v.bind(null,b))}j.prototype.getOfflineFormFromStorage=function b(c){var d=a.Deferred(),e=Object.resolve(f);return e.open().done(u.bind(null,this,g,d,c,e)).fail(d.reject.bind(d)),d.promise()};function u(a,b,c,d,e,f){e.get(b,d).done(z.bind(null,c)).always(v.bind(null,e,f))}function v(a,b){(b=b!==!0&&b!==!1||b)&&a.close()}j.prototype.getOfflineFormDataFromStorage=function b(c,d){var e=a.Deferred(),g=a.Deferred(),i=Object.resolve(f);return i.open().done(u.bind(null,this,h,g,c,i)).fail(g.reject.bind(g)),g.done(w.bind(null,e,d)).fail(A.bind(null,e)),e.promise()};function w(a,b,c){for(var e=d.fromJson(c),f=0;f<Object.keys(e.records).length;f++){var g=e.records[Object.keys(e.records)[f]]
;g.entityKey===b&&a.resolve(e,g)}}j.prototype.getAllOfflineDataFromStorage=function b(){var c=a.Deferred(),d=a.Deferred(),e=Object.resolve(f);return e.open().done(y.bind(null,this,h,d,e)).fail(d.reject.bind(d)),d.done(function(a){c.resolve(a)}).fail(A.bind(null,c)),c.promise()},j.prototype.getAllOfflineFormDataFromStorage=function b(){var c=a.Deferred(),d=a.Deferred(),e=Object.resolve(f);return e.open().done(y.bind(null,this,h,d,e)).fail(d.reject.bind(d)),d.done(x.bind(null,this,c)).fail(A.bind(null,c)),c.promise()};function x(a,c,e){var f=b.pluck("value")(e),g=d.fromJsonCollection(f);c.resolve(g)}function y(a,b,c,d){d.getAll(b).done(z.bind(null,c)).always(function(){a.storage.close()})}j.prototype.syncOfflineProofTest=function b(c){var d=a.Deferred();return this.ajaxClient.post(i+"/"+c.entityKey+"/offline",c).done(z.bind(null,this,d)).fail(A.bind(null,d)),d.promise()};function z(a,b){a.resolve(b)}function A(a,b){a.reject(b)}return j});