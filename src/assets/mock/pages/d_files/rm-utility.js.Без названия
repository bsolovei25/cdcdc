/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=Object.resolve(require("record-manager-v2/model/rm-state")),c=require("system/text/formatter"),d=require("logging/feedback-component/feedback-component"),e=require("record-manager-v2/model/rm-history"),f=require("record-manager-v2/model/rm-family"),g=11,h=require("knockout"),i=require("system/ui/dialog-view-model"),j=require("record-manager-v2/views/relationship-definition-selector-view-model"),k=require("record-manager-v2/model/rm-navigationEntity"),l=require("record-manager-v2/model/rm-entity"),m=require("system/ui/message-box"),n=require("application/application-context");function o(a){this.formatter=a}o.dependsOn=[c],o.prototype.computeIsBackDisabled=function a(c){return c.previousState()===b.states.INITIAL||1===c.navigationEntities().length&&c.previousState()===b.states.ENTITY_VIEW},o.prototype.handleRecordExplorerHeight=function a(){this.utility.setRecordExplorerHeight(this)},
o.prototype.setRecordExplorerHeight=function b(c){var d=c.region.$element.height(),e=a(".content-wrapper").height(),f=p()?43:69,g=58,h=0;c.navigationVisibility()&&c.region.$element.find(".entity-ids").each(function(){h+=a(this).height()});var i=p()?33:57,j=f+h+i,k,l=22;k=e-j,c.region.$element.find(".rm-datasheet-container").height(e),c.region.$element.find(".rm-related-families-list").css("height",k),c.region.$element.find(".rm-related-families").css("height",k)};function p(){return a("body").hasClass("tight")}o.prototype.abbreviateText=function b(c,d,e,f,h,i){var j=e||g,k=0,l,m,n,o="function"==typeof d?d():d;return f===!0&&c?(k=c.region.$element.find(".record-explorer").width()-45,"familyView"===h&&i&&(l=c.getRecordCount(null,i.relations.length),m=document.createElement("span"),m.className="dummy-span",m.innerHTML=" ("+l+")",n=a(document).find("body"),n.append(m),k-=a(m).width(),a(m).remove()),this.formatter.abbreviateByWidth(o,k,j)):this.formatter.abbreviate(o,j)},
o.prototype.setCollapsibleCaption=function b(c,d){c.collapsibleEl&&(a(c.collapsibleEl).find(".collapsed span")[0].setAttribute("title",d),c.collapsibleEl.setAttribute("caption",this.abbreviateText(c,d)))},o.prototype.toastSuccessMessage=function a(b,c){new d({closeButton:!0,timeOut:"2000",hideDuration:"1000"}).success(b,c)},o.prototype.saveHistory=function a(b){var c=Object.resolve(e,b);b.historyObj.push(c)},o.prototype.getHistory=function a(b){var c,d,e=b.historyObj.pop();c=b.navigationEntities().length,c>0&&(d=b.navigationEntities()[c-1],b.entityKey(d.key)),b.selectedFamily(Object.resolve(f,e)),b.relatedFamilies(e.relatedFamilies),b.allFamilies(e.allFamilies),b.navigationEntities(e.navigationEntities),b.relatedFamiliesCount(b.relatedFamilies().length),b.familiesOptions[0].text=b.relatedFamiliesCount()+" "+b.translate("RM_RELATED_FAMILIES"),b.canAdd=e.canAdd,b.relationshipGroup=e.relationshipGroup},o.prototype.checkIfExistsInHierarchy=function a(b,c){var d
;for(d=0;d<b.navigationEntities().length;d++)if(b.navigationEntities()[d].key.toString()===c.toString())return!0;return!1},o.prototype.collapseNavigation=function a(b){b.navigationVisibility(!b.navigationVisibility()),this.setRecordExplorerHeight(b)},o.prototype.setVisibility=function a(b){b.familyTreeVisibility=h.observable(!0),b.relationsVisibility=h.observable(!1),b.allPossibleFamiliesVisibility=h.observable(!1),b.familiesHeaderVisibility=h.observable(!0),b.navigationVisibility=h.observable(!0)},o.prototype.getUserPrivileges=function a(b){var c=b.selectedFamily().key(),d,e;if(b.userFamilyPrivileges){for(d=0;b.userFamilyPrivileges.privileges&&d<b.userFamilyPrivileges.privileges.length;d++)if(b.userFamilyPrivileges.privileges[d].familyKey.toString()===c.toString()){e=b.userFamilyPrivileges.privileges[d];break}b.isLinkRecordEnabled(b.userFamilyPrivileges.isSuperUser||e&&e.ins)}},o.prototype.getMasterDatasheetUserFamilyPrivileges=function a(b){
b.userFamilyPrivileges=b.datasheet.getUserFamilyPrivileges()},o.prototype.updateFieldsOnLoadingMDF=function a(b){var c,d=[];for(b.fields&&(d=Object.keys(b.fields)),c=0;c<d.length;c++)r(b,d[c],b.fields[d[c]]);b.fields=null},o.prototype.removeBinding=function a(b){b.datasheet.onMasterDatasheetLoaded.remove(b)},o.prototype.updateFields=function a(b){var c=[],d;for(c=Object.keys(b.fields),b.datasheet.onMasterDatasheetLoaded.add(this.updateFieldsOnLoadingMDF.bind(this,b),b),b.datasheet.datasheetManager.layout.datasheetChanged.add(this.removeBinding.bind(this,b),b),d=0;d<c.length;d++)r(b,c[d],b.fields[c[d]])},o.prototype.onReturningFromRelatedRecordsView=function a(b){b.recordManagerService.getHierarchy(b.entityKey()).done(s.bind(null,b,this)).fail(t.bind(null,b))},o.prototype.getCurrentFamily=function a(b){var c,d;for(d=0;d<b.allFamilies().length;d++)if(b.allFamilies()[d].familyKey.toString()===b.selectedFamily().key().toString()){c=b.allFamilies()[d];break}return c},
o.prototype.showSpinner=function a(b){b.region.$element.find("div.rm-datasheet-container").parent().prepend('<div class="load-spinner"><span class="loading-med loading-active center-block"></span></div>')},o.prototype.clearSpinner=function a(b){b.region.$element.find("div.rm-datasheet-container").parent().find(".load-spinner").remove()},o.prototype.attachCollapsible=function a(b){var c=this;b.collapsibleEl=b.region.$element.find("mi-collapsible")[0],window.CustomElements&&!window.CustomElements.useNative&&window.CustomElements.upgrade(b.collapsibleEl);var d=b.selectedEntity().id()||b.translate("RM_RECORD_EXPLORER");c.setCollapsibleCaption(b,d),b.region.$element.find(".record-explorer").on("click",function(){b.region.$element.find(".collapsed").hasClass("active")?(b.region.$element.find(".rm-datasheet-container").css("width","calc(100% - 40px)"),b.region.$element.find(".rm-datasheet-container").css("margin-left","40px"),b.region.$element.find(".record-explorer").css("width","40px"),
b.region.$element.find(".record-explorer").css("position","fixed")):b.region.$element.find(".expanded").hasClass("active")&&(b.region.$element.find(".rm-datasheet-container").css("width","calc(100% - 240px)"),b.region.$element.find(".rm-datasheet-container").css("margin-left","0px"),b.region.$element.find(".record-explorer").css("width","240px"),b.region.$element.find(".record-explorer").css("position","relative"))})},o.prototype.attachFamiliesMoreOptions=function a(b){b.familiesMoreOptions=b.region.$element.find(".families-options")[0],b.familiesMoreOptions.loader=b.setFamiliesOptions.bind(b),window.CustomElements&&!window.CustomElements.useNative&&window.CustomElements.upgrade(b.familiesMoreOptions),b.familiesMoreOptions.moreoptionsCB(this.familyMenuSelected.bind(null,b))},o.prototype.familyMenuSelected=function a(b,c){q(b,c.text),b.utility.familyOptionSelected(b,c.text)},o.prototype.familyOptionSelected=function a(b,c){b.region.$element.find(".rm-more-options-block").hide(),
b.region.$element.find(".parent-selected").removeClass("parent-selected"),c===b.translate("RM_ALL_FAMILIES")?(b.relationsVisibility(!1),b.familyTreeVisibility(!1),b.allPossibleFamiliesVisibility(!0),b.selectedFamilyOption(b.translate("RM_ALL_FAMILIES"))):(b.allPossibleFamiliesVisibility(!1),b.familyTreeVisibility(!0),b.relationsVisibility(!1),b.selectedFamilyOption(b.familiesOptions[0].text))},o.prototype.user=function a(){return n.user},o.prototype.getUserPref=function a(b){var c=this;b.recordManagerService.getPreference(c.user().key,"user-rm-family-menu").done(function(a){a&&a.value&&(b.userPrefMenu=a.value,c.familyOptionSelected(b,b.userPrefMenu))})},o.prototype.setUserPref=function a(b,c){var d=this,e={userKey:d.user().key,name:"user-rm-family-menu",prefType:9,value:c};b.recordManagerService.setPreference(e)};function q(a,b){b===a.translate("RM_ALL_FAMILIES")&&a.userPrefMenu!==b?(a.userPrefMenu=b,
a.utility.setUserPref(a,a.userPrefMenu)):"RELATED_FAMILY"!==a.userPrefMenu&&(a.userPrefMenu="RELATED_FAMILY",a.utility.setUserPref(a,a.userPrefMenu))}o.prototype.parentRecordSelection=function b(c,d,e,g){var h=c.region.$element;if(a(h).find(".rm-more-options-block").hide(),a(g.currentTarget).hasClass("parent-selected"))return c.relationsVisibility(!1),void a(h).find(".parent-selected").removeClass("parent-selected");c.selectedFamily(Object.resolve(f,e)),c.relationsVisibility(!0),a(h).find(".parent-selected").removeClass("parent-selected"),d||a(g.currentTarget).addClass("no-records"),a(g.currentTarget).addClass("parent-selected"),a(g.currentTarget).siblings(".rm-more-options-block").show();var i=a(g.currentTarget).siblings(".rm-more-options-block").find("mi-more-options-noko");c.utility.attachRecordsMoreOptions(c,i),c.familyTreeVisibility()&&c.previousState(c.stateObj.states.RELATED_FAMILIES_VIEW),
c.allPossibleFamiliesVisibility()&&c.previousState(c.stateObj.states.ALL_POSSIBLE_FAMILIES_VIEW),c.utility.saveHistory(c),c.utility.getUserPrivileges(c),e.canAdd===!1?c.canAdd=!1:c.canAdd=!0},o.prototype.attachBulkEntitiesHandlers=function a(b){b.datasheet.datasheetManager.onBulkEntitiesDeleted&&b.datasheet.datasheetManager.onBulkEntitiesUnlinked&&(b.datasheet.datasheetManager.onBulkEntitiesDeleted.add(A.bind(null,b)),b.datasheet.datasheetManager.onBulkEntitiesUnlinked.add(A.bind(null,b)))},o.prototype.loadSelectedEntity=function a(b,c){b.selectedEntity().key()!==c.key&&b.recordManagerService.getHierarchy(c.key).done(B.bind(null,b,c.key)).fail(t.bind(null,b))},o.prototype.recordOptionSelected=function a(b,c){c.noaccess||b.datasheet.unload().done(function a(){var d=b.selectedFamily().key();u(b,d,c).done(v.bind(null,b,d,c))})},o.prototype.reloadDatasheet=function a(b){b.relationshipDefinitionDTO=null,b.loadDatasheet(b.selectedEntity().key())},o.prototype.isPredecessor=function a(b,c,d){
return b.successor.familyKey===c.familyKey&&b.predecessor.key===d.entityKey()&&!d.utility.checkIfExistsInHierarchy(d,b.successor.key)},o.prototype.isSuccessor=function a(b,c,d){return b.predecessor.familyKey===c.familyKey&&b.successor.key===d.entityKey()&&!d.utility.checkIfExistsInHierarchy(d,b.predecessor.key)},o.prototype.addDummyNavigationEntity=function a(c){var d=c.familykey()?c.familykey():c.selectedFamily().key(),e={id:c.translate("RM_NEW_RECORD"),key:0,familyId:"",familyCaption:c.selectedFamily().name(),familyKey:d,caption:""},f,g;f=Object.resolve(k,e),""!==c.familykey()&&0!==c.navigationEntities().length||c.navigationEntities.push(f),c.relatedFamilies([]),c.allFamilies([]),c.familiesOptions[0].text="0 "+c.translate("RM_RELATED_FAMILIES"),c.utility.familyOptionSelected(c,c.familiesOptions[0]),c.familiesHeaderVisibility(!0),c.selectedEntity(Object.resolve(l,f)),c.previousState(b.states.ENTITY_VIEW),g=f.id(),c.utility.setCollapsibleCaption(c,g),c.utility.saveHistory(c),
c.region.$element.find("mi-associated-pages").hide(),c.recommHasValue(!1)},o.prototype.setDummyNavigationEntityFamilyCaption=function a(b){var c=b.navigationEntities()[b.navigationEntities().length-1],d="";0!==c.key||c.familyCaption()||(b.datasheet.datasheetManager.entity?d=b.datasheet.datasheetManager.entity.familyCaption:b.datasheet.datasheetManager.entityObj&&(d=b.datasheet.datasheetManager.entityObj.familyCaption),c.familyCaption(d))},o.prototype.showRecommendation=function a(b,c){var d=this;b.recordManagerService.getRecommendationFamily(c).done(function(a){var e="MI_EQUIP000"===a.familyId||"MI_FNCLOC00"===a.familyId?c:"";a.recommendationFamilyId?(d.recommdconfig={recommendationFamilyID:a.recommendationFamilyId,parentKey:c,parentRelationshipID:"MI Has Recommendations",analysisKey:"",analysisID:"",analysisRelationshipID:"",assetKey:e,assetRelationshipID:"MI Has Recommendations",riskAssessmentRelationshipID:"MIR_MITRISK",autoExpand:!1,editMode:!0,autoCreateMitigatedRisk:!1,
isAnalysisLevel:!0,allowAdd:!0,archivedRecStates:["MI_SUPERSEDED","MI_CONSOLIDATED","MI_REJECTED","MI_APPROVED","MI_REJECTED","MI_ACCEPTED","MI_IMPLEMENTED"],userPermission:{canDeleteRecommendation:!1,canEditRecommendation:!1},sourceModuleName:"",isStrategicRec:!1,performanceFilterStates:[{name:"Reviewed",value:"MI_REVIEWED"}],defaultRecFilterSelectedValues:"All",perfFilterTypes:""},d.RecommendationControl=b.region.element.querySelector("mi-recommendation"),Element.upgrade(d.RecommendationControl),d.RecommendationControl.load(d.recommdconfig),d.RecommendationControl.events.recommendationCreated.remove(),d.RecommendationControl.events.recommendationCreated.add(b.refreshHierarchyOnRecommdSave.bind(null,b)),b.recommHasValue(!0)):b.recommHasValue(!1)}).fail(t.bind(null,b))},o.prototype.attachRecordsMoreOptions=function b(c,d){c.recordsMoreOptions=a(d)[0],c.recordsMoreOptions.loader=c.setRecordOptions.bind(c),
window.CustomElements&&!window.CustomElements.useNative&&window.CustomElements.upgrade(c.recordsMoreOptions),c.recordsMoreOptions.moreoptionsCB(c.utility.recordOptionSelected.bind(null,c))};function r(a,b,c){/\[([A-Z]|[a-z]|[0-9]|\_|\s)*\]/.test(c)&&(c=c.toUpperCase(),c=c.replace(/\[/,"").replace(/\]/,""),c=a.datasheet.datasheetManager.entity.fields.get(c).attributes.value),b=b.toUpperCase(),a.datasheet.datasheetManager.entity.updateField(b,"value",c)}function s(a,b,c){var d;a.relatedFamilies(a.getRelatedFamilies(c.relationshipGroup)),a.relatedFamiliesCount(a.relatedFamilies().length),a.allFamilies(a.getAllFamilies(c.relationshipGroup)),a.relationshipGroup=c.relationshipGroup,d=b.getCurrentFamily(a),a.selectedFamily().relations(d.relations),a.historyObj.pop(),b.saveHistory(a)}function t(a,b){m.showOk(b+" "+a.translate("RM_CLOSE_TAB_MESSAGE"),a.translate("RM_ALERT_TITLE"),"icon-exclamation-in-circle")}function u(b,c,d){var e,f,g,h,k,l=a.Deferred(),m=[],n,o,p=""
;for(b.relationshipDefinitionDTO=null,e=0;e<b.relationshipGroup.length;e++)if(g=b.relationshipGroup[e],g.entityFamilyKey.toString()===c.toString()){if(n=g.relationshipDefinitions,n.length>1){for(d.text===b.translate("RM_MANAGE_RECORDS")&&(p="Manage Records"),k=Object.resolve(j,p),f=0;f<n.length;f++)o=n[f],y(m,o)||(o.relationship=null,m.push(o));w(b,m,c),k.relationshipDefinitions(m),h=new i(k,b.translate("RM_REL_DEF_DIALOG_TITLE"),{height:300,width:400}),h.show(),k.onLink.add(z.bind(null,b,h,l))}else b.relationshipDefinitionDTO=n[0],l.resolve();break}return l}function v(a,b,c){var d,e=[];if(null!==a.relationshipDefinitionDTO)if(c.text===a.translate("RM_ADD_RECORD")){var f=a.navigationEntities()[a.navigationEntities().length-1],g=!0;g=a.relationshipDefinitionDTO.predEntyFamilyKey===f.familyKey,a.loadRelatedFamily(f.key,b,a.relationshipDefinitionDTO.relationshipFamilyKey,g).done(function(){a.utility.addDummyNavigationEntity(a),a.utility.setDummyNavigationEntityFamilyCaption(a),
a.datasheet.entitySaved.add(a.saveEntity.bind(null,a)),a.utility.attachBulkEntitiesHandlers(a)})}else if(c.text===a.translate("RM_LINK_RECORD")){var h=[null];a.datasheet&&"0"!==a.datasheet.datasheetManager.entity.siteKey&&h.push(a.datasheet.datasheetManager.entity.siteKey);var i={multiSelect:!0,selectRelated:!1,families:[b.toString()],defaultFamily:b.toString(),entityKeys:e,exactFamilyMatch:!0,siteKeys:h};"OneToOne"===a.relationshipDefinitionDTO.cardinality&&(i.multiSelect=!1,i.hasRelationship=!1),("OneToMany"===a.relationshipDefinitionDTO.cardinality&&a.relationshipDefinitionDTO.predEntyFamilyKey===b||"ManyToOne"===a.relationshipDefinitionDTO.cardinality&&a.relationshipDefinitionDTO.succEntyFamilyKey===b)&&(i.multiSelect=!1),("OneToMany"===a.relationshipDefinitionDTO.cardinality&&a.relationshipDefinitionDTO.succEntyFamilyKey===b||"ManyToOne"===a.relationshipDefinitionDTO.cardinality&&a.relationshipDefinitionDTO.predEntyFamilyKey===b)&&(i.hasRelationship=!1),
a.finder.show(i).done(a.finderResults.bind(null,a,!0)).fail(a.utility.reloadDatasheet.bind(null,a))}else c.text===a.translate("RM_MANAGE_RECORDS")&&a.handleManageAllRecords()}function w(a,b,c){var d,e,f=[],g;for(d=0;d<b.length;d++)if(f=x(b,b[d].relationshipFamilyKey),f.length>1)for(e=0;e<f.length;e++)g=b[f[e]],g.isPred?g.relationship=a.translate("RM_SUCCESSOR"):g.relationship=a.translate("RM_PREDECESSOR")}function x(a,b){var c,d=[];for(c=0;c<a.length;c++)a[c].relationshipFamilyKey===b&&d.push(c);return d}function y(a,b){var c;for(c=0;c<a.length;c++)if(a[c].relationshipDefinitionKey===b.relationshipDefinitionKey)return b.predEntyFamilyKey!==b.succEntyFamilyKey;return!1}function z(a,b,c,d){"Close"!==d?a.relationshipDefinitionDTO=d:(a.relationshipDefinitionDTO=null,a.loadDatasheet(a.selectedEntity().key())),b.closeDialog(),c.resolve()}function A(a){a.recordManagerService.getHierarchy(a.entityKey()).done(a.onSavingMDF.bind(null,a)).fail(t.bind(null,a))}function B(a,b){var c,d
;c=a.selectedEntity().id()||a.translate("RM_RECORD_EXPLORER"),a.utility.setCollapsibleCaption(a,c),a.loadDatasheet(b,null),a.utility.saveHistory(a)}return o});