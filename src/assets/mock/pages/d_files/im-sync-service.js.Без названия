/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("lodash"),c=require("../services/im-offline-service"),d=require("platform/offline-forms/layout/adapters/offline-record-json-adapter"),e=require("system/http/ajax-client"),f=require("../ui/im-events"),g=require("../services/dtos/offline-family-data"),h=require("../services/dtos/offline-inspection-sync-dto"),i=require("bluebird"),j="api/internal/mi/im/inspections";function k(){this.imOfflineService=Object.resolve(c),this.ajaxClient=Object.resolve(e),this.imEvents=Object.resolve(f),this.isExecuting=!1,this.serverInspectionRecords=[]}k.singleton=!0,k.prototype.execute=function(){var b=this,c=a.Deferred();return this.isExecuting===!1&&(this.isExecuting=!0,this.getRecordsToSync().then(n.bind(null,this,c)).always(l.bind(null,this))),c.promise()};function l(a){a.isExecuting=!1}k.prototype.getRecordsToSync=function b(){var c=a.Deferred()
;return this.imOfflineService.getAllOfflineFormDataFromStorage().done(m.bind(null,this,c)),c.promise()};function m(a,b,c){for(var d=c,e=[],f=0;f<d.length;f++)for(var g=Object.keys(d[f].records).length,i=0;i<g;i++){var j=d[f].records[Object.keys(d[f].records)[i]];if("SYNC_PENDING"===j.syncStatus){var k=new h;k.formData=d[f],k.record=j,e.push(k)}}b.resolve(e)}function n(a,c,e){if(e&&0!==e.length){a.serverInspectionRecords=[];for(var f=0;f<e.length;f++)a.serverInspectionRecords.push(d.toServerObject(e[f].record)),e[f].record.syncStatus="SYNCING",e[f].formData.records[e[f].record.clientId]=e[f].record;var h=b.uniq(b.map(e,"formData"));return a.imOfflineService.saveOfflineData([new g(h)]).done(o.bind(null,a,c,a.serverInspectionRecords,e)),c.promise()}}function o(a,b,c,d){a.imEvents.inspectionSyncStatusChanged.raise(),a.ajaxClient.post(j+"/offline",{inspectionRecords:c}).done(p.bind(null,a,b,d)).fail(z.bind(null,b))}function p(a,b,c,d){var e=d.length;r(c),q(a,b,c,d,0)}function q(a,b,c,d,e){
s(a,c,d,e,b)}function r(a){for(var b=0;b<a.length;b++){var c=a[b].record;c.errors=null;for(var d=0;d<c.relatedRecords.length;d++)for(var e=c.relatedRecords[d],f=Object.keys(e.records).length,g=0;g<f;g++){var h=e.records[Object.keys(e.records)[g]];h.errors=null}}}function s(a,b,c,d,e){for(var f=c[d],h=f.entityKey,j=!1,k=0;k<b.length;k++){var l=b[k].record;if(h===l.entityKey){if(f.errors&&f.errors.length>0&&(l.errors=f.errors,j=!0),j=w(f.relatedRecordErrors,l,j))l.syncStatus="SYNC_COMPLETE_W_ERRORS",a.imOfflineService.saveOfflineData([new g(b[k].formData)]).done(x.bind(null,a,e,b,c,d));else{var m=[];l.pictureCount&&l.pictureCount>0&&m.push(l.clientId),m.push.apply(m,a.imOfflineService.getClientIdsForRelatedRecords(l)),i.each(m,t.bind(null,a,f.clientIDKeyMappings)).then(v.bind(null,a,b,e,l,c,d,k))}break}}}function t(b,c,d,e,f){console.log("syncPicturesForClientId called");var g=a.Deferred();return b.imOfflineService.getPicturesFromStorage(d).done(u.bind(null,b,d,c,g)),g.promise()}
function u(a,c,d,e,f){console.log("sendPicturesToServer called");var g=b.find(d,{clientID:c});f||e.resolve(),g?a.imOfflineService.syncPicture(g.entityKey,f.pictures).done(e.resolve.bind(e)):e.resolve()}function v(a,b,c,d,e,f,g){console.log("cleanUpInspections called"),a.imOfflineService.deleteOfflineRecord(b[g].formData,b[g].record).done(x.bind(null,a,c,b,e,f)),delete b[g].formData.records[d.clientId]}function w(a,b,c){for(var d=0;d<a.length;d++){for(var e=a[d],f=0;f<b.relatedRecords.length;f++){var g=b.relatedRecords[f];if(g.familyKey===e.familyKey){for(var h=Object.keys(g.records).length,i=0;i<h;i++){var j=g.records[Object.keys(g.records)[i]];if(j.clientId===e.clientID){j.errors=e.errors;break}}break}}c=!0}return c}function x(a,b,c,d,e){a.imEvents.inspectionSyncStatusChanged.raise(),e<d.length-1?(e++,q(a,b,c,d,e)):b.resolve()}function y(a,b){a.resolve(b)}function z(a,b){a.reject(b)}return k});