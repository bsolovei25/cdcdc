/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict"
;var a=require("lodash"),b=require("jquery"),c=require("knockout"),d=require("spa/ko/knockout-view-model"),e=require("text!./record-manager.html"),f=require("platform/datasheets/datasheet"),g=require("text!platform/datasheets/layout/ui/views/spinner.html"),h=require("application/application-events"),i=require("record-manager-v2/services/record-manager-service"),j=require("platform/entity/entity-factory"),k=require("search/search-finder"),l=require("system/globalization/translator"),m=require("application/application-context"),n=require("record-manager-v2/model/rm-entity"),o=require("record-manager-v2/model/rm-family"),p=require("record-manager-v2/model/rm-navigationEntity"),q=Object.resolve(require("record-manager-v2/model/rm-state")),r=require("platform/datasheets/master-detail-datasheet-manager"),s=require("system/ui/message-box"),t=require("spa/conductor"),u=require("spa/region"),v=require("platform/datasheets/layout/ui/bdf-view-model"),w=require("record-manager-v2/views/rm-utility"),x=require("system/error/error-message"),y=require("record-manager-v2/rm-events"),z=require("system/ui/unsaved-changes-message-box"),A=!1,B
;require("ui/elements/collapsible/collapsible-element"),require("ui/elements/more-options/more-options"),require("ui/elements/associated-pages/associated-pages");function C(a,d){var f=this,g;D.call(f,e),f.entityKey=c.observable(""),f.familykey=c.observable(""),f.datasheetid=c.observable(""),f.isLinkRecordEnabled=c.observable(!0),f.recordManagerService=d,f.assetContextKey=m.assetcontext.entityKey,f.relatedFamiliesCount=c.observable(""),f.relatedFamilies=c.observableArray(),f.navigationEntities=c.observableArray(),f.selectedEntity=c.observable(Object.resolve(n)),f.selectedFamily=c.observable(Object.resolve(o)),f.utility=Object.resolve(w),f.utility.setVisibility(f),f.allFamilies=c.observableArray(),f.historyObj=[],f.datasheet=null,f.translator=Object.resolve(l),f.selectedFamilyOption=c.observable(f.translate("RM_RELATED_FAMILIES")),f.assocFamilyKey=c.observable(""),f.previousState=c.observable(q.states.INITIAL),f.isBackDisabled=c.computed(f.utility.computeIsBackDisabled.bind(null,f)),
f.finder=new k,f.conductor=Object.resolve(t),f.entityFactory=Object.resolve(j),f.showAllRecordsVisible=c.computed(F.bind(null,f)),f.appEvents=a,f.setFamiliesOptions(),f.setRecordOptions(),f.selectedEntity.subscribe($.bind(null,f)),f.rmEvents=Object.resolve(y),g=b(".top-nav-main-tabs-group li a"),B=g.width()-g.find("i").width(),f.isSuperUser=null,f.stateObj=q,f.recommHasValue=c.observable(!1),f.refDocEl=null,f.rootEntityKey=null,f.userPrefMenu=null}var D=Object.inherit(d,C);C.dependsOn=[h,i],C.prototype.attach=function a(b){D.prototype.attach.call(this,b),this.region=b,this.isSuperUser=m.user.isSuperUser,this.hasLoadedEntityDatasheet&&this.selectedEntity()&&this.selectedEntity().key()&&this.loadDatasheet(this.selectedEntity().key(),this.frombulk?null:this.cachedEntity),this.hasLoadedFamilyDatasheet&&this.selectedFamily()&&this.selectedFamily().key()&&this.loadDatasheetByFamily(this.selectedFamily().key(),this.cachedEntity).done(function(a){
a.datasheet&&(a.datasheet.entitySaved.add(a.saveEntity.bind(null,a)),a.utility.attachBulkEntitiesHandlers(a))}.bind(null,this)),this.utility.attachCollapsible(this),this.utility.attachFamiliesMoreOptions(this),this.utility.getUserPref(this),""!==this.familykey()&&(this.collapsibleEl.hide(),this.utility.addDummyNavigationEntity(this),this.loadDatasheetByFamily(this.familykey(),this.cachedEntity).done(function(a){a.datasheet&&(a.utility.setDummyNavigationEntityFamilyCaption(a),a.datasheet.entitySaved.add(a.saveEntity.bind(null,a)),a.datasheet.entityIdChanged.add(wa.bind(null,a)))}.bind(null,this)),this.region.$element.find(".rm-datasheet-container").css("width","calc(100% - 40px)"),this.region.$element.find(".rm-datasheet-container").css("margin-left","40px"),this.region.$element.find(".record-explorer").css("width","40px"),this.region.$element.find(".record-explorer").css("position","fixed")),
this.appEvents&&this.appEvents.layoutChanged&&this.appEvents.layoutChanged.add(this.utility.handleRecordExplorerHeight,this)},C.prototype.detach=function a(b){D.prototype.detach.call(this,b),this.datasheet&&(this.refDocEl=this.datasheet.getRefDocState(),this.cachedEntity=this.datasheet.getState(),this.frombulk=null),this.datasheet=null,this.appEvents&&this.appEvents.layoutChanged&&this.appEvents.layoutChanged.remove(this.utility.handleRecordExplorerHeight,this)},C.prototype.load=function a(b,c){if(b.frombulk)return this.frombulk=!0,this.relationshipDefinitionDTO=null,this.utility.onReturningFromRelatedRecordsView(this),void this.relationsVisibility(!1);if(b.entitykey){if(isNaN(b.entitykey)){var d=this.translate("RM_INVALID_ENTITY_KEY")+" '"+b.entitykey+"' "+this.translate("RM_KEY_NOT_FOUND")+" "+this.translate("RM_CLOSE_TAB_MESSAGE");return void s.showOk(d,this.translate("RM_ALERT_TITLE"),"icon-exclamation-in-circle")}this.entityKey(b.entitykey),this.loadRecordManagerDetails()}
b.familykey&&!b.entitykey&&this.familykey(b.familykey),b.datasheetid&&this.datasheetid(b.datasheetid),c&&(this.fields=c,delete this.fields.__isQueryString__)},C.prototype.canUnload=function a(){var c=b.Deferred();return this.datasheet?this.datasheet.unload().done(sa.bind(null,c)):ua(this)||va(this)?s.showUnsavedChanges().done(E.bind(null,this,this.cachedEntity,c)).fail(ta.bind(null,c)):sa(c),c};function E(a,b,c,d){1===d?a.entityFactory.save(b).done(sa.bind(null,c)).fail(ta.bind(null,c)):sa(c)}C.prototype.showSpinner=function a(){this.region&&this.region.$element.find("div.rm-datasheet-container").parent().prepend(g)},C.prototype.clearSpinner=function a(){this.region&&this.region.$element.find("div.rm-datasheet-container").parent().find(".load-spinner").remove()},C.prototype.translate=function a(b){return this.translator.translate(b)},C.prototype.loadRecordManagerDetails=function a(){
this.recordManagerService.getHierarchy(this.entityKey()).done(Y.bind(null,this)).fail(ra.bind(null,this))},C.prototype.navigationClicked=function a(b){var c=this;c.relationshipDefinitionDTO=null,c.datasheetid(""),c.datasheet.unload().done(N.bind(null,c,b))},C.prototype.getRelatedFamilies=function b(c){var d=[],e=this;return a.each(c,K.bind(null,e,d)),d},C.prototype.getAllFamilies=function b(c){var d=[],e=this;return a.each(c,L.bind(null,e,d)),d},C.prototype.loadDatasheet=function a(b,c){var d=this,e={containerEl:d.region.$element.find("div.rm-datasheet-container"),datasheetkey:d.datasheetid(),entityObj:b,assetContextKey:d.assetContextKey,scrollEl:".rm-datasheet-container"},g={functionsavailable:["save","new","delete","references","history","copy","state","rootRecord","unlinkRecord"],readOnly:!1,canedit:!0,loadedfrommodule:!1,loadedfromrecordmanager:!0};A&&(g.readOnly=!1,A=!1),
d.rootEntityKey&&d.rootEntityKey.toString()!==b.toString()||(g.functionsavailable.splice(g.functionsavailable.indexOf("rootRecord"),1),g.functionsavailable.splice(g.functionsavailable.indexOf("unlinkRecord"),1)),d.datasheet=new f(e),c&&d.datasheet.updateState(c),d.refDocEl&&(d.datasheet.updateRefDocState(d.refDocEl),d.refDocEl=null),d.datasheet.load(g).done(P.bind(null,d))},C.prototype.loadDatasheetByFamily=function a(c,d){var e=this,g=b.Deferred(),h={containerEl:e.region.$element.find("div.rm-datasheet-container"),familykey:c,assetContextKey:e.assetContextKey,scrollEl:".rm-datasheet-container"},i={loadedfromrecordmanager:!0,loadedfrommodule:!1};return e.datasheet=new f(h),d&&e.datasheet.updateState(d),e.datasheet.load(i).done(X.bind(null,e,c,g)),g},C.prototype.loadRelatedFamily=function a(c,d,e,f){var g=this,h=b.Deferred();return g.recordManagerService.newRelation(e,c,d,f).done(fa.bind(null,g,d,h)).fail(ea.bind(null,null,g,!0)),h},C.prototype.selectFamily=function a(b,c,d){
b.relationsVisibility(!0),b.familyTreeVisibility()&&b.previousState(q.states.RELATED_FAMILIES_VIEW),b.allPossibleFamiliesVisibility()&&b.previousState(q.states.ALL_POSSIBLE_FAMILIES_VIEW),b.allPossibleFamiliesVisibility(!1),b.selectedFamily(Object.resolve(o,c)),b.utility.getUserPrivileges(b),c.canAdd===!1?b.canAdd=!1:b.canAdd=!0,b.utility.saveHistory(b),b.showAllRecordsVisible()&&b.utility.setRecordExplorerHeight(b)},C.prototype.selectRelation=function a(b,c){var d=this;d.datasheetid(""),d.datasheet.unload().done(M.bind(null,d,b))},C.prototype.setFamiliesOptions=function a(){var c=b.Deferred();return this.familiesOptions?(c.resolve(this.familiesOptions),c):(this.familiesOptions=[{type:"text",text:this.translate("RM_RELATED_FAMILIES"),icon:""},{type:"text",text:this.translate("RM_ALL_FAMILIES"),icon:""}],c.resolve(this.familiesOptions),c)},C.prototype.setRecordOptions=function a(){var c=b.Deferred();return this.recordOptions=[{type:"text",text:this.translate("RM_ADD_RECORD"),
icon:"icon-plus",disabled:!1},{type:"text",text:this.translate("RM_LINK_RECORD"),icon:"icon-link",disabled:!1},{type:"text",text:this.translate("RM_MANAGE_RECORDS"),icon:"icon-table-view",disabled:!1}],void 0!==this.canAdd&&(this.canAdd===!1?(this.recordOptions[0].disabled=!0,this.recordOptions[1].disabled=!0):(this.recordOptions[0].disabled=!1,this.recordOptions[1].disabled=!1)),this.isLinkRecordEnabled()||(this.recordOptions[0].noaccess=!0,this.recordOptions[1].noaccess=!0),0===this.selectedFamily().relations().length?this.recordOptions[2].disabled=!0:this.recordOptions[2].disabled=!1,c.resolve(this.recordOptions),c},C.prototype.loadEntityDatasheet=function a(c,d,e){var f=this,g=f.region.$element;b(g).find(".rm-nav-list-group .active").removeClass("active"),b(g).find(".record-active").removeClass("record-active"),b(e.currentTarget).addClass("record-active"),f.datasheet.unload().done(f.utility.loadSelectedEntity.bind(null,f,c))};function F(a){
return a.selectedFamily().relations().length>100}C.prototype.getRecordCount=function a(b,c){return c>100?"100+":c};function G(a,b){a.appEvents.navigate.raise("record-manager/"+b.key,{tab:!0})}function H(a,b){var c=a.translate("RM_UNLINK_RECORD_TITLE"),d=a.translate("RM_UNLINK_RECORD_MESSAGE");s.showYesNo(d,c,"icon-alert").done(I.bind(null,a,b))}function I(a,b,c){var d=null;0===c&&(d=a.navigationEntities()[a.navigationEntities().length-1],d.id()===b.id&&(d=a.navigationEntities()[a.navigationEntities().length-2]),a.recordManagerService.unlinkRecords(b.key,d.key).done(J.bind(null,a,b)))}function J(a,b){var c,d,e;d=a.navigationEntities()[a.navigationEntities().length-1],d.id()===b.id&&(d=a.navigationEntities()[a.navigationEntities().length-2]),N(a,d).done(function(){var b=a.region.$element.find(".rm-current-family-relations").has("li:visible");if(b.length>0){b.siblings(".rm-more-options-block").show(),b.siblings(".list-data-block").addClass("parent-selected")
;var c=b.siblings(".rm-more-options-block").find("mi-more-options-noko");a.utility.attachRecordsMoreOptions(a,c)}})}function K(a,b,c,d){var e=[],f;if(c.relationsCount>0){for(f=0;f<c.relationshipDefinitions.length;f++)c.relationshipDefinitions[f].relations.length>0&&(e=e.concat(c.relationshipDefinitions[f].relations));for(f=0;f<e.length;f++)(e[f].predecessor.key.toString()===a.entityKey().toString()&&a.utility.checkIfExistsInHierarchy(a,e[f].successor.key)||e[f].successor.key.toString()===a.entityKey().toString()&&a.utility.checkIfExistsInHierarchy(a,e[f].predecessor.key))&&(e.splice(f,1),f--);e.length>0&&b.push({familyKey:c.entityFamilyKey,familyName:c.entityFamilyCaption,relations:e,canAdd:c.canAdd})}}function L(a,b,c,d){var e=[],f;for(f=0;f<c.relationshipDefinitions.length;f++)e=e.concat(c.relationshipDefinitions[f].relations)
;for(f=0;f<e.length;f++)(e[f].predecessor.key.toString()===a.entityKey().toString()&&a.utility.checkIfExistsInHierarchy(a,e[f].successor.key)||e[f].successor.key.toString()===a.entityKey().toString()&&a.utility.checkIfExistsInHierarchy(a,e[f].predecessor.key))&&(e.splice(f,1),f--);b.push({familyKey:c.entityFamilyKey,familyName:c.entityFamilyCaption,relations:e,canAdd:c.canAdd})}function M(a,b){a.selectedEntity().key()!==b.key&&(a.previousState(q.states.ENTITY_VIEW),a.selectedEntity(Object.resolve(n,b)),a.entityKey(b.key),a.recordManagerService.getHierarchy(a.entityKey()).done(aa.bind(null,a,!1,null)).fail(ra.bind(null,a)))}function N(a,c){if(0===c.key)return void a.loadDatasheetByFamily(c.familyKey,null).done(function(){a.datasheet.entitySaved.add(a.saveEntity.bind(null,a)),a.utility.attachBulkEntitiesHandlers(a)});var d=a.navigationEntities().length,e,f=b.Deferred();for(a.previousState(q.states.ENTITY_VIEW),a.selectedEntity(Object.resolve(n,c)),a.entityKey(c.key),
e=d-1;e>-1&&a.navigationEntities()[e].key.toString()!==c.key.toString();e--)a.navigationEntities.pop();var g=a.historyObj.length;for(e=g-1;e>-1&&(c.key.toString()!==a.historyObj[e].entityKey.toString()||c.familyCaption!==a.historyObj[e].familyName);e--)a.historyObj.pop();return a.recordManagerService.getHierarchy(a.entityKey()).done(O.bind(null,a,f)).fail(ra.bind(null,a)),f}function O(a,c,d){var e=b.Deferred();aa(a,!0,e,d),e.done(function(){a.historyObj.pop(),c.resolve()})}function P(b){b.rmEvents.rmDatasheet.raise(b.datasheet),b.hasLoadedEntityDatasheet=!0,b.hasLoadedFamilyDatasheet=!1,b.utility.setRecordExplorerHeight(b),a.defer(function(){b.datasheet&&(b.userFamilyPrivileges=b.datasheet.getUserFamilyPrivileges(),b.datasheet.onMasterDatasheetLoaded.add(Q.bind(null,b)),b.datasheet.datasheetManager.entity&&(b.assocFamilyKey(b.datasheet.datasheetManager.entity.familyKey),b.selectedEntity().id()!==b.datasheet.datasheetManager.entity.id&&ma(b,b.datasheet.datasheetManager.entity)),R(b))})}
function Q(a){a.utility.getMasterDatasheetUserFamilyPrivileges(a)}function R(a){a.datasheet.entityDeleted.add(qa.bind(null,a)),a.datasheet.entitySaved.add(a.saveEntity.bind(null,a)),a.datasheet.datasheetManager.makeRootRecordEvent.add(G.bind(null,a)),a.datasheet.datasheetManager.unlinkRecordEvent.add(H.bind(null,a)),a.datasheet.tabSwitched()&&a.datasheet.tabSwitched().add(ca.bind(null,a)),a.datasheet.datasheetManager.refDocsSet.add(S.bind(null,a)),a.utility.attachBulkEntitiesHandlers(a),a.datasheet.switchDatasheetManager.add(T.bind(null,a)),a.datasheet.newDatasheet.add(W.bind(null,a)),a.datasheet.entityIdChanged.add(wa.bind(null,a))}function S(a){a.datasheet.datasheetManager.refDocs.refDocsUpdated.add(U.bind(null,a))}function T(a){a.datasheet.datasheetManager.makeRootRecordEvent.add(G.bind(null,a)),a.datasheet.datasheetManager.unlinkRecordEvent.add(H.bind(null,a)),a.datasheet.datasheetManager.refDocsSet.add(S.bind(null,a))}function U(a){
a.recordManagerService.getHierarchy(a.entityKey()).done(V.bind(null,a)).fail(ra.bind(null,a))}function V(a,b){a.relatedFamilies(a.getRelatedFamilies(b.relationshipGroup)),a.relatedFamiliesCount(a.relatedFamilies().length),a.allFamilies(a.getAllFamilies(b.relationshipGroup)),a.familiesOptions[0].text=a.relatedFamiliesCount()+" "+a.translate("RM_RELATED_FAMILIES"),a.utility.familyOptionSelected(a,a.userPrefMenu),a.familiesHeaderVisibility(!0),a.relationshipGroup=b.relationshipGroup,a.utility.saveHistory(a)}function W(a,b){b&&a.appEvents.navigate.raise("record-manager/0/"+b,{tab:!0})}function X(a,b,c){var d,e;a.rmEvents.rmDatasheet.raise(a.datasheet),a.hasLoadedEntityDatasheet=!1,a.hasLoadedFamilyDatasheet=!0,a.utility.setRecordExplorerHeight(a),a.datasheet&&(a.datasheet.newDatasheet.add(W.bind(null,a)),
a.datasheet.datasheetManager.layout&&a.datasheet.entity&&"0"===a.datasheet.entity.siteKey&&"0"===a.datasheet.datasheetManager.layout.siteKey()&&a.datasheet.datasheetManager.layout.siteKey(null),a.datasheet.onMasterDatasheetLoaded.add(Q.bind(null,a)),a.fields&&!a.cachedEntity&&a.utility.updateFields(a)),c.resolve()}function Y(a,b){var c;a.clearSpinner(),c=Z(a,b.rootEntity.id),a.selectedEntity(Object.resolve(n,b.rootEntity)),a.rmEvents.titleChanged.raise(c),a.entityKey(b.rootEntity.key),aa(a,!1,null,b)}function Z(a,b){return a.utility.formatter.abbreviateByWidth(b,B-4,4)}function $(a,b){_(a,b.id()),a.selectedEntity().key()}function _(a,b){a.utility.setCollapsibleCaption(a,b)}function aa(a,b,c,d){var e,f;if(e=a.selectedEntity().id()||a.translate("RM_RECORD_EXPLORER"),a.utility.setCollapsibleCaption(a,e),a.loadDatasheet(a.entityKey(),null),a.relatedFamilies(a.getRelatedFamilies(d.relationshipGroup)),a.relatedFamiliesCount(a.relatedFamilies().length),
a.allFamilies(a.getAllFamilies(d.relationshipGroup)),a.familiesOptions[0].text=a.relatedFamiliesCount()+" "+a.translate("RM_RELATED_FAMILIES"),a.utility.familyOptionSelected(a,a.userPrefMenu),a.familiesHeaderVisibility(!0),a.relationshipGroup=d.relationshipGroup,b||(0===a.navigationEntities().length&&(a.rootEntityKey=d.rootEntity.key),f=Object.resolve(p,d.rootEntity),a.navigationEntities.push(f)),a.utility.saveHistory(a),c)return c.resolve(),c}C.prototype.handleManageAllRecords=function a(){var b=this,c=[],d,e,f,g,h,i,j,k,l=b.selectedFamily().relations();if(b.bdfVM=new v(b.appEvents),l.length>0)for(j=l[0].successor&&l[0].successor.familyID,k=0;k<l.length;k++)l[k].predecessor.key.toString()===b.entityKey().toString()?(e=l[k].predecessor.key,f=l[k].predecessor.id(),g=!0,j=l[k].successor&&l[k].successor.familyID):l[k].successor.key.toString()===b.entityKey().toString()&&(e=l[k].successor.key,f=l[k].successor.id(),g=!1,j=l[k].predecessor&&l[k].predecessor.familyID),h=l[k].familyKey
;i=b.relationshipDefinitionDTO.relationshipFamilyID,b.recordManagerService.getRelatedEntityKeys(b.entityKey(),i,b.relationshipDefinitionDTO.isPred,j).then(function(a){if(c=a,c.length>0)return d={module:"record-manager",bulkKeys:c,parentKey:e,parentID:f,isSucc:g,relFamilyKey:h,canAdd:b.relationshipDefinitionDTO.canAdd,screen:b.region.screen,familyKey:b.selectedFamily().key()},void b.conductor.changeScreen(b.bdfVM,b.region,{positional:[d]})})},C.prototype.showAllRecords=function a(){var b={type:"text",text:this.translate("RM_MANAGE_RECORDS")};this.utility.recordOptionSelected(this,b)},C.prototype.saveEntity=function a(b,c){if(b.utility.clearSpinner(b),""!==b.familykey()){var d;return b.utility.toastSuccessMessage(b.translate("RM_NEW_RECORD_SAVED_MESSAGE"),b.translate("RM_RECORD_MANAGER")),c.useUrlRedirection&&c.redirectionUrl&&""!==c.redirectionUrl?(d=c.redirectionUrl.replace(/\[ENTY_KEY\]/g,c.key),void b.appEvents.navigate.raise(d)):(A=!0,
void b.appEvents.navigate.raise("record-manager/"+c.key))}if(b.utility.toastSuccessMessage(b.translate("RM_RECORD_SAVED_SUCCESS_MESSAGE"),b.translate("RM_RECORD_MANAGER")),da(b),ma(b,c),b.datasheet.datasheetManager instanceof r&&b.utility.checkIfExistsInHierarchy(b,c.key)&&b.recordManagerService.getHierarchy(b.entityKey()).done(b.onSavingMDF.bind(null,b)).fail(ra.bind(null,b)),b.relationshipDefinitionDTO){var e=[{description:c.id,familyCaption:c.familyCaption,familyKey:c.familyKey.toString(),key:c.key}];b.finderResults(b,!1,e)}},C.prototype.finderResults=function a(c,d,e){var f,g,h=[];if(0===e.length)return c.relationshipDefinitionDTO=null,void c.loadDatasheet(c.selectedEntity().key());for(f=c.relationshipDefinitionDTO.relationshipFamilyKey,g=0;g<e.length;g++){var i=b.Deferred();h.push(i),
c.relationshipDefinitionDTO.isPred?c.recordManagerService.addRelation(f,c.entityKey(),parseInt(e[g].key)).done(ga.bind(null,c,d,i)).fail(ea.bind(null,i,c,!1)):c.recordManagerService.addRelation(f,parseInt(e[g].key),c.entityKey()).done(ga.bind(null,c,d,i)).fail(ea.bind(null,i,c,!1))}b.when.apply(b,h).then(function(a){ha(a[0],a[1],a[2])}).fail(c.utility.reloadDatasheet.bind(null,c))},C.prototype.onSavingMDF=function a(c,d){var e=b.Deferred();c.relationshipGroup=d.relationshipGroup,ka(c,!0,!1,d,!1)},C.prototype.refreshHierarchyOnRecommdSave=function a(c){b(c.region.$element).find(".rm-nav-list-group .active").length>0&&c.recordManagerService.getHierarchy(c.selectedEntity().key()).done(ba.bind(null,c)).fail(ra.bind(null,c))};function ba(a,b){a.relatedFamilies(a.getRelatedFamilies(b.relationshipGroup)),a.relatedFamiliesCount(a.relatedFamilies().length)}function ca(a){a.utility.setRecordExplorerHeight(a)}function da(a){var b=a.navigationEntities()[a.navigationEntities().length-1]
;0===b.key&&(a.navigationEntities.pop(),a.historyObj.pop(),b=a.navigationEntities()[a.navigationEntities().length-1],a.selectedEntity(Object.resolve(n,b))),a.region.$element.find("mi-associated-pages").show()}function ea(a,b,c,d){var e=new x(1,d,"record-manager-v2/views/rm-view-model.js");b.appEvents.errorOccured.raise(b,e),c&&b.utility.reloadDatasheet(b),a&&a.reject()}function fa(a,b,c,d){var e={containerEl:a.region.$element.find("div.rm-datasheet-container"),entityObj:d,assetContextKey:a.assetContextKey},g={loadedfromrecordmanager:!0,disablesiteselector:!0,loadedfrommodule:!1};a.isSuperUser&&(g.disablesiteselector=!1),a.datasheet=new f(e),a.datasheet.load(g).done(X.bind(null,a,b,c)),c.resolve()}function ga(a,b,c,d){var e=[a,b,d];c.resolve(e)}function ha(a,b,c){ia(a,c,b)}function ia(a,b,c){a.recordManagerService.getHierarchy(a.entityKey()).done(ja.bind(null,a,b,c)).fail(ra.bind(null,a))}function ja(a,b,c,d){var e,f;a.selectedEntity(Object.resolve(n,d.rootEntity)),
a.entityKey(d.rootEntity.key),c?ka(a,!0,!0,d,c):ka(a,!0,!1,d,c),e=a.utility.getCurrentFamily(a),a.selectedFamily().relations(e.relations),a.relationshipDefinitionDTO=null,f=a.historyObj.length,a.historyObj[f-1].relatedFamilies=a.relatedFamilies(),a.historyObj[f-1].allFamilies=a.allFamilies(),a.historyObj[f-1].relations=e.relations,c||(a.selectedEntity().key().toString()===b.successor.key.toString()?(la(a,b.predecessor),a.utility.saveHistory(a)):a.selectedEntity().key().toString()===b.predecessor.key.toString()&&(la(a,b.successor),a.utility.saveHistory(a)))}function ka(a,b,c,d,e){var f,g;f=a.selectedEntity().id()||a.translate("RM_RECORD_EXPLORER"),a.utility.setCollapsibleCaption(a,f),c&&a.loadDatasheet(a.entityKey(),null),a.relatedFamilies(a.getRelatedFamilies(d.relationshipGroup)),a.relatedFamiliesCount(a.relatedFamilies().length),a.allFamilies(a.getAllFamilies(d.relationshipGroup)),a.familiesOptions[0].text=a.relatedFamiliesCount()+" "+a.translate("RM_RELATED_FAMILIES"),
e?pa(a):(a.utility.familyOptionSelected(a,a.userPrefMenu),a.familiesHeaderVisibility(!0)),b||(g=Object.resolve(p,d.rootEntity),a.navigationEntities.push(g)),a.relationshipGroup=d.relationshipGroup}function la(a,b){a.previousState(q.states.ENTITY_VIEW),a.selectedEntity(Object.resolve(n,b)),a.entityKey(b.key),A=!0,a.showSpinner(),a.recordManagerService.getHierarchy(a.entityKey()).done(ka.bind(null,a,!1,!0)).fail(ra.bind(null,a))}function ma(b,c){var d=b.navigationEntities().length,e;if(b.navigationEntities()[d-1].key.toString()===c.key.toString()){var f=b.navigationEntities()[d-1].id(c.id);a.defer(function(){b.selectedEntity().id(f.id()),b.utility.setCollapsibleCaption(b,f.id()),b.rootEntityKey&&b.rootEntityKey.toString()===c.key.toString()&&(e=Z(b,f.id()),b.rmEvents.titleChanged.raise(e))})}else na(b,c)}function na(a,b){var c,d=a.selectedFamily().relations()
;for(c=0;c<d.length;c++)d[c].predecessor.key.toString()===b.key.toString()?d[c].predecessor.id(b.id):d[c].successor.key.toString()===b.key.toString()&&d[c].successor.id(b.id)}function oa(a){var b=a.utility.getCurrentFamily(a);a.selectedFamily().relations(b.relations),pa(a),a.canAdd===!1?(a.recordOptions[0].disabled=!0,a.recordOptions[1].disabled=!0):(a.recordOptions[0].disabled=!1,a.recordOptions[1].disabled=!1)}function pa(a){var b,c=a.allFamilies().length;for(b=0;b<c;b++)if(a.selectedFamily().key().toString()===a.allFamilies()[b].familyKey.toString()){a.canAdd=a.allFamilies()[b].canAdd;break}}function qa(a,b){if(1===a.navigationEntities().length&&b.id===a.navigationEntities()[0].id())return a.navigationEntities.pop(),a.relatedFamilies([]),a.allFamilies([]),a.familiesOptions[0].text="0 "+a.translate("RM_RELATED_FAMILIES"),a.utility.familyOptionSelected(a,a.userPrefMenu),a.familiesHeaderVisibility(!0),a.utility.setCollapsibleCaption(a,""),a.assocFamilyKey(""),a.region.$element.empty(),
void s.showOk(a.translate("RM_ROOT_DELETED_MESSAGE"),a.translate("RM_ALERT_TITLE"),"icon-exclamation-in-circle");J(a,b)}function ra(a,b){s.showOk(b+" "+a.translate("RM_CLOSE_TAB_MESSAGE"),a.translate("RM_ALERT_TITLE"),"icon-exclamation-in-circle")}function sa(a){a.resolve()}function ta(a){a.reject()}function ua(a){return a.cachedEntity?a.cachedEntity.isEntityDirty||a.cachedEntity.detail&&a.cachedEntity.detail.isEntityDirty||a.cachedEntity.master&&a.cachedEntity.master.isEntityDirty:!!a.cachedEntity}function va(a){return a.refDocEl&&a.refDocEl.refDocEntity&&a.refDocEl.refDocEntity.isEntityDirty===!0}function wa(a,b){ma(a,b)}return C});