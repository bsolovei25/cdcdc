/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("lodash"),b=require("jquery"),c=require("knockout"),d=require("spa/ko/knockout-view-model"),e=require("application/application-events"),f=require("application/application-context"),g=require("text!platform/datasheets/layout/ui/views/bdf-view.html"),h=require("spa/conductor"),i=require("record-manager-v2/services/record-manager-service"),j=require("platform/datasheets/datasheet"),k=require("system/globalization/translator"),l=require("text!platform/datasheets/layout/ui/views/spinner.html"),m=require("system/ui/message-box");require("ui/elements/associated-pages/associated-pages");function n(a){this.appEvents=a,this.rmService=Object.resolve(i),this.conductor=Object.resolve(h),this.assetContextKey=f.assetcontext.entityKey,this.translator=Object.resolve(k),this.fromRM=!1,this.bulkKeys=null,this.parentKey=null,this.parentID="",this.isSucc=!1,this.relationshipKey=null,this.canAdd=!0,this.rmVM=null,this.assocFamilyKey=c.observable(""),
this.entityKey=c.observable(""),this.familyKey=c.observable(),o.call(this,g)}var o=Object.inherit(d,n);n.dependsOn=[e],n.prototype.open=function a(){},n.prototype.attach=function a(b){o.prototype.attach.call(this,b);var c=this;c.region=b;var d=c.cachedEntity,e=d&&d.length;c.bulkKeys&&c.bulkKeys.length||e?c.renderBulkDatasheet(c.bulkKeys,d,c.familyKey()):c.familyKey()&&c.renderBulkDatasheet(c.bulkKeys,d,c.familyKey())};function p(b,c,d){a.each(c,function(a,c){0!==a.key&&b.bulkKeys.indexOf(a.key.toString())<0&&b.bulkKeys.push(a.key.toString())})}n.prototype.load=function a(b){b?"record-manager"===b.module?(this.fromRM=!0,this.bulkKeys=b.bulkKeys,this.parentKey=b.parentKey,this.parentID=b.parentID,this.isSucc=b.isSucc,this.relationshipKey=b.relFamilyKey,this.canAdd=b.canAdd,this.rmVM=b.screen,this.assocFamilyKey(b.familyKey),this.pageSize=25):(b&&b.keys&&(this.bulkKeys=b.keys.split(","),this.assocFamilyKey(b.familykey)),
b.pagesize&&(this.pageSize=b.pagesize)):m.showOk(this.translate("DS_NO_DATA_FOR_BDF"),this.translate("DS_ALERT_TITLE"),"icon-alert")},n.prototype.detach=function a(b){o.prototype.detach.call(this,b),this.datasheet&&(this.cachedEntity=this.datasheet.getState())},n.prototype.canUnload=function a(){var c=b.Deferred();return this.datasheet?this.datasheet.unload().done(q.bind(null,c)):c.resolve(),c},n.prototype.renderBulkDatasheet=function a(c,d,e){var f=this,g={containerEl:b(".datasheet-container1"),entityObj:c,assetContextKey:f.assetContextKey};e&&(g.familykey=e),null!==f.parentKey&&(g.predentitykey=f.parentKey),f.pageSize&&(g.pagesize=f.pageSize),f.datasheet=new j(g),d&&f.datasheet.updateState(d);var h;h=f.canAdd?["new","save","delete","history","references","copy"]:["save","delete","history","references"];var i={functionsAvailable:h,loadedfrommodule:!1};f.datasheet.load(i).done(r.bind(null,f))},n.prototype.relatenewEntity=function a(b){
for(var c=this,d=0;d<b.length;d++)c.bulkKeys.indexOf(b[d].key.toString())===-1&&0!==b[d].key&&(c.bulkKeys.push(b[d].key.toString()),c.isSucc?c.rmService.addRelation(c.relationshipKey,c.parentKey,parseInt(b[d].key)).done():c.rmService.addRelation(c.relationshipKey,parseInt(b[d].key),c.parentKey).done())},n.prototype.translate=function a(b){return this.translator.translate(b)},n.prototype.backButtonClicked=function a(b){b.datasheet&&b.datasheet.unload().done(function(){b.conductor.changeScreen(b.rmVM,b.region,{positional:[{entitykey:b.parentKey,frombulk:!0}]})})},n.prototype.handleEvent=function b(c){var d=this;c.target.parentElement&&"row-selection"===c.target.parentElement.parentElement.className&&a.defer(w.bind(null,d,c.target))};function q(a){a.resolve()}function r(b){if(b.datasheet.entity&&b.datasheet.entity[0]&&b.familyKey(b.datasheet.entity[0].familyKey),!b.fromRM){b.region.$element.find(".bdf-container").css("top","30px"),
b.region.$element.find(".bdf-container").css("height","calc(100% - 30px)");0===b.region.$element.find(".bulk-datasheet-header-container h2").text().length&&b.region.$element.find(".datasheet-layout-container.bulk-form-datasheet").css("top","30px")}a.defer(s.bind(null,b))}function s(a){a.fromRM&&a.datasheet.entitySaved.add(a.relatenewEntity.bind(a),a),v(a),a.datasheet.datasheetManager.entityDeleted.add(t.bind(null,a)),a.region.$element.find(".bdf-container").on("click",a.handleEvent.bind(a))}function t(a,b){u(a,b),b[0].toString()===a.entityKey().toString()&&(a.entityKey(""),x(a,!0,a.entityKey()))}function u(b,c){a.each(c,function(c,d){var e=b.bulkKeys.indexOf(c.toString());b.bulkKeys.indexOf(c.toString())>=0&&b.bulkKeys.splice(e,1),b.cachedEntity&&b.cachedEntity.length&&a.each(b.cachedEntity,function(a,b,c,d){c&&c.key===b&&a.cachedEntity.splice(d,1)}.bind(null,b,c))})}function v(a){var d,e,f,g;if(a.datasheet.datasheetManager.layout&&(a.datasheet.datasheetManager.layout.selectMode(!0),
e=a.region.$element.find(".bdf-container .bulk-datasheet-table-body .freezed-cols-container tbody tr")[0],f=b(e).find('input[type="checkbox"]')[0])){var h=c.contextFor(f.parentElement.parentElement).$data;h.isSelected(!0),x(a,!1,h.entitykey()),g=h.entitykey(),a.entityKey(g)}}function w(a,d){var e=b(a.region.$element.find(".bdf-container .bulk-datasheet-table-body .freezed-cols-container tbody tr")),f=0,g,h,i;for(g=0;g<e.length;g++)if(b(e[g]).find('input[type="checkbox"]')[0].checked&&++f>1){a.entityKey(""),x(a,!0,a.entityKey());break}1===f?(i=c.contextFor(d.parentElement.parentElement).$data.entitykey,h=i?i():c.contextFor(d.parentElement.parentElement).$data.selectedEntities()[0],a.entityKey(h),x(a,!1,a.entityKey())):0===f&&(a.entityKey(""),x(a,!0,a.entityKey()))}function x(a,b,c){a.datasheet&&a.datasheet.datasheetManager&&a.datasheet.datasheetManager.layout&&(a.datasheet.datasheetManager.layout.isAssociatedPagesDisabled(b),a.datasheet.datasheetManager.layout.assocEntityKey(c))}
return n});