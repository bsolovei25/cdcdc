/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require,exports,module){"use strict";var a=require("jquery"),b=require("mithril"),c=require("spa/mithril/mithril-view-model"),d=require("../models/localization"),e=require("../services/localization-service"),f=require("system/globalization/translator"),g=require("system/diagnostics/log-manager"),h=g.getLogger(module.id),i=require("../views/localize-dialog-view"),j=require("system/http/ajax-error"),k=require("mi-assert");function l(a,c,g,h){m.call(this,i),this.translator=Object.resolve(f),this.service=Object.resolve(e),this.localization=new d([],a,c,g,h),this.working=b.prop(!0)}var m=Object.inherit(c,l);l.prototype.load=function a(){try{o(this),p(this).then(q.bind(null,this)).then(r.bind(null,this)).then(w.bind(null,this)).then(y.bind(null,this)).then(n.bind(null,this)).catch(x).catch(y.bind(null,this))}catch(a){x(a)}};function n(a,b){if(0===a.localization.cultures().length){var c=document.querySelector(".btn-localize-save");c.className=c.className+" disabled"}}
function o(a){a.working(!0),b.redraw()}function p(a){return a.service.getLanguages()}function q(a,b){a.localization.updateCultures(b)}function r(a){return a.service.getTranslationValues(s(a),t(a),u(a),v(a))}function s(a){return a.localization.type()}function t(a){return a.localization.phrase()}function u(a){return a.localization.key()}function v(a){return a.localization.context()}function w(a,b){a.localization.addAll(b)}function x(a){throw a.response&&(a=new j(a.response,a.request).toError()),a.stack?h.error(a.stack):h.error(a),a}function y(a){a.working(!1),b.redraw()}l.prototype.save=function b(){try{var c=a.Deferred();return o(this),z(this).then(c.resolve.bind(c)).then(y.bind(null,this)).catch(B.bind(null,c)).catch(y.bind(null,this)),c.promise()}catch(a){x(a)}};function z(a){return a.service.saveTranslationValues(s(a),t(a),u(a),v(a),A(a))}function A(a){return a.localization.values()}function B(a,b){x(b),a.reject()}return l.prototype.title=function a(){
return this.text("LOCALIZE_PHRASE").replace("{0}",this.localization.phrase())},l.prototype.text=function a(b){return k.stringNotEmpty(b,"key"),this.translator.translate(b)},l});