/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("lodash"),b=require("jquery"),c=require("knockout"),d=require("./widget-view-model"),e=require("metrics/services/kpi-service"),f=require("mi-assert"),g=require("system/lang/property"),h=require("./kpi-widget-editor"),i=require("application/application-events"),j=require("text!../views/kpi-widget.html");require("ui/elements/kpi-widget/component");function k(b){l.call(this,b,j,h),this.applicationEvents=Object.resolve(i),this.widgetElement=null,this.$gridLayoutItem=null,this.debouncedWidgetResizeFunction=a.debounce(m.bind(null,this),250),this.key=this.kom.observable(),this.kpiName=this.kom.observable(),this.isResized=this.kom.observable(),this.isRefreshed=this.kom.observable(),this.gridWidth=this.kom.observable(),this.kpiChartType=this.kom.observable(b.properties().kpiChartType||"Dial"),this.selectedKpis=this.kom.observableArray(),this.kpiService=Object.resolve(e),"Dial"!==this.kpiChartType()&&(g.set(this,"allowGoTo",!1),
g.set(this,"allowRefresh",!1),g.set(this,"minWidth",6),g.set(this,"minHeight",6)),g.set(this,"editorDialogOptions",{height:"70%",width:"60%"})}var l=Object.inherit(d,k);k.prototype.abbreviateText=function a(b){return b.length>38?b.substr(0,38)+"...":b},k.prototype.afterAttach=function a(c){var d=this;try{d.$gridLayoutItem=b("mi-grid-layout-item"),d.$gridLayoutItem.on("element-resized",d.debouncedWidgetResizeFunction),d.gridWidth(d.region.$element.parents("mi-grid-layout-item").first().get(0).controller.width_blocks())}catch(a){l.prototype.onError.call(d,a)}},k.prototype.beforeDetach=function a(){var b=this;try{b.$gridLayoutItem.off("element-resized"),b.$gridLayoutItem=null}catch(a){l.prototype.onError.call(b,a)}finally{b.$gridLayoutItem=null}},k.prototype.deserialize=function a(){var b=this.widget.properties();f.ok(b,"properties"),this.key(b.key),this.kpiName(b.kpiName),this.kpiChartType(b.kpiChartType||"Dial"),this.selectedKpis(b.selectedKpis)},k.prototype.serialize=function a(){
return{key:this.key(),kpiName:this.kpiName(),kpiChartType:this.kpiChartType(),selectedKpis:this.selectedKpis()}},k.prototype.refresh=function a(){"Dial"===this.kpiChartType()&&this.isRefreshed.valueHasMutated()},k.prototype.redraw=function(){m(this)},k.prototype.goto=function a(b){var c,d=this,e="Dial"===this.kpiChartType()?this.kpiName():b;this.kpiService.getKpiDataByName(e).done(function(a){c=a[0].key,d.getresult(c)})},k.prototype.getresult=function(a){this.applicationEvents.navigate.raise("metrics/kpi-viewer/"+a,{tab:!0})};function m(a){a.gridWidth(a.region.$element.parents("mi-grid-layout-item").first().get(0).controller.width_blocks()),a.gridWidth.valueHasMutated(),a.isResized.valueHasMutated()}return k});