/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("lodash"),c=require("knockout"),d=require("dashboard/view-models/widget-view-model"),e=require("dashboard/view-models/calendar-widget/calendar-widget-editor"),f=require("mi-assert"),g=require("system/lang/property"),h=require("application/application-events"),i=require("ui/react/calendar/services/calendar-service"),j=require("text!dashboard/views/calendar-widget/calendar-widget.html"),k=require("react"),l=require("react-dom"),m=require("ui/react/calendar/calendar");function n(a,b){return k.DOM.div({style:{height:b||"100%",width:"100%"}},o(a))}function o(a){return k.createElement(m,{catalogItemPath:a.getCatalogItemPath(),map:a.getFieldColumnMap()})}function p(a){q.call(this,a,j,e);var b=this;this.calendarService=Object.resolve(i),this.queryColumns=c.observableArray(),this.path=c.observable(),this.pathSubscription=null,this.mappings={},this.mappings.start=c.observable(),this.mappings.end=c.observable(),
this.mappings.category=c.observable(),this.mappings.title=c.observable(),this.mappings.color=c.observable(),this.isValid=c.computed(function(){return b.path()&&b.mappings&&b.mappings.start()&&b.mappings.title()}),this.applicationEvents=Object.resolve(h),g.set(this,"allowGoTo",!0),g.set(this,"allowRefresh",!0),g.set(this,"mappings",{})}var q=Object.inherit(d,p);p.prototype.afterAttach=function(a){this.region=a,r(this,this.path(),!0),this.pathSubscription=this.path.subscribe(r.bind(null,this)),t(this)},p.prototype.reMountFC=function(){t(this)};function r(a,b,c){a.calendarService.getDataByPath(b).done(function(b){a.queryColumns(s(b.rowset))}),c||u(a)}function s(a){var c=[];return c=b.map(a.columns,function(a){return{alias:a.alias||a.id,id:a.fieldId}})}function t(b){var c=b.region.element.querySelector(".widget-container"),d=c.querySelector("span.fc-mount-point");d?l.unmountComponentAtNode(d):(d=document.createElement("span"),d.classList.add("fc-mount-point"),c.appendChild(d)),
l.render(n(b,a(c).parent().height()),d)}p.prototype.deserialize=function a(){try{var b=this.widget.properties();f.ok(b,"properties"),this.updateConfig(b)}catch(a){q.prototype.onError.call(this,a)}},p.prototype.serialize=function a(){try{return this.getConfig()}catch(a){q.prototype.onError.call(this,a)}},p.prototype.icon=function(){return"icon-calendar"},p.prototype.refresh=function a(){try{this.region&&this.region.$element.find(".full-calendar-widget").fullCalendar("refetchEvents")}catch(a){q.prototype.onError.call(this,a)}},p.prototype.redraw=function(){},p.prototype.goto=function a(){try{this.applicationEvents.navigate.raise("calendar-expanded-view/db/"+this.widget.dashboard().key+"/"+this.widget.uniqueID(),{tab:!0})}catch(a){q.prototype.onError.call(this,a)}},p.prototype.getCatalogItemPath=function a(){return this.path()},p.prototype.getFieldColumnMap=function a(){return v(this)},p.prototype.getConfig=function a(){return{path:this.path(),mappings:v(this)}},
p.prototype.updateConfig=function a(b){b.path&&this.path(b.path),b.mappings&&(b.mappings.start&&this.mappings.start(b.mappings.start),b.mappings.end&&this.mappings.end(b.mappings.end),b.mappings.category&&this.mappings.category(b.mappings.category),b.mappings.title&&this.mappings.title(b.mappings.title),b.mappings.color&&this.mappings.color(b.mappings.color))};function u(a){return a.mappings.title(""),a.mappings.start(""),a.mappings.end(""),a.mappings.category(""),a.mappings.color(""),!0}function v(a){var b=a;return{title:b.mappings.title(),start:b.mappings.start(),end:b.mappings.end(),category:b.mappings.category(),color:b.mappings.color()}}return p});