/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("lodash"),c=require("system/http/ajax-client"),d=require("./json-adapters/im-offline-form-data-adapter"),e=require("system/data/storage"),f=require("application/application-context"),g="offline-form-struture",h="offline-inspections",i="offline-inspection-pictures",j="api/internal/mi/im/inspections";function k(a){this.ajaxClient=a,this.storage=Object.resolve(e)}k.dependsOn=[c],k.prototype.downloadInspection=function b(c,d){var e=a.Deferred();return d=(d===!0||d===!1)&&d,this.ajaxClient.get(j+"/"+c+"/offline?includeReport="+d).done(l.bind(null,this,e)).fail(A.bind(null,e)),e.promise()},k.prototype.downloadInspections=function b(c,d){var e=a.Deferred();return d=(d===!0||d===!1)&&d,this.ajaxClient.post(j+"/bulkoffline/?includeReports="+d,c).done(m.bind(null,this,e)).fail(A.bind(null,e)),e.promise()};function l(a,b,c){a.saveOfflineData([c]).done(z.bind(null,b)).fail(A.bind(null,b))}function m(a,b,c){
a.saveOfflineData(c).done(z.bind(null,b)).fail(A.bind(null,b))}k.prototype.saveOfflineData=function b(c){var d=a.Deferred(),f=Object.resolve(e);return f.open().done(n.bind(null,this,d,c,f)).fail(d.reject.bind(d)),d.promise()};function n(b,c,e,f){for(var h=[],i=[],j=[],k=0,l=0;l<e.length;l++)if(e[l]){var m=e[l].offlineForms,n=e[l].offlineFormData.length>0?e[l].offlineFormData:d.fromJson(e[l].offlineFormData);if(m){for(var p=0;p<m.length;p++)i.push(f.put(g,m[p]));if(n.length>0)for(var q=0;q<n.length;q++)i.push(o(b,n[q],f));else i.push(o(b,n,f))}else j.push(n.familyCaption),k+=e[l].errorCount;e.length>1?h.push([m,n]):h=[m,n]}var r=a.when.apply(b,i);r.done(z.bind(null,c,h,j,k)),r.fail(A.bind(null,c)),r.always(v.bind(null,f))}function o(b,c,d){var e=a.Deferred(),f=a.Deferred();return u(b,h,f,c.formKey,d,!1),f.done(p.bind(null,d,c,e)).fail(A.bind(null,e)),e.promise()}function p(a,b,c,e){var f=d.fromJson(e);if(!f)return void a.put(h,b).done(z.bind(null,c))
;for(var g=0;g<Object.keys(b.records).length;g++){for(var i=b.records[Object.keys(b.records)[g]],j=i.entityKey,k=!1,l=0;l<Object.keys(f.records).length;l++){if(f.records[Object.keys(f.records)[l]].entityKey===j){f.records[Object.keys(f.records)[l]]=i,k=!0;break}}k===!0?a.put(h,f).done(q.bind(null,c)):(f.records[i.clientId]=i,a.put(h,f).done(q.bind(null,c)))}}function q(a,b){a.resolve(b)}k.prototype.deleteOfflineRecord=function b(c,d){var f=a.Deferred(),g=Object.resolve(e);return g.open().done(r.bind(null,this,f,c,d,g)).fail(f.reject.bind(f)),f.promise()};function r(b,c,d,e,f){var g=a.Deferred();u(b,h,g,d.formKey,f,!1),g.done(s.bind(null,b,f,e,c))}function s(a,b,c,e,f){var g=d.fromJson(f),h=g.records[c.clientId],i=[];h.pictureCount>0&&i.push(h.clientId),i.push.apply(i,a.getClientIdsForRelatedRecords(h)),a.deletePictures(i,b).done(t.bind(null,a,g,c,e,b))}function t(a,b,c,d,e){delete b.records[c.clientId],e.put(h,b).done(z.bind(null,d)).always(v.bind(null,e))}
k.prototype.getOfflineFormFromStorage=function b(c){var d=a.Deferred(),f=Object.resolve(e);return f.open().done(u.bind(null,this,g,d,c,f)).fail(d.reject.bind(d)),d.promise()};function u(a,b,c,d,e,f){e.get(b,d).done(z.bind(null,c)).always(v.bind(null,e,f))}function v(a,b){(b=b!==!0&&b!==!1||b)&&a.close()}k.prototype.getOfflineFormDataFromStorage=function b(c,d){var f=a.Deferred(),g=a.Deferred(),i=Object.resolve(e);return i.open().done(u.bind(null,this,h,g,c,i)).fail(g.reject.bind(g)),g.done(w.bind(null,f,d)).fail(A.bind(null,f)),f.promise()};function w(a,b,c){for(var e=d.fromJson(c),f=0;f<Object.keys(e.records).length;f++){var g=e.records[Object.keys(e.records)[f]];if(g.entityKey===b)return void a.resolve(e,g)}a.reject()}k.prototype.getAllOfflineFormDataFromStorage=function b(){var c=a.Deferred(),d=a.Deferred(),f=Object.resolve(e);return f.open().done(y.bind(null,this,h,d,f)).fail(d.reject.bind(d)),d.done(x.bind(null,this,c)).fail(A.bind(null,c)),c.promise()};function x(a,c,e){
var f=b.map(e,"value"),g=d.fromJsonCollection(f);c.resolve(g)}function y(a,b,c,d){d.getAll(b).done(z.bind(null,c)).always(function(){a.storage.close()})}k.prototype.syncOfflineInspection=function b(c){var d=a.Deferred();return this.ajaxClient.post(j+"/"+c.entityKey+"/offline",c).done(z.bind(null,this,d)).fail(A.bind(null,d)),d.promise()};function z(a,b,c,d){c?a.resolve({data:b,errorFamilies:c,errorCount:d}):a.resolve(b)}function A(a,b){a.reject(b)}k.prototype.getPicturesFromStorage=function b(c){var d=a.Deferred(),f=Object.resolve(e);return f.open().done(u.bind(null,this,i,d,c,f)).fail(d.reject.bind(d)),d.promise()},k.prototype.savePictures=function b(c,d){var f=a.Deferred(),g=Object.resolve(e),h=a.Deferred();return g.open().done(u.bind(null,this,i,f,c,g)).fail(f.reject.bind(f)),f.always(B.bind(null,this,h,c,d,g)),h.promise()};function B(a,b,c,d,e,f){f?f.pictures=d:f={clientId:c,pictures:d},e.put(i,f).done(q.bind(null,b)),f=null}k.prototype.savePicture=function b(c,d){
var f=a.Deferred(),g=Object.resolve(e),h=a.Deferred();return g.open().done(u.bind(null,this,i,f,c,g)).fail(f.reject.bind(f)),f.done(C.bind(null,this,h,c,d,g)),h.promise()};function C(a,b,c,d,e,f){f?f.pictures.push(d):f={clientId:c,pictures:[d]},e.put(i,f).done(q.bind(null,b,f.pictures.length)),f=null}k.prototype.getClientIdsForRelatedRecords=function a(b){for(var c=[],d=0;d<b.relatedRecords.length;d++)for(var e=b.relatedRecords[d],f=Object.keys(e.records).length,g=0;g<f;g++){var h=e.records[Object.keys(e.records)[g]];h.pictureCount&&h.pictureCount>0&&c.push(h.clientId)}return c},k.prototype.deletePictures=function b(c,d){var f=a.Deferred();return c=Array.isArray(c)?c:[c],d?D(this,d,c,f):(d=Object.resolve(e),d.open().done(D.bind(null,this,d,c,f)).fail(f.reject.bind(f))),f.promise()};function D(a,b,c,d){b.deleteAll(i,c).done(d.resolve.bind(d)).fail(d.reject.bind(d))}return k.prototype.syncPicture=function b(c,d){var e=a.Deferred()
;return this.ajaxClient.post(j+"/photos/"+c,d).done(function(){console.log("resolving deferred from syncPicture server call"),z(e)}).fail(A.bind(null,e)),e.promise()},k});