/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("knockout"),c=require("system/http/ajax-client"),d="api/Rounds/Routes",e="api/core/entity",f="api/internal/Rounds/Routes",g="api/Rounds/routes/user/subscriptions",h=require("system/data/client-preferences"),i=require("bluebird"),j=require("ramda"),k=1;require("system/lang/object");function l(a){this.ajaxClient=a,this.applyTemplateResponse=[],this.existingCheckpointResponse=[]}l.dependsOn=[c],l.prototype.getRouteHierarchy=function b(c){var e=a.Deferred();return this.ajaxClient.get(d+"/route/"+c).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}),e},l.prototype.getRouteHierarchyforCheckpoint=function b(c){var e=a.Deferred();return this.ajaxClient.get(d+"/Route/Checkpoint/"+c).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}),e},l.prototype.deleteCondition=function b(c,e){var f=a.Deferred();return this.ajaxClient.delete(d+"/Condition/"+c+"/"+e).done(function(a){f.resolve(a)}).fail(function(a){
f.reject(a)}),f},l.prototype.bulkDelete=function b(c,d){var e=a.Deferred();return this.ajaxClient.post(f+"/BulkDelete/"+c,d).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}),e},l.prototype.updateSequence=function(a){return this.ajaxClient.post(f+"/Sequence/Update",a)},l.prototype.updateSequenceInBackground=function(a){return this.ajaxClient.post(f+"/Sequence/UpdateBackground/"+a)},l.prototype.getNewML=function b(c,e,f,g){var h=a.Deferred();return void 0===g&&(g=0),this.ajaxClient.get(d+"/NewML/"+c+"/"+e+"/"+f+"/"+g).done(function(a){h.resolve(a)}).fail(function(a){h.reject(a)}),h},l.prototype.getNewLR=function b(c,e,f,g){var h=a.Deferred();return void 0===g&&(g=0),this.ajaxClient.get(d+"/NewLR/"+c+"/"+e+"/"+f+"/"+g).done(function(a){h.resolve(a)}).fail(function(a){h.reject(a)}),h},l.prototype.getOrphanCP=function(a){return this.ajaxClient.get(d+"/OrphanCPs/"+a)},l.prototype.updateExistingML=function a(b,c,d,e,f){return i.resolve(m(this,b,c,d,e,f))}
;function m(a,b,c,d,e,f){f.totalCount(d.length),f.counter(0);var g=s(d,k),h=n(a,b,c,e,f),i=j.map(h,g);return j.composeP.apply(null,i)()}function n(a,b,c,d,e){return function(f){return function(){return o(a,b,c,d,e,f)}}}function o(a,b,c,e,f,g){return i.resolve(a.ajaxClient.put(d+"/ExistingML/"+b+"/"+c+"/"+e,g)).then(p.bind(null,a,f))}function p(a,b,c){return a.existingCheckpointResponse.push(c[0]),b.counter(b.counter()+1),b.progressPercent(q(b)),i.resolve(a.existingCheckpointResponse)}function q(a){return 100*a.counter()/a.totalCount()+"%"}l.prototype.getNewCondition=function b(c,e,f){var g=a.Deferred();return this.ajaxClient.get(d+"/NewCondition/"+c+"/"+e+"/"+f).done(function(a){g.resolve(a)}).fail(function(a){g.reject(a)}),g},l.prototype.getCheckPointTask=function b(c){var e=a.Deferred();return this.ajaxClient.get(d+"/CPTask/"+c).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}),e},l.prototype.getMLReadings=function b(c){var e=a.Deferred()
;return this.ajaxClient.get(d+"/Readings/"+c).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}),e},l.prototype.getRouteHistory=function b(c){var e=a.Deferred();return this.ajaxClient.get(d+"/RouteHistory/"+c).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}),e},l.prototype.deleteRouteHistory=function a(b){return this.ajaxClient.delete(e+"/"+b)},l.prototype.deleteReading=function(a){return this.ajaxClient.delete(e+"/"+a)},l.prototype.updateConditionValues=function c(d){var e=a.Deferred();return this.ajaxClient.put(f+"/Condition",b.toJSON(d)).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}),e.promise()},l.prototype.deleteML=function b(c,e){var f=a.Deferred();return this.ajaxClient.delete(d+"/ML/"+c+"/"+e).done(function(a){f.resolve(a)}).fail(function(a){f.reject(a)}),f},l.prototype.fixNewMLSequence=function b(c,d){var e=a.Deferred();return this.ajaxClient.get(f+"/Sequence/Fix/NewLRML/"+c+"/"+d).done(function(a){e.resolve(a)}).fail(function(a){
e.reject(a)}),e},l.prototype.getSubscriptions=function(){return this.ajaxClient.get(g)},l.prototype.getCachedSubscriptions=function(){return Object.resolve(h).retrievePreferences("inspection-route-subscription-preferences")},l.prototype.saveCachedSubscriptions=function(a){return Object.resolve(h).savePreference("inspection-route-subscription-preferences",a)},l.prototype.clearCachedSubscriptions=function(){return Object.resolve(h).deletePreference("inspection-route-subscription-preferences")},l.prototype.applyTemplate=function a(b,c){return i.resolve(r(this,b.routeKey,b.parentKey,b.sequence,b.assetAndMltKeys,c))};function r(a,b,c,d,e,f){f.totalCount(e.length),f.counter(0);var g=s(e,k),h=t(a,b,c,d,f),i=j.map(h,g.reverse());return j.composeP.apply(null,i)()}function s(a,b){return j.splitEvery(b,a)}function t(a,b,c,d,e){var f=d;return function(d){return function(){
return 0!==a.applyTemplateResponse.length&&a.applyTemplateResponse[a.applyTemplateResponse.length-1].createdEntities&&(f+=a.applyTemplateResponse[a.applyTemplateResponse.length-1].createdEntities.length),u(a,b,c,f,e,d)}}}function u(a,b,c,d,e,f){var g={};return g.routeKey=b,g.parentKey=c,g.sequence=d,g.assetKeys=[f[0][0]],g.templateKeys=[f[0][1]],i.resolve(a.ajaxClient.post("api/internal/Rounds/MLGT/ApplyTemplate",g)).then(v.bind(null,a,e))}function v(a,b,c){return a.applyTemplateResponse.push(c[0]),b.counter(b.counter()+1),b.progressPercent(q(b)),i.resolve(a.applyTemplateResponse)}return l.prototype.deleteAsset=function b(c,d){var e=a.Deferred();return this.ajaxClient.post(f+"/RemoveAssetGroup/"+c,d).done(function(a){e.resolve(a)}).fail(function(a){e.reject(a)}),e.promise()},l.prototype.getSequenceSchedule=function(){return this.ajaxClient.get(f+"/schedule")},l.prototype.schedule=function(a){return this.ajaxClient.post(f+"/schedule",a)},l.prototype.unschedule=function(){
return this.ajaxClient.delete(f+"/unschedule")},l});