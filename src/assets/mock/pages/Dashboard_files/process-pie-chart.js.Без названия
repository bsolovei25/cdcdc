/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("ramda"),c=require("lodash"),d=require("ui/elements/chart/chart-utilities"),e=require("system/text/parser");function f(){}f.processData=function(a,c,f,h,i,j,k,l){var m,n,o,p,r,s,t,u=f.pieSeries,x={},A=c.chartData,B=c.rawData.getRows();for(m=0;m<h.length;m++){if(n=d.getRowValueFromQuery(i,h,m),s=d.getFormattedValueFromQuery(f,i,h,m),p=d.extractHyperlinkHref(i,h,m),r=s?s:e.parseFloat(n),o=a.chartUtilities.translateChartType(f.series[m].chartType),t=d.extractHyperlinkHref(i,[l],0),x[f.categoryProperty]=d.getFormattedValueFromQuery(f,i,[l],0),x[f.categoryProperty]=d.formatHyperlink(x[f.categoryProperty],t),0===A.length&&(A[0]={data:[],type:o}),f.pieSeries.length>0&&(0===k.length&&(g(f.pieSeries,k),w(a,f,j)),f.pieSeriesAltered===!1?f.pieSeries=[]:a.resetPieSeries&&(u=q(a,f,B,l,h),a.resetPieSeries=!1)),f.pieSeriesAltered===!1){var C=b.and(f.pieSeriesAllHyperlinksChecked,z(p));A[0].data[A[0].data.length]={
name:"string"==typeof d.getRowValueFromQuery(i,[l],0)?d.getRowValueFromQuery(i,[l],0):a.translator.translate("SLICE"),y:y(n),url:C?p:"",color:v(a,j),hyperlink:p?p:"",used:!1,checked:C},s&&(A[0].data[A[0].data.length-1].formattedValue=s)}x[f.series[m].name]=d.formatHyperlink(s,p)}c.gridData.data[c.gridData.data.length]=x};function g(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=d.name,f=!0,g;for(g=0;g<b.length;g++)b[g].name&&b[g].name===e.toString()&&(b[g].colors.push(d.color),f=!1);f&&(b[b.length]={name:e.toString(),colorUsed:0,catUsed:!1,colors:[d.color]})}}var h=b.addIndex(b.forEach),i=b.curry(function a(c,d,e,f){c=j(c,d,f),b.forEach(k(c,d),c.rawData)});function j(a,b,c){return a.sliceIndex=c,b.categoryStatemachineFmlyId||b.categorySystemCodeTableId?a.hasCat=o(a.rawData,"getValue"):a.hasCat=o(a.rawData,"getDbValue"),a}var k=b.curry(function a(b,c,d){b.found=!1,h(l(b,d,c),c.pieSeries)}),l=b.curry(function(a,c,f,g,h){
var i=d.getRowValueFromQuery(c,a.sliceIndexes,a.sliceIndex),j=d.getFormattedValueFromQuery(f,c,a.sliceIndexes,a.sliceIndex),k=d.getRowValueFromQuery(c,[a.categoryIndex],0),l="string"!=typeof k,o=l?k:a.sliceName,p;if(!(g=m(g,f,l,o,k))||g.name!==o||g.used||a.found){if(g&&!(p=n(f)?a.hasCat(g.originalName):a.hasCat(g.name))&&g.name!==a.sliceName){var q=b.findIndex(b.propEq("name",g.name),a.config.pieSeries);q!==-1&&a.config.pieSeries.splice(q,1)}}else{var r=b.find(b.propEq("name",g.name),a.config.pieSeries);r.y=y(e.parseFloat(d.extractHyperlinkValue(i))),r.found=!0,r.used=!0,j&&(r.formattedValue=j)}});function m(a,b,d,e,f){return a&&!c.has(a,"used")&&(a.used=!1),a&&d&&a.name!==e&&(a.name=e),b.pieSeriesAllHyperlinksChecked&&""!==a.hyperlink&&(a.url=a.hyperlink,a.checked=!0),n(b)&&(a.originalName=f),a}function n(a){return a.categoryStatemachineFmlyId||a.categorySystemCodeTableId}var o=b.curry(function a(c,d,e){
return b.compose(b.any(b.equals(e)),b.flatten,b.map(b.invoker(0,d)),b.flatten,b.map(b.invoker(0,"getCells")))(c)});function p(a){a.used=!1}function q(c,d,e,f,g){var j=a.extend(!0,{},d),k={sliceName:c.translator.translate("SLICE"),config:j,rawData:e,categoryIndex:f,sliceIndexes:g,sliceIndex:null,found:!1,hasCat:null};return b.forEach(p,k.config.pieSeries),b.forEach(p,d.pieSeries),h(i(k,d),g),d.pieSeries=k.config.pieSeries,d.pieSeries}f.setColorValues=function(a,b,c,e,f,g){var h,i,j,k=c.categoryArray,l=c.rawData.getRows();for(b.pieSeriesAltered===!1&&(b.pieSeries=0===c.chartData.length?[]:c.chartData[0].data),j=0;j<l.length;j++)for(i="string"==typeof d.getRowValueFromQuery(l[j],g,0)?d.getRowValueFromQuery(l[j],g,0):a.translator.translate("SLICE"),c.categoryArray[c.categoryArray.length]=r(a,i),h=0;h<f.length;h++)u(b.pieSeries,k,e)};function r(a,b){var d;return a.customCaptions.length>0?a.customCaptionSysCodeTable?(d=c.find(a.customCaptions,t.bind(null,b)),
d?d.caption:b):a.customCaptionStateMachine?(d=c.find(a.customCaptions,s.bind(null,b)),d?d.caption:b):void 0:b}function s(a,b){return b.defaultCaption===a||b.id===a}function t(a,b){return b.value===a||b.defaultDescription===a}function u(a,b,c){for(var d=0;d<a.length;d++){var e,f=a[d],g=f.name,h=b[b.length-1];if(g===h)for(e=0;e<c.length;e++){var i=c[e].name,j=c[e].catUsed;i!==h||j||(f.color=c[e].colors[c[e].colorUsed],c[e].colorUsed++,1===c.length&&c[e].colorUsed===a.length?c[e].catUsed=!0:c[e].colorUsed===c[e].colors.length?c[e].catUsed=!0:1===c[e].colors.length&&(c[e].catUsed=!0))}}}function v(a,b){var c;return 0===b.length&&b.push.apply(b,a.chartUtilities.CHART_COLORS),b.length>0&&(c=b[0],b.shift()),c}function w(a,b,c){var d,e=[];for(d=0;d<b.pieSeries.length;d++)e.push(b.pieSeries[d].color);if(e.length>0&&a.outOfPieColors===!1){for(d=0;d<e.length;d++)x(c,e[d]);0===c.length&&(a.outOfPieColors=!0)}0===c.length&&c.push.apply(c,a.chartUtilities.CHART_COLORS),c.length>0&&c.shift()}
function x(a,b){var c;for(c=0;c<a.length;c++)a[c]===b&&a.splice(c,1)}function y(a){return c.isNaN(Number(a))?0:null!==a?a:0}var z=b.compose(b.not,b.isEmpty);return f});