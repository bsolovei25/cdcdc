/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require,exports,module){"use strict"
;var a=require("jquery"),b=require("lodash"),c=require("system/knockout/knockout-manager"),d=require("rounds/designer/services/route-management-service"),e=require("rounds/data-collection/device-settings/device-settings-manager"),f=require("rounds/common/services/inspection-service"),g=require("rounds/data-collection/services/inspection-cache-service"),h=require("rounds/data-collection/services/rec-service"),i=require("rounds/data-collection/services/rec-storage"),j=require("system/lang/event"),k=require("system/globalization/translator"),l=require("rounds/common/dto/save-reading-dto"),m=require("rounds/common/dto/save-route-dto"),n=require("rounds/common/dto/reading-dto").ReadingDTO,o=require("rounds/common/dto/route-detail-dto").RouteDetailDTO,p=require("application/application-context"),q=require("system/lang/converter"),r=require("application/application-events"),s=require("application/application-service"),t=require("system/error/error-message"),u=require("system/diagnostics/log-manager"),v=Object.resolve(require("system/notifications/broker")),w=require("rounds/common/services/rounds-service"),x=require("ramda"),y=u.getLogger(module.id),z=require("bluebird")
;function A(){this.intervalId=-1,this.kom=Object.resolve(c),this.cachedSubscriptions={},this.routeManagementService=Object.resolve(d),this.inspectionService=Object.resolve(f),this.cacheService=Object.resolve(g),this.appEvents=Object.resolve(r),this.recservice=Object.resolve(h),this.recstorage=Object.resolve(i),this.roundsservice=Object.resolve(w),this.appService=Object.resolve(s),this.syncing=this.kom.observable(!1),this.batchUploading=this.kom.observable(!1),this.batchUploadSize=this.kom.observable(25),this.initializing=!1,this.initialized=!1,this.readingSaved=new j,this.readingsSynced=new j,this.translator=Object.resolve(k),this.deviceSettingsManager=Object.resolve(e),this.routesUploadState=this.kom.observableArray([]),this.uploadingRoutesBatches=this.kom.observableArray([])}A.singleton=!0;function B(a){P(a,a.deviceSettingsManager.syncInterval())}function C(a){a.batchUploadSize(a.deviceSettingsManager.batchUploadSize())}A.execute=function(){var a=Object.resolve(A)
;a.routeManagementService.getCachedSubscriptions().done(J.bind(null,a))},A.initTimer=function(){K(Object.resolve(A))},A.prototype.getUserRoutes=function(b){return b=b||a.Deferred(),pb(this).done(function(a,c){c?a.inspectionService.getUserRoutes().done(_a.bind(null,a,b)).fail(Ka.bind(null,a,b)):a.cacheService.getUserRoutes().done(_a.bind(null,a,b)).fail(b.reject.bind(b))}.bind(null,this)),b.promise()},A.prototype.getRouteDetail=function(b,c){return c=c||a.Deferred(),pb(this).done(function(a,d){d?a.getHorizonPreference().done(bb.bind(null,a,c,b)).fail(c.reject.bind(c)):a.cacheService.getRouteDetail(b).done(Ua.bind(null,a,c,b)).fail(c.reject.bind(c))}.bind(null,this)),c.promise()},A.prototype.getUserRoute=function(b,c){return c=c||a.Deferred(),pb(this).done(function(a,d){d?a.inspectionService.getUserRoute(b).done(cb.bind(null,a,c,b)).fail(Ma.bind(null,a,b,c)):a.cacheService.getUserRoute(b).done(cb.bind(null,a,c,b)).fail(c.reject.bind(c))}.bind(null,this)),c.promise()},
A.prototype.saveRoute=function(a){var b=new m(a);return this.cacheService.saveRoute(b)},A.prototype.saveReading=function(b,c){var d=new l(b,c.key),e=new m(c),f=a.Deferred(),g=[];return g.push(this.cacheService.getReading(b.relatedMLKey)),g.push(this.cacheService.getRouteWithReading(c.key)),a.when.apply(null,g).done(eb.bind(null,this,f,e,d)).fail(f.reject.bind(f)),f.promise()},A.prototype.saveReadingToOffline=function(b,c){"Delete"===b.tracking&&(b.tracking="Add");var d=new l(b,c.key),e=new m(c),f=a.Deferred(),g=[];return g.push(z.resolve(this.cacheService.getReading(b.relatedMLKey))),g.push(z.resolve(this.cacheService.getRouteWithReading(c.key))),z.all(g).then(fb.bind(null,this,f,e,d)).then(gb.bind(null,this,f)).then(f.resolve.bind(f)).catch(f.reject.bind(f)),f.promise()},A.prototype.deleteReading=function(a,b){return this.batchUploading(!0),a.tracking="Delete",b.completeMlCount()>0&&b.completeMlCount(b.completeMlCount()-1),this.saveReading(a,b).always($a.bind(null,this))},
A.prototype.markDone=function(b){var c=a.Deferred(),d=new m(b);return this.cacheService.getRouteWithReading(b.key).done(mb.bind(null,this,c,d)),c.promise()},A.prototype.isRunning=function(){return this.intervalId!==-1},A.prototype.batchUpload=function(){da(this)},A.prototype.promisedBatchUpload=function(){return ea(this)},A.prototype.getSyncPreference=function(){return this.deviceSettingsManager.syncInterval()},A.prototype.getBatchUploadSizePreference=function(){return this.deviceSettingsManager.batchUploadSize()},A.prototype.getHorizonPreference=function(){return a.Deferred().resolve(this.deviceSettingsManager.downloadHorizon())},A.prototype.getRouteSubscription=function(b){var c=a.Deferred();return z.resolve(this.roundsservice.routesSubscription(b)).then(D.bind(null,this,c,b)).catch(c.reject.bind(c)).then(T.bind(null,this)),c.promise()};function D(b,c,d,e){var f=new o(e.routedetail,d),g=[],h=a.Deferred();return g.push(z.resolve(b.cacheService.saveRoutes([e.route]))),
g.push(z.resolve(Z(b,f))),z.all(g).catch(h.reject.bind(h)).then(Y.bind(null,b)).then(h.resolve.bind(h)).then(c.resolve.bind(c,e)),z.resolve(h.promise())}A.prototype.getRouteUnSubscription=function(b){var c=a.Deferred();return this.roundsservice.routesUnsubscription(b).done(I.bind(null,this,c,b)).fail(c.reject.bind(c)),c.promise()},A.prototype.getPicture=function(b){var c=a.Deferred();return this.cacheService.getOfflinePicture(c,b),c.promise()},A.prototype.doSync=function(){setTimeout(R.bind(null,this),1e3)},A.prototype.isRouteUploading=function(a){var b=this.routesUploadState[a];return!!(b&&b()>0)};function E(a,b,c){var d=a.routesUploadState[b],e;d?(e=d()+c,e>0?d(e):delete a.routesUploadState[b]):c>0&&(a.routesUploadState[b]=a.kom.observable(c))}function F(a,b,c,d){var e={key:b,pendingBatches:c,completedBatches:d},f=G(a,b);f?(e.completedBatches=f.completedBatches+1,a.uploadingRoutesBatches.replace(f,e)):a.uploadingRoutesBatches.push(e)}function G(a,c){
return b.find(a.uploadingRoutesBatches(),{key:c})}function H(a,b){a.uploadingRoutesBatches.remove(function(a){return a.key===b})}A.prototype.clearCachedSubscriptions=function(){this.cachedSubscriptions={},X(this)};function I(a,b,c,d){a.cacheService.deleteRouteForUnsubscribe(b,c).fail(ba.bind(null,a)),a.cacheService.deleteImageForUnsubscribe(b,c,d).fail(ba.bind(null,a))}function J(a,b){null!==b&&Object.keys(b).length>0&&(a.cachedSubscriptions=b,K(a))}function K(a){if(!a.isRunning()&&!a.initializing)try{a.initializing=!0,L(a),pb(a).done(function(a,b){b?(N(a,a.deviceSettingsManager.syncInterval()),O(a,a.deviceSettingsManager.batchUploadSize()),da(a),fa(a),ga(a)):a.initializing=!1}.bind(null,a))}catch(b){throw a.initializing=!1,b}}function L(a){a.initialized||(a.appEvents.connectionChanged.add(ca.bind(null,a)),a.kom.subscribe(a.deviceSettingsManager.syncInterval,B.bind(null,a)),a.kom.subscribe(a.deviceSettingsManager.batchUploadSize,C.bind(null,a)),a.initialized=!0)}function M(a){
a.initializing=!1}function N(a,b){P(a,b),setTimeout(R.bind(null,a),1e4),a.initializing=!1}function O(a,b){a.batchUploadSize(b)}function P(a,b){var c=60;b&&(c=q.toInteger(b)),y.info("Syncing subscribed routes to server every",c,"minutes"),c*=6e4,Q(a),a.intervalId=setInterval(R.bind(null,a),c)}function Q(a){a.intervalId&&(clearInterval(a.intervalId),a.intervalId=-1)}function R(a){pb(a).done(function(a,b){if(b&&!a.syncing())try{U(a)}catch(b){throw a.syncing(!1),b}else a.initializing=!1}.bind(null,a))}function S(a,b,c,d){a.syncing(!1),(401===b.status||Ia(b))&&Q(a),Ja(b)&&ba(a,b,c,d)}function T(a){a.syncing(!1)}function U(a){pb(a).done(function(a,b){b&&(a.syncing(!0),z.resolve(a.routeManagementService.getSubscriptions()).then(V.bind(null,a)).then(z.all).then(Y.bind(null,a)).catch(S.bind(null,a)).then(T.bind(null,a)))}.bind(null,a))}function V(a,b){var c=[];return b&&0!==b.length?(_(a,b),ha(a,b,c),c.push(z.resolve(a.cacheService.saveRoutes(b))),
c.push(W(a,a.deviceSettingsManager.downloadHorizon())),c):(c.push(X(a)),c)}function W(a,b){return z.resolve(a.inspectionService.batchGetRouteDetails(a.cachedSubscriptions,b,Z.bind(null,a)))}function X(a){return z.resolve(a.cacheService.clearSubscriptions()).then(a.routeManagementService.clearCachedSubscriptions())}function Y(a){return z.resolve(a.routeManagementService.saveCachedSubscriptions(a.cachedSubscriptions))}function Z(b,c){var d=a.Deferred(),e=[];return void 0===b.cachedSubscriptions[c.routeKey]&&(b.cachedSubscriptions[c.routeKey]={}),b.cachedSubscriptions[c.routeKey].hash=c.hash,e.push(z.resolve(b.cacheService.clearCachedMLsFromRoute(c.routeKey))),c.refDocContentMapping&&e.push(z.resolve(b.cacheService.saveOfflinePictures(c.refDocContentMapping))),z.all(e).then($.bind(null,b,c)).catch(d.reject.bind(d)).then(d.resolve.bind(d)),d.promise()}function $(a,b){return z.resolve(a.cacheService.saveMeasurementLocations(b))}function _(a,b){var c,d={},e
;for(c=0;c<b.length;c++)a.cachedSubscriptions[b[c].key]||(a.cachedSubscriptions[b[c].key]={});for(e=Object.keys(a.cachedSubscriptions),c=0;c<e.length;c++)aa(e[c],b)!==-1&&(d[e[c]]=a.cachedSubscriptions[e[c]]);a.cachedSubscriptions=d}function aa(a,b){var c;for(c=0;c<b.length;c++)if(b[c].key===a)return c;return-1}function ba(a,b,c,d){var e;e="string"==typeof b||b instanceof String?new t("AC1",b,(new Error).stack):new t("AG1",d||b.statusText,(new Error).stack),a.appEvents.errorOccured.raise(a,e),a.batchUploading(!1)}function ca(a,b,c){c.connected?K(a):Q(a)}function da(a){if(!a.batchUploading())try{a.batchUploading(!0),ka(a).then(z.all).then($a.bind(null,a)).catch($a.bind(null,a))}catch(b){throw a.batchUploading(!1),b}}function ea(a){return a.batchUploading(!0),ka(a).then(z.all).then($a.bind(null,a)).catch($a.bind(null,a))}function fa(a){a.recservice.getRecOptions()}function ga(a){a.recservice.uploadOfflineRecommendations()}function ha(a,b,c){var d=0
;for(d=0;d<b.length;d++)c.push(ia(a,b[d].key))}function ia(a,b){return z.resolve(a.recservice.getAllRecommendationsForRoute(b)).then(a.recstorage.cacheRouteRecommendations.bind(a.recstorage,b))}function ja(b,c){if(!x.isNil(c)&&!x.isNil(c.markDoneRoutes)){var d=x.map(ma.bind(null,b),c.markDoneRoutes);return a.when.apply(a,d)}}function ka(a){return la(a).then(x.map(na.bind(null,a)))}function la(a){return z.resolve(a.cacheService.getAllRoutesWithReadings())}function ma(b,c){var d=a.Deferred(),e=[];return e.push(z.resolve(b.cacheService.updateCachedRouteDates(c.routeKey,c.overdueDate,c.routeNextDate))),e.push(z.resolve(b.cacheService.updateInspectionCachedRouteDates(c.routeKey,c.overdueDate,c.routeNextDate))),z.all(e).then(b.cacheService.clearRoute.bind(null,c.routeKey)).then(d.resolve.bind(d)).catch(d.reject.bind(d)),d.promise()}function na(a,b){var c=x.prop("key",b);return new z(function(d,e){
z.resolve(a.cacheService.getReadings(c)).then(pa.bind(null,a,[b])).then(z.all).then(d).then(a.readingsSynced.raise.bind(a.readingsSynced,[b])).catch(oa.bind(null,a,e))})}function oa(a,b){b(),p.connectionStatus.connected===!0&&ba(a,a.translator.translate("GET_READINGS_FOR_ROUTE_TO_UPLOAD"))}function pa(a,b,c){return qa(c,b)?[]:ra(a,c,b)}function qa(a,c){return(!a||0===a.length)&&x.none(x.propEq("pendingChange","true"),b.map(c,"value"))}function ra(a,b,c){var d,e={},f=[],g,h,i;for(d=0;d<b.length;d++){var j=b[d];i=j.routeKey?j.routeKey:"",g=e[i],g||(g=[],e[i]=g,h=Ha(c,i),f.push(h)),g.push(j)}if(0===b.length)for(d=0;d<c.length;d++)e[c[d].key]=[],f.push(c[d].value);return x.map(sa.bind(null,a,e),f)}function sa(a,b,c){var d=c?c.routeKey:"",e=b[d],f={readings:e,routeHistory:[c]};return E(a,d,e.length),ta(a,c,f).catch(xa.bind(null,a)).finally(za.bind(null,a,c,f))}function ta(a,b,c){
var d=b?b.routeKey:"",e=x.propEq("pendingChange","true",b)?[b]:null,f=ua(a.batchUploadSize(),c.readings),g=va(a.inspectionService,c,e,f),h=x.map(g,f),i=x.intersperse(wa(a,d,h.length+(e?1:0),c),h);return i.splice(0,0,wa(a,d,h.length+(e?1:0),c)),F(a,d,f.length+(e?1:0),0),x.composeP.apply(null,i)()}function ua(a,b){return 0===b.length?[[]]:x.splitEvery(a,b)}function va(a,b,c,d){return function(e){return function(){var f=e===d[0],g={readings:e,routeHistory:b.routeHistory},h=f?c:null;return z.resolve(a.saveReadingAndMarkDone(g,h))}}}function wa(b,c,d,e){return function(f){return new z(function(g,h){var i=a.Deferred();F(b,c,d,1),Qa(b,i,e,f),i.done(ja.bind(null,b,f)).done(g).fail(h)})}}function xa(a,b){b.fail(ya.bind(null,a))}function ya(a,b,c,d){var e=Aa(d);a.batchUploading(!1),e&&(a.cacheService.getUserRoutes().done(Ba.bind(null,a,b,e)),a.cacheService.getCompletedRoutesToUpload().done(Ca.bind(null,a,b,e)))}function za(a,b,c){var d=b?b.routeKey:"";E(a,d,-1*c.readings.length),H(a,d)}
function Aa(a){try{return JSON.parse(a)}catch(b){return a}}function Ba(a,b,c,d){Fa(a,b,c,d)}function Ca(a,b,c,d){c.RouteHistoryKeys&&Da(a,b,c,d)}function Da(a,b,c,d){var e,f,g,h,i;(e=c.RouteHistoryKeys.map(Ea.bind(null,d)))&&(f=e.map(Ga.bind(null,d)),g=c.Title,h=c.Detail,h=h+a.translator.translate("ROUNDS_CONCERNED_ROUTE_IDS")+" : "+f.toString(),i=new t(b.status,g,h),v.feedback.error(i))}function Ea(a,c){var d=b.find(a,{historyKey:c});return d&&d.routeKey?d.routeKey:c}function Fa(a,b,c,d){if(c.RouteKeys){var e=c.RouteKeys.map(Ga.bind(null,d)),f=c.Title,g=c.Detail,h;g=g+a.translator.translate("ROUNDS_CONCERNED_ROUTE_IDS")+" : "+e.toString(),h=new t(b.status,f,g),v.feedback.error(h)}}function Ga(a,c){var d=b.find(a,function(a){return a.key===c.toString()});return d&&d.routeId?d.routeId:c}function Ha(a,b){var c;for(c=0;c<a.length;c++)if(a[c].key===b)return a[c].value}function Ia(a){return 0===a.status&&"error"===a.statusText||a.status>=400&&a.status<500}function Ja(a){return a.status>=500
}function Ka(a,b,c,d,e){Ia(c)?setTimeout(a.getUserRoutes.bind(a,b),0):b.reject(c,d,e)}function La(a,b,c,d,e,f){Ia(d)?setTimeout(a.getRouteDetail.bind(a,b,c),0):c.reject(d,e,f)}function Ma(a,b,c,d,e,f){Ia(d)?setTimeout(a.getUserRoute.bind(a,b,c),0):c.reject(d,e,f)}function Na(a,b,c,d,e,f){(Ia(d)||Ja(d))&&(c.pendingChange="true",a.cacheService.markDone(c).done(b.resolve.bind(b)).fail(b.reject.bind(b))),Ja(d)&&b.reject(d,e,f)}function Oa(a,b,c,d,e,f){(Ia(d)||Ja(d))&&(c.pendingChange="true",a.cacheService.updateCachedReading(c).fail(ba.bind(null,a))),Ja(d)&&ba(a,d,e,f),b.reject()}function Pa(a,b,c,d){b.done(Qa.bind(null,a,null,null,d)),c.resolve(d)}function Qa(b,c,d,e){var f;f=Ra(b,e.updatedReadingsRouteHistory.readings),f=f.concat(Ta(b,e.updatedReadingsRouteHistory.routeHistory)),c&&a.when.apply(a,f).done(c.resolve.bind(c,e.markDoneRoutes,d))}function Ra(a,b){var c,d=[];for(c=0;c<b.length;c++)d[d.length]=Sa(a,b[c]);return d}function Sa(a,b){var c
;return"Delete"===b.tracking?c=a.cacheService.deleteReading(b.relatedMLKey).fail(ba.bind(null,a)):(b.tracking="Done",b.pendingChanges="",c=a.cacheService.updateCachedReading(b).done(a.readingSaved.raise.bind(a.readingSaved)).fail(ba.bind(null,a))),c}function Ta(a,b){var c,d=[];for(c=0;c<b.length;c++)d[d.length]=a.cacheService.updateCachedRoute(b[c].routeKey,b[c].historyKey).fail(ba.bind(null,a));return d}function Ua(a,b,c,d){a.cacheService.getReadings(c).done(Va.bind(null,a,b,d)).fail(b.reject.bind(b))}function Va(a,b,c,d){var e,f=c.measurementLocations,g=a.deviceSettingsManager.downloadHorizon(),h=new Date,i=new Date(h.getTime()+60*g*60*1e3);for(e=f.length-1;e>=0;e--)f[e].reading=Wa(f[e].entityKey,d);for(e=f.length-1;e>=0;e--)x.isNil(f[e].dueDate)&&x.isNil(c.routeNextDate)&&f[e].predKey===c.routeKey?f.splice(e,1):f[e].dueDate>i&&x.isNil(f[e].reading.dateTaken)&&f.splice(e,1);b.resolve(c)}function Wa(a,b){var c;for(c=0;c<b.length;c++)if(a===b[c].relatedMLKey)return new n(b[c])
;return new n(null,a)}function Xa(a,b,c){a.cacheService.clearRoute(c).done(b.resolve.bind(b)).fail(b.reject.bind(b))}function Ya(b,c,d){var e,f=[];for(e=0;e<d.length;e++)f[f.length]=b.cacheService.clearRoute(d[e].routeKey);a.when.apply(a,f).done(Za.bind(null,b,c,d))}function Za(a,b){a.batchUploading(!1),a.readingsSynced.raise(b)}function $a(a){a.batchUploading(!1)}function _a(a,b,c){a.cacheService.getAllRoutesWithReadings().done(ab.bind(null,a,b,c)).fail(b.reject.bind(b))}function ab(a,b,c,d){var e,f;for(e=0;e<d.length;e++)(f=aa(d[e].key,c))>-1&&(c[f].completeMlCount=d[e].value.taken,c[f].checkPointCount=d[e].value.expected,c[f].recommendationsCount=d[e].value.recommendationsCount,c[f].assetCount=d[e].value.assetCount);b.resolve(c)}function bb(a,b,c,d){a.inspectionService.getRouteDetail(c,d).done(Ua.bind(null,a,b,c)).fail(La.bind(null,a,c,b))}function cb(a,b,c,d){a.cacheService.getRouteWithReading(c).done(db.bind(null,a,b,d)).fail(b.reject.bind(b))}function db(a,b,c,d){
d&&(c.completeMlCount=d.taken,c.checkPointCount=d.expected,c.recommendationsCount=d.recommendationsCount,c.assetCount=d.assetCount,c.historyKey=d.historyKey,c.id=d.routeId),a.cacheService.getCompletedRoutesToUpload().done(function(a){for(var d=0;d<a.length;d++)if(a[d].routeKey===c.key){c.closeDate=a[d].closeDate;break}b.resolve(c)})}function eb(a,b,c,d,e,f){if(""===d.characterValue&&null===d.numericValue&&"Add"===d.tracking)return void b.reject();var g=kb(e,d),h;p.connectionStatus.connected||(g.pendingChange="true"),c=lb(f,c),h=a.cacheService.saveReading(g,c),h.fail(b.reject.bind(b)),pb(a).done(function(a,d){if(d){var e=x.propEq("pendingChange","true",c)?[c]:null,f={readings:[g],routeHistory:[c]};a.inspectionService.saveReadingAndMarkDone(f,e).done(Pa.bind(null,a,h,b)).fail(Oa.bind(null,a,b,g))}else g&&"Delete"===g.tracking&&!g.entityKey&&(h=a.cacheService.deleteReading(g.relatedMLKey)),h.done(b.resolve.bind(b))}.bind(null,a))}function fb(a,b,c,d,e){var f=e[0],g=e[1]
;if(""===d.characterValue&&null===d.numericValue&&"Add"===d.tracking)return void b.reject();var h=kb(f,d);return h.pendingChange="true",c=lb(g,c),{saveReading:h,saveRoute:c}}function gb(a,b,c){return c.saveRoute.routeKey&&c.saveReading.routeKey&&c.saveRoute.routeKey===c.saveReading.routeKey||console.log("InspectionSyncService saveReadingToCache routeKey mismatch",c),z.resolve(a.cacheService.saveReading(c.saveReading,c.saveRoute))}A.prototype.deleteHistoryRecord=function(b){var c=a.Deferred(),d=new m(b);pb(this).done(function(a,e){e?a.inspectionService.deleteRouteHistoryRecord({routes:[d]}).done(hb.bind(null,a,b)).fail(ba.bind(null,a)):(d.pendingChange="true",a.cacheService.saveRoute(d).done(c.resolve.bind(c)).fail(c.reject.bind(c)))}.bind(null,this))};function hb(a,b){b.historyKey="",a.cacheService.updateCachedRoute(b.key,b.historyKey).fail(ba.bind(null,a))}A.prototype.saveRouteHistory=function(b){var c=a.Deferred(),d=new m(b)
;this.cacheService.getRouteWithReading(b.key).done(ib.bind(null,this,c,d))};function ib(a,b,c,d){c=lb(d,c),pb(a).done(function(a,d){if(d){a.cacheService.saveRoute(c);var e={readings:[],routeHistory:[c]};a.inspectionService.saveReadingAndMarkDone(e,null).done(jb.bind(null,a)).fail(ba.bind(null,a))}else c.pendingChange="true",a.cacheService.saveRoute(c).done(b.resolve.bind(b)).fail(b.reject.bind(b))}.bind(null,a))}function jb(a,b){var c,d=b.updatedReadingsRouteHistory.routeHistory;for(c=0;c<d.length;c++)a.cacheService.updateCachedRoute(d[c].routeKey,d[c].historyKey).fail(ba.bind(null,a))}function kb(a,b){var c=b;return a=a||{},c.entityKey=c.entityKey||a.entityKey,c.actionTaken=c.actionTaken||a.actionTaken,c.assetId=c.assetId||a.assetId,c.comment=c.comment||a.comment,c.takenBy=c.takenBy||a.takenBy,c.dateTaken=c.dateTaken||a.dateTaken,c.characterValue=c.characterValue||a.characterValue,c.numericValue=null!==c.numericValue?c.numericValue:a.numericValue,
c.relatedMLKey=c.relatedMLKey||a.relatedMLKey,c.UOM=c.UOM||a.UOM,c.routeKey=c.routeKey||a.routeKey,c.tracking=c.tracking||a.tracking,c}function lb(a,b){var c=b;return a=a||{},c.historyKey=a.historyKey,c}function mb(a,b,c,d){c.closeDate=new Date,d&&(c.historyKey=d.historyKey),pb(a).done(function(a,d){d?(a.batchUploading(!0),nb(a,c).then(ka.bind(null,a)).then(z.all).then($a.bind(null,a)).then(b.resolve.bind(b)).catch(Na.bind(null,a,b,c)).then($a.bind(null,a))):(c.pendingChange="true",a.cacheService.markDone(c).done(ob.bind(null,a,b,c)).fail(b.reject.bind(b)))}.bind(null,a))}function nb(a,b){return b.pendingChange="true",z.resolve(a.cacheService.markDone(b))}function ob(a,b,c){a.cacheService.updateLastDateForMarkDoneRoute(c.routeKey,c.closeDate).done(b.resolve.bind(b)).fail(ba.bind(null,a))}function pb(b){var c=a.Deferred();return b.appService.ping().done(c.resolve.bind(c,!0)).fail(c.resolve.bind(c,!1)),c.promise()}return A});