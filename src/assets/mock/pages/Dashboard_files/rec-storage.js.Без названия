/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require,exports,module){"use strict";var a=require("lodash"),b=require("jquery"),c=require("system/data/storage"),d="asset-care-inspection-recommendations",e="asset-care-inspection-recommendation-option",f="asset-care-inspection-recommendation-key",g="asset-care-inspection-recommendation-relatedml",h="asset-care-inspection-recommendation-pendingChange",i="asset-care-inspection-recommendations-subscribed",j="asset-care-inspection-recommendations-subscribed-entitykey",k="asset-care-inspection-recommendations-subscribed-relatedml",l="asset-care-inspection-recommendations-subscribed-routekey",m="MI_OPR_REC",n="offline-form-struture";function o(){}o.prototype.saveRecommendation=function(a,d){var e=Object.resolve(c),f=b.Deferred();return d=d||a.autoincrementkey,e.open().done(z.bind(null,e,f,a,d)).fail(f.reject.bind(f)),f.promise()},o.prototype.saveRecommendationSubscription=function(a){var d=Object.resolve(c),e=b.Deferred()
;return d.open().done(A.bind(null,d,e,a)).fail(e.reject.bind(e)),e.promise()},o.prototype.saveAllRecommendations=function(a){var d=Object.resolve(c),e=b.Deferred();return d.open().done(F.bind(null,d,e,a)).fail(e.reject.bind(e)),e.promise()},o.prototype.getRecommendation=function(a){var d=b.Deferred(),e=Object.resolve(c);return e.open().done(B.bind(null,e,d,a)).fail(d.reject.bind(d)),d.promise()},o.prototype.getRecommendationSubscription=function(a){var d=b.Deferred(),e=Object.resolve(c);return e.open().done(C.bind(null,e,d,a)).fail(d.reject.bind(d)),d.promise()},o.prototype.getRelatedRecommendations=function(a){var d=b.Deferred(),e=Object.resolve(c);return e.open().done(D.bind(null,e,d,a)).fail(d.reject.bind(d)),d.promise()},o.prototype.getAllPendingRecommendations=function(){var a=b.Deferred(),d=Object.resolve(c);return d.open().done(E.bind(null,d,a)).fail(a.reject.bind(a)),a.promise()},o.prototype.deleteRecommendation=function(a){var d=b.Deferred(),e=Object.resolve(c)
;return e.open().done(I.bind(null,e,d,a)).fail(d.reject.bind(d)),d.promise()},o.prototype.deleteRecommendationFromSubscription=function(a){var d=b.Deferred(),e=Object.resolve(c);return e.open().done(J.bind(null,e,d,a)).fail(d.reject.bind(d)),d.promise()},o.prototype.getRecOptions=function(){var a=b.Deferred(),d=Object.resolve(c);return d.open().done(H.bind(null,d,a)).fail(a.reject.bind(a)),a.promise()},o.prototype.saveRecOptions=function(a){var d=Object.resolve(c),e=b.Deferred();return d.open().done(G.bind(null,d,e,a)).fail(e.reject.bind(e)),e.promise()},o.prototype.cacheRouteRecommendations=function(a,d){var e=Object.resolve(c),f=b.Deferred();return e.open().done(s.bind(null,this,e,f,d,a)).fail(f.reject.bind(f)),f.promise()},o.prototype.saveLayoutInfo=function(a){var d=Object.resolve(c),e=b.Deferred();return d.open().done(p.bind(null,d,e,a)).fail(e.reject.bind(e)),e.promise()};function p(a,b,c){a.put(n,c).done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}
o.prototype.getLayoutFromDB=function(a){var d=Object.resolve(c),e=b.Deferred();return d.open().done(q.bind(null,a,d,e)).fail(e.reject.bind(e)),e};function q(a,b,c){b.getAll(n).done(r.bind(null,a,c)).fail(c.reject.bind(c)).always(b.close.bind(b))}function r(a,b,c){if(a)for(var d=0;d<c.length;d++){var e=c[d].key;if(e===a){b.resolve(c[d].value);break}}else c&&c.length>0&&b.resolve(c[0].value)}function s(a,b,c,d,e){y(b,d).done(t.bind(null,a,b,c,d,e)).fail(c.reject.bind(c))}function t(a,b,c,d,e){b.getAllKeys(i,e,l).done(u.bind(null,a,c,d)).fail(c.reject.bind(c)).always(b.close.bind(b))}function u(a,c,d,e){var f,g,h,i=[];for(f=d.map(x),g=v(e,f),h=0;h<g.length;h++)i[i.length]=a.deleteRecommendationFromSubscription(g[h]);0===i.length&&c.resolve(),b.when.apply(b,i).done(c.resolve.bind(c)).fail(c.reject.bind(c))}function v(a,b){return a.filter(w.bind(null,b))}function w(a,b){return a.indexOf(b)<0}function x(a){return a.entityKey}function y(a,c){var d=[],e,f=b.Deferred()
;for(e=0;e<c.length;e++)d[d.length]=a.put(i,c[e]);return b.when.apply(b,d).done(f.resolve.bind(f)).fail(f.reject.bind(f)),f.promise()}function z(a,b,c,e){var f;f=a.put(d,c,e),f.done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function A(a,b,c){var d;d=a.put(i,c),d.done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function B(a,b,c){var e;e=a.get(d,c,f),e.done(K.bind(null,b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function C(a,b,c){var d;d=a.get(i,c,j),d.done(K.bind(null,b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function D(a,c,e){var f=[];f.push(a.getAll(d,e,g)),f.push(a.getAll(i,e,k)),b.when.apply(null,f).done(M.bind(null,c)).fail(c.reject.bind(c)).always(a.close.bind(a))}function E(a,b){var c;c=a.getAll(d,"true",h),c.done(L.bind(null,b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function F(a,c,e){var f=[],g;for(g=0;g<e.length;g++)f[f.length]=a.put(d,e[g],e[g].autoincrementkey)
;b.when.apply(b,f).done(c.resolve.bind(c)).fail(c.reject.bind(c)).always(a.close.bind(a))}function G(a,b,c){var d;d=a.put(e,c),d.done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function H(a,b){var c;c=a.get(e,m),c.done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function I(a,b,c){var e;e=a.delete(d,c),e.done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function J(a,b,c){var d;d=a.delete(i,c),d.done(b.resolve.bind(b)).fail(b.reject.bind(b)).always(a.close.bind(a))}function K(a,b){b?a.resolve(R(b)):a.resolve()}function L(a,b){a.resolve(b.map(R))}function M(b){var c=0,d=[],e=[];for(e=Array.prototype.slice.call(arguments),e.shift(),c=0;c<e.length;c++)e[c]=e[c].map(R);e[0].sort(Q),e[1].sort(P),e[0]=a.filter(e[0],N.bind(null)),e[1]=a.filter(e[1],N.bind(null)),e[1]=e[1].filter(O.bind(null,e[0])),d=d.concat.apply(d,e),b.resolve(d)}function N(a){return"Delete"!==a.tracking}function O(a,b){var c=0,d=!1
;for(c=0;c<a.length;c++)if(a[c].entityKey===b.entityKey){d=!0;break}return!d}function P(a,b){return b.entityKey.localeCompare(a.entityKey)}function Q(a,b){return b.autoincrementkey-a.autoincrementkey}function R(a){var b=a.value||a,c=a.autoincrementkey||a.key;return b.autoincrementkey=c,b}return o});