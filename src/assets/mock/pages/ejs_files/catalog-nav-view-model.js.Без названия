/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("application/application-events"),c=require("./catalog-events"),d=require("system/error/error-message"),e=require("spa/ko/knockout-view-model"),f=require("system/knockout/knockout-manager"),g=require("./services/catalog-service"),h=require("./services/catalog-constants"),i=require("./adapters/folder-adapter"),j=require("system/globalization/translator"),k=require("system/lang/event"),l=require("text!./views/catalog-nav.html");require("ui/elements/collapsible/collapsible-element");function m(a,b,c,d){n.call(this,l),this.kom=a,this.applicationEvents=b,this.catalogService=d,this.events=c,this.navCollapsed=new k,this.navExpanded=new k,this.requestAddFolder=new k,this.translator=Object.resolve(j),this.constants=Object.resolve(h),this.$treeControl=null,this.$collapsible=null,this.canCreateNew=null,this.allowAdd="true",this.flatFolders=null}var n=Object.inherit(e,m);m.dependsOn=[f,b,c,g],m.prototype.load=function b(c){
var d=new a.Deferred;return c&&c.allowAdd&&(this.allowAdd=c.allowAdd),d.promise()},m.prototype.unload=function a(){},m.prototype.canUnload=function a(){return!0},m.prototype.activate=function a(){this.events.folderAdded.add(this.onFolderAdded,this),this.events.folderUpdated.add(this.onFolderUpdated,this),this.events.folderDeleted.add(this.onFolderDeleted,this),this.events.navigationRequested.add(this.onNavigationRequested,this),this.canCreateNew=this.kom.pureComputed(o.bind(null,this))},m.prototype.deactivate=function a(b){this.events.folderAdded.remove(this),this.events.folderUpdated.remove(this),this.events.folderDeleted.remove(this),this.events.navigationRequested.remove(this)},m.prototype.attach=function a(b){var c,d;n.prototype.attach.call(this,b),this.region=b,this.$treeControl=this.region.$element.find("mi-tree"),c=this.$treeControl.get(0),Element.upgrade(c),this.$collapsible=this.region.$element.find("mi-collapsible"),d=this.$collapsible.get(0),Element.upgrade(d),
this.$treeControl.on("selecting",s.bind(null,this)),this.$treeControl.on("navigated",t.bind(null,this)),this.$treeControl.on("add-item",u.bind(null,this)),c.searchCallback=this.onSearchFolders.bind(this),this.$collapsible.on("change",v.bind(null,this)),c.loader=p.bind(null,this)},m.prototype.detach=function a(b){n.prototype.detach.call(this,b),this.$treeControl.off("selecting"),this.$treeControl.off("navigated"),this.$treeControl.off("add-item"),this.$collapsible.off("change")};function o(a){return a.allowAdd}m.prototype.translate=function a(b){return this.translator.translate(b)},m.prototype.onFolderAdded=function a(b,c){var d=this.$treeControl.get(0);!c&&d.refresh();var e=d.listGroup.items;e.push(b),c&&(d.listGroup.items=e,this.preventRefresh=!0),d.listGroup.value=b},m.prototype.onFolderUpdated=function a(b){var c=this.$treeControl.get(0);w(this,c).caption=b.id(),c.refresh()},m.prototype.onFolderDeleted=function a(b){var c=this.$treeControl.get(0);c.backInHistory(),c.refresh()},
m.prototype.onNavigationRequested=function a(b){var c=this.$treeControl.get(0);b&&b.length&&(b[0].key&&b[0].key&&b.splice(0,0,{caption:this.translate("CATALOG_NAV_ROOT")}),c.value=b)},m.prototype.onSearchFolders=function b(c,d,e,f){return c?this.catalogService.searchFolders(c,f,e).fail(x.bind(null,this)):a.Deferred().resolve().promise()};function p(b,c,d,e){var f=a.Deferred(),g,h,i;return g=b.$treeControl.get(0),h=g.value[c],h&&h.key&&(i=h.key),b.preventRefresh?q(b,f,[]):h.key?b.catalogService.getFoldersPaginate(i,e,d).done(q.bind(null,b,f)).fail(x.bind(null,b)):b.catalogService.getFolderRoots().done(r.bind(null,b,f)).fail(x.bind(null,b)),f}function q(a,b,c){b.resolve(c)}function r(a,b,c){b.resolve(c)}function s(a,b){a.events.beforeFolderNavigated.raise(b)}function t(a,b){var c=b.target,d,e;c&&(d=w(a,c),e=d.key?d.key:null,a.preventRefresh?delete a.preventRefresh:a.events.folderNavigated.raise(e,b))}function u(a,b){a.requestAddFolder.raise(b)}function v(a,b){var c=b.originalEvent.detail
;c&&(c.expanded?a.navExpanded.raise():a.navCollapsed.raise())}function w(a,b){if((b=b||a.$treeControl.get(0))&&b.value&&!(b.value.length<1))return b.value[b.value.length-1]}function x(a,b){var c=2,e=d.fromHttpResponse(c,b);a.applicationEvents.errorOccured.raise(a,e)}return m});