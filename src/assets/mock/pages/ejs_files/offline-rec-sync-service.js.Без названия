/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("ramda"),c=require("system/lang/event"),d=require("platform/offline-forms/layout/adapters/offline-record-json-adapter"),e=require("system/http/ajax-client"),f=require("application/application-context"),g=require("./offline-rec-storage"),h="api/internal/safety",i=require("bluebird");function j(){this.ajaxClient=Object.resolve(e),this.offlineRecStorage=Object.resolve(g),this.isExecuting=!1,this.syncCompleted=new c,this.serverRecommendations=[]}j.singleton=!0,j.prototype.execute=function(){var a=this;f.connectionStatus.connected?a.isExecuting===!1&&(a.isExecuting=!0,a.getRecordsToSync().then(n.bind(null,a)).done(function(){k(a),a.syncCompleted.raise()})):(k(a),a.getRecordsToReset().then(o.bind(null,a)).done(function(){a.syncCompleted.raise()}))};function k(a){a.isExecuting=!1}j.prototype.getRecordsToSync=function b(){var c=a.Deferred()
;return this.offlineRecStorage.getAllOfflineFormDataFromStorage().done(l.bind(null,this,c)),c.promise()};function l(a,b,c){for(var d=c,e=[],f=0;f<d.length;f++)for(var g=Object.keys(d[f].records).length,h=0;h<g;h++){var i=d[f].records[Object.keys(d[f].records)[h]];"SYNC_PENDING"===i.syncStatus&&e.push({formData:d[f],record:i})}b.resolve(e)}j.prototype.getRecordsToReset=function b(){var c=a.Deferred();return this.offlineRecStorage.getAllOfflineFormDataFromStorage().done(m.bind(null,this,c)),c.promise()};function m(a,b,c){for(var d=c,e=[],f=0;f<d.length;f++)for(var g=Object.keys(d[f].records).length,h=0;h<g;h++){var i=d[f].records[Object.keys(d[f].records)[h]];"SYNCING"===i.syncStatus&&e.push({formData:d[f],record:i})}b.resolve(e)}function n(c,e){if(!e||0===e.length)return void k(c);var f=a.Deferred();c.serverRecommendations=[];for(var g=0;g<e.length;g++)c.serverRecommendations.push(d.toServerObject(e[g].record)),e[g].record.syncStatus="SYNCING",
e[g].formData.records[e[g].record.clientId]=e[g].record;var h=b.uniq(b.pluck("formData")(e));h&&h.length<=0&&k(c);for(var i=0;i<h.length;i++){var j=[{offlineFormData:h[i],offlineForms:[]}];c.offlineRecStorage.saveOfflineData(j).done(q.bind(null,c,f,c.serverRecommendations,e)).fail(p.bind(null,c,c.serverRecommendations,e))}return f.promise()}function o(b,c){var d=a.Deferred();if(c&&0!==c.length)return p(b,c),d.promise()}function p(a,b){k(a);for(var c=0;c<b.length;c++){"SYNCING"===b[c].record.syncStatus&&(b[c].record.syncStatus="SYNC_PENDING"),b[c].formData.records[b[c].record.clientId]=b[c].record;var d=[{offlineFormData:b[c].formData,offlineForms:[]}];a.offlineRecStorage.saveOfflineData(d)}}function q(a,b,c,d){a.getImagesForRecommendations(d).done(function(e){var f={offlineRecs:c,refDocs:e};a.ajaxClient.post(h+"/offlineRecs",JSON.stringify(f)).done(r.bind(null,a,b,d,e)).fail(w.bind(null,a,b))})}j.prototype.getImagesForRecommendations=function b(c){
for(var d=a.Deferred(),e=[],f=[],g=0;g<c.length;g++)e.push(this.offlineRecStorage.getPicturesFromStorage(c[g].record.clientId));return i.all(e).then(function(a){for(var b=0;b<a.length;b++)if(a[b]){var c=a[b].pictures.filter(function(a){return"SYNC_PENDING"===a.syncStatus});a[b].pictures=c,f.push(a[b])}d.resolve(f)}),d.promise()};function r(a,b,c,d,e){s(a,b,c,d,e)}function s(a,b,c,d,e){for(var f=0;f<c.length;f++){for(var g=!1,h=c[f].record,i=0;i<e.length;i++){var j=e[i];j.clientID===h.clientId&&(h.entityKey=j.entityKey,j.errors&&j.errors.length>0&&(h.errors=j.errors,g=!0))}g?h.syncStatus="SYNC_COMPLETE_W_ERRORS":(h.syncStatus="SYNC_COMPLETE",t(a,d)),c[f].formData.records[c[f].record.clientId]=h;var k=[{offlineFormData:c[f].formData,offlineForms:[]}];a.offlineRecStorage.saveOfflineData(k)}a.isExecuting=!1}function t(a,b){for(var c=0;c<b.length;c++)for(var d=b[c].pictures,e=0;e<d.length;e++)d[e].syncStatus="SYNC_COMPLETE",a.offlineRecStorage.savePicture(b[c].clientId,d[e])}
function u(a,b,c,d,e){e<d.length-1?(e++,s(a,b,c,d,e)):b.resolve()}function v(a,b){a.resolve(b)}function w(a,b,c){b.reject(c),a.isExecuting=!1,a.getRecordsToReset().then(o.bind(null,a)).done(function(){a.syncCompleted.raise()})}return j});