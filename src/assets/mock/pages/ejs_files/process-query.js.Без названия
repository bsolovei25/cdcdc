/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("ramda"),c=require("lodash"),d=require("query/execution/query-execution-engine"),e=require("../../../dcm/services/system-codes-and-tables-service"),f=require("../../../dcm/services/state-configuration-service"),g=require("ui/elements/chart/chart-utilities"),h=require("system/error/error-message"),i=require("system/globalization/translator"),j=require("application/application-events"),k=require("system/ui/message-box"),l=require("ui/elements/chart/models/process-standard-chart"),m=require("ui/elements/chart/models/process-time-series-chart"),n=require("ui/elements/chart/models/process-pie-chart"),o=require("ui/elements/chart/models/process-scatter-chart"),p=require("ui/elements/chart/models/process-heat-map-chart"),q=require("ui/elements/chart/alternate-caption-manager");function r(a,b,d){this.queryKey=c.has(a,"queryKey")?a.queryKey:"",this.dataset=c.has(a,"dataset")?a.dataset:"",this.queryEngine=null,
this.queryContainer=null,this.translator=Object.resolve(i),this.errorOccured=Object.resolve(j).errorOccured,this.systemCodesAndTablesService=Object.resolve(e),this.stateConfigurationService=Object.resolve(f),this.deferred=null,this.chartUtilities=new g,this.parameters=b||null,this.missingParams=!0,this.isFiltered=d||!1,this.outOfPieColors=!1,this.resetPieSeries=!0,this.customCaptions=[],this.customCaptionSysCodeTable=!1,this.customCaptionStateMachine=!1,this.alternateCaptionManager=new q}r.prototype.load=function(b){return this.deferred=a.Deferred(),b=b||{},this.dataset?A(this,this.dataset,b):(this.queryKey=b.queryKey||this.queryKey,s(this,b)),this.deferred.promise()};function s(a,b){c.has(a.parameters,"queryString")?(a.queryEngine=Object.resolve(d,{catalogItemKey:a.queryKey}),a.queryEngine.compile().done(t.bind(null,a,b))):t(a,b)}function t(b,e,f){var g={},h={pageSize:-1,sync:!0,startPage:-1},i,j;if(c.has(b.parameters,"queryString"))if(i=f.parmContainer,i.parmDesigns){
for(j=0;j<i.parmDesigns.length;j++)i.parmDesigns[j]=x(b.parameters.queryStrParams,i.parmDesigns[j],j);if(Object.keys(b.parameters.queryStrParams).length<i.parmDesigns.length&&b.missingParams)return void v(b,e,i);b.parameters=i}else b.parameters=null;else b.parameters||(b.parameters=null);if((b.queryKey||b.queryContainer)&&(b.queryContainer?g.queryContainer=b.queryContainer:g.catalogItemKey=b.queryKey,(b.isFiltered||b.parameters)&&(h.suppressPrompts=!0),b.parameters&&(h.parameters=b.parameters),b.queryEngine=new d(g),b.queryEngine.execute(h).done(z.bind(null,b,e)).fail(H.bind(null,b)),e.evalMobile)){var k=new d(g),l=a.extend(!0,{},h);l.evalOnly=!0,l.suppressPrompts=!0,k.execute(l).done(u.bind(null,b)).fail(H.bind(null,b))}}function u(a,b){b.rowCount>500&&k.showOk(a.translator.translate("CHART_MOBILE_WARNING_MSG"),a.translator.translate("WARNING"))}function v(a,b,c){var e=a.parameters.queryStrParams,f={hasDependencies:!1,parmDesigns:[]},g,h=Object.resolve(d,{catalogItemKey:a.queryKey})
;for(g=0;g<c.parmDesigns.length;g++)e[c.parmDesigns[g].id]&&(c.parmDesigns[g]=x(e,c.parmDesigns[g],g)),f.parmDesigns.push(c.parmDesigns[g]);h.prompt({parameters:f}).done(w.bind(null,a,b))}function w(a,b,c){a.missingParams=!1,t(a,b,c)}function x(a,b,c){return y(b.id,a,b),y("p"+c,a,b),b}function y(a,b,c){var d=b[a];d&&(c.parmPrompts=[d])}function z(a,b,c){var d={},e=a.deferred;a.queryContainer=c.queryContainer,b.formattedQuery=c.queryContainer.isFormatted,b.isUomVisible=c.queryContainer.isUomVisible,d.rawData=c.result,P(d,b),a.alternateCaptionManager.hasAlternateCaptions(b)?a.processCategoryCaptions(a,d,b,e):D(a,e,d,b)}function A(a,b,c){var d={};d.rawData=g.formatDataset(b),a.processData(d,c),a.deferred.resolve(d)}r.prototype.processCategoryCaptions=function(a,b,c,d){a.alternateCaptionManager.hasAlternateCaptions(c)?B(a,b,c,d):D(a,d,b,c)};function B(b,c,d,e){var f=a.Deferred();b.alternateCaptionManager.setAlternateCaptionType(d),
b.alternateCaptionManager.altCaptionFamilyIdChanged(d)?b.alternateCaptionManager.getAlternateCaptions(f,d).done(C.bind(null,b,e,c,d)).fail(D.bind(null,b,e,c,d)):(b.alternateCaptionManager.setAlternateCaptionFamilyId(d),b.alternateCaptionManager.setAlternateCaptionType(d),D(b,e,c,d))}function C(a,b,c,d,e){d.categorySystemCodeTableId&&(a.customCaptionSysCodeTable=!0,a.customCaptions=e),d.categoryStatemachineFmlyId&&(a.customCaptionStateMachine=!0,a.customCaptions=e),a.alternateCaptionManager.setAlternateCaptionFamilyId(d),D(a,b,c,d)}function D(a,b,c,d){a.processData(c,d),b.resolve(c)}function E(a,b){return b.defaultCaption===a.name||b.id===a.name}function F(a,b){return b.value===a.name||b.defaultDescription===a.name}function G(a,b){var d;return a.customCaptionSysCodeTable?d=c.find(a.customCaptions,F.bind(null,b)):a.customCaptionStateMachine&&(d=c.find(a.customCaptions,E.bind(null,b))),d&&(b.name=d.caption),b}r.prototype.processData=function(a,b){
var c=a.rawData.getColumns(),d=I(c,b.series),e=I(c,[{name:b.categoryProperty}]),f=K(c,b.series),h=J(c,b.series),i=[],j=a.rawData.getRows(),k,q,r,s,t=[],u=[];if(a.totalRows=j.length,a.gridData={data:[]},a.chartData=[],i.push.apply(i,this.chartUtilities.CHART_COLORS),"scatter"===b.chartType||"bubble"===b.chartType?(r=I(c,[{name:b.horizontalAxisProperty}]),"bubble"===b.chartType&&(s=I(c,[{name:b.sizeProperty}]))):a.categoryArray=[],"heatmap"===b.chartType){var v;for(b.heatmap.yAxis=[],u=b.heatmap.colorSeries,b.heatmap.colorSeries=[],k=0;k<d.length;k++)v=c[d[k]].getLocalizedAlias()?c[d[k]].getLocalizedAlias():c[d[k]].getAlias(),b.heatmap.yAxis.push(v)}for(k=0;k<j.length;k++)q=j[k].getCells()[e[0]]?g.getFormattedValueFromQuery(b,j[k],e,0):null,"scatter"===b.chartType||"bubble"===b.chartType?o.processData(this,a,b,d,q,r,s,j[k],f,e):"heatmap"===b.chartType?(a.categoryArray[a.categoryArray.length]=q,
p.processData(this,a,b,d,u,j[k],e)):Q(b)?(q=j[k].getCells()[e[0]]?g.getRowValueFromQuery(j[k],e,0):null,a.categoryArray[a.categoryArray.length]=q,n.processData(this,a,b,d,j[k],i,t,e[0])):"timeSeries"===b.chartType?(a.categoryArray[a.categoryArray.length]=q,m.processData(this,a,b,d,j[k],f,e)):(a.categoryArray[a.categoryArray.length]=q,l.processData(this,a,b,d,j[k],f,e,h));Q(b)&&(b.pieSeriesAltered&&b.pieSeries.length>0?b.pieSeries=b.pieSeries.map(G.bind(null,this)):0!==a.chartData.length&&(a.chartData[0].data=a.chartData[0].data.map(G.bind(null,this))),n.setColorValues(this,b,a,t,d,e))};function H(a,b,c,d){var e;if(!d)return void a.deferred.resolve({});e=new h("AG1",d,(new Error).stack),a.errorOccured.raise(a,e)}function I(a,b){var c=[],d,e;if(b)for(e=0;e<b.length;e++)for(d=0;d<a.length;d++)if(b[e].name===a[d].getLocalizedAlias()||b[e].name===a[d].getAlias()){c[c.length]=d;break}return c}function J(a,b){var c,d,e={},f=[]
;if(b)for(d=0;d<b.length;d++)for(c=0;c<a.length;c++)if(b[d].name===a[c].getLocalizedAlias()||b[d].name===a[c].getAlias()){f[c]=d;break}return f}function K(a,b){var c=[],d,e;if(b)for(e=0;e<b.length;e++)for(d=0;d<a.length;d++){if(b[e].hyperlink===a[d].getLocalizedAlias()||b[e].hyperlink===a[d].getAlias()){c[c.length]=d;break}if("None"===b[e].hyperlink){c[c.length]=-1;break}}return c}function L(a,b,c,d){return b[c]===a.getLocalizedAlias()||b[c]===a.getAlias()||!(b[d]!==a.getDefaultCaption()||""===a.getDefaultCaption()||!a.fieldId)}var M=b.curry(function a(b,c){var d=L(b,c,"name","defaultAlias"),e=L(b,c,"hyperlink","hyperlinkAlias");d&&(c.name=b.getLocalizedAlias()?b.getLocalizedAlias():b.getAlias(),c.alias=b.getLocalizedAlias()?b.getLocalizedAlias():b.getAlias(),c.defaultAlias=b.getAlias()?b.getAlias():b.getDefaultCaption()?b.getDefaultCaption():"",c.uniqueId=b.getFieldId()),e&&"None"!==c.hyperlink&&(c.hyperlink=b.getLocalizedAlias()?b.getLocalizedAlias():b.getAlias(),
c.hyperlinkAlias=b.getAlias()?b.getAlias():b.getDefaultCaption()?b.getDefaultCaption():"")}),N=b.curry(function a(c,d){b.forEach(M(d),c.series),O(c,d,"categoryProperty","categoryPropertyAlias"),O(c,d,"horizontalAxisProperty","horizontalAxisPropertyAlias"),O(c,d,"sizeProperty","sizePropertyAlias")});function O(a,b,c,d){var e=!1;a[c]===b.getLocalizedAlias()||a[c]===b.getAlias()?e=!0:a[d]===b.getDefaultCaption()&&""!==b.getDefaultCaption()&&(e=!0),e&&(a[c]=b.getLocalizedAlias()?b.getLocalizedAlias():b.getAlias(),a[d]=b.getDefaultCaption()?b.getDefaultCaption():b.getAlias())}function P(a,c){var d=a.rawData.getColumns();b.forEach(N(c),d)}function Q(a){return"pie"===a.chartType||"donut"===a.chartType||"pyramid"===a.chartType}return r});