/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require,exports,module){"use strict";require("highcharts"),require("highcharts-exporting"),require("highcharts-3d"),require("highcharts-more"),require("highcharts-funnel"),require("highcharts-solid-guage"),require("highcharts-rounded-corners"),require("highcharts-heatmap"),require("noData")
;var a=require("lodash"),b=require("jquery"),c=require("application/application-context"),d=require("ui/elements/chart/models/chart-config-adapter"),e=require("catalog/services/catalog-constants"),f=require("catalog/services/dto/catalog-item-dto"),g=require("ui/elements/chart/models/chart-options-factory"),h=require("ui/elements/chart/process-catalog-item"),i=require("ui/elements/chart/process-query"),j=require("ui/elements/chart/process-json"),k=require("ui/elements/chart/chart-utilities"),l=require("ui/elements/chart/services/chart-service"),m=require("system/globalization/translator"),n=require("system/error/error-message"),o=require("system/diagnostics/log-manager"),p=o.getLogger(module.id),q=require("ui/elements/page-filter/page-filter-connection"),r=require("application/application-events"),s=require("system/ui/busy-indicator");require("ui/elements/tool-bar/view-model"),require("ui/elements/resultgrid/resultgrid-view-model");var t=Object.create(HTMLElement.prototype)
;t.createdCallback=function(){this.internal={chart:null,grid:null},this.state={options:null,config:null,rawData:null,chartData:null,gridData:null,totalRows:null,catalogItem:null,processData:null,timezoneOffset:null},Element.defineProperty(this,"catalogItem",{get:Z.bind(null,this),set:_.bind(null,this)}),this.chartUtilities=new k,this.errorOccured=Object.resolve(r).errorOccured,this.navigate=Object.resolve(r).navigate,this.translator=Object.resolve(m),this.constants=Object.resolve(e),this.pageFilterConnection=Object.resolve(q),this.chartService=Object.resolve(l),this.indicator=Object.resolve(s),this.user=c.user,Element.defineProperty(this,"options",{get:U.bind(null,this),set:V.bind(null,this)}),this._aggregateQueryParams=null,Element.defineProperty(this,"aggregateQueryParams",{get:function(){return this._aggregateQueryParams}.bind(this),set:function(a){this._aggregateQueryParams=a}.bind(this)}),this._isFiltered=null,Element.defineProperty(this,"isFiltered",{get:function(){
return this._isFiltered}.bind(this),set:function(a){this._isFiltered=a}.bind(this)}),this.evalMobile=!1,u()};function u(){window.Highcharts.setOptions({exporting:{enabled:!1}})}t.attachedCallback=function(){var a,b;a=document.createElement("mi-tool-bar"),null!==this.getAttribute("hide-toolbar")&&(a.style.display="none"),a.appendChild(S(this,"icon-map","toggleLegend","CHART_LEGEND")),a.appendChild(S(this,"icon-xi-tag","toggleLabels","CHART_LABELS")),a.appendChild(S(this,"icon-graph","showChart","CHART_CHART",!0)),a.appendChild(S(this,"icon-table-view","showGrid","CHART_GRID")),a.appendChild(S(this,"icon-refresh","reloadWithPrompts","CHART_REFRESH")),null!==this.getAttribute("has-print")&&a.appendChild(S(this,"icon-export","print","EXPORT_TO_PDF")),this.appendChild(a),null!==this.getAttribute("hide-toolbar-legend")&&(a.querySelector(".icon-map").parentNode.style.display="none"),
null!==this.getAttribute("hide-toolbar-labels")&&(a.querySelector(".icon-xi-tag").parentNode.style.display="none"),null!==this.getAttribute("hide-toolbar-graph")&&(a.querySelector(".icon-graph").parentNode.style.display="none"),null!==this.getAttribute("hide-toolbar-table")&&(a.querySelector(".icon-table-view").parentNode.style.display="none"),null!==this.getAttribute("hide-toolbar-refresh")&&(a.querySelector(".icon-refresh").parentNode.style.display="none"),a.addEventListener("click",this),b=document.createElement("div"),b.className="chart-container",a=document.createElement("div"),a.className="chart",b.appendChild(a),b.appendChild(R()),this.internal.grid=document.createElement("mi-resultgrid"),this.internal.grid.setAttribute("selectionmode","single"),this.internal.grid.setAttribute("showgroupingpanel","false"),this.internal.grid.setAttribute("showrowfilter","false"),this.internal.grid.setAttribute("hascolumnchooser","false"),this.internal.grid.loadJSONData=T.bind(null,this),
this.internal.grid.onCellHyperlinkClickCB=$.bind(null,this),b.appendChild(this.internal.grid),this.appendChild(b),this.indicator.attachTo(b),this.parentElement.addEventListener("resize",this),this.pageFilterConnection.open(K.bind(null,this),this),this.chartService.getTimezones().done(H.bind(null,this))},t.detachedCallback=function(){this.internal.chart&&this.internal.chart.destroy(),this.pageFilterConnection.close(),this.internal.grid.removeEventListener("click",this),this.parentElement&&this.parentElement.removeEventListener("resize",this),this.state&&this.state.processData&&this.state.processData.deferred&&this.state.processData.deferred.reject(null,"abort","abort"),this.chartUtilities=null,this.constants=null,this.translator=null,this.errorOccured=null,this.user=null,this.internal=null,this.indicator.detach(),this.chartService=null,this.pageFilterConnection=null,this.state=null,this.isFiltered=null,
this.querySelector("mi-tool-bar")&&this.querySelector("mi-tool-bar").removeEventListener("click",this)},t.attributeChangedCallback=function(a,b,c){var d=this.querySelector("mi-tool-bar");"hide-toolbar"===a?d&&(d.style.display=null===c?"block":"none"):"hide-title"===a?(this.state.options.title.text=O(this),this.redraw()):"hide-toolbar-legend"===a?d.querySelector(".icon-map").parentNode.style.display="none":"hide-toolbar-graph"===a?d.querySelector(".icon-graph").parentNode.style.display="none":"hide-toolbar-labels"===a?d.querySelector(".icon-xi-tag").parentNode.style.display="none":"hide-toolbar-table"===a?d.querySelector(".icon-table-view").parentNode.style.display="none":"hide-toolbar-refresh"===a&&(d.querySelector(".icon-refresh").parentNode.style.display="none")},t.optionsFromConfig=function(a){return this.state.config=d.fromDTO(a),this.state.chartData=a.chartData,this.state.gridData=a.gridData||a.chartData,this.state.options=P(this),this.state.options},t.draw=function(){
this.redraw()},t.redraw=function(){if(this.state&&this.state.options&&(this.state.options.credits=(this.state.options.credits||{}).enabled=!1,this.internal&&this.internal.chart&&this.internal.chart.renderTo&&this.internal.chart.destroy(),null===this.state.options.series&&this.state.config.stock===!0&&(this.state.options.series=this.state.chartData),this.state.options.chart&&this.state.options.chart.renderTo)){try{this.state.timezoneOffset&&window.Highcharts.setOptions({global:{timezoneOffset:this.state.timezoneOffset,useUTC:!1},lang:{noData:this.translator.translate("CHART_NO_DATA"),loading:this.translator.translate("CHART_LOADING"),resetZoom:this.translator.translate("CHART_RESET_ZOOM"),resetZoomTitle:this.translator.translate("CHART_RESET_ZOOM_TEXT")}}),this.state.config.stock&&this.state.config.stock===!0?this.internal.chart=new window.Highcharts.StockChart(this.state.options):this.internal.chart=new window.Highcharts.Chart(this.state.options)}catch(a){if(p.error(a),
this.internal&&(this.internal.chart=null),this.translator)throw this.translator.translate("CHART_RENDER_ERROR")}aa(this),this.classList.contains("show-grid")&&this.internal&&this.internal.grid.reload()}},t.saveState=function(){return this.state.showGrid=this.classList.contains("show-grid"),this.state},t.loadState=function(a){var b,c,d;this.state=a,this.state.options&&(b=this.state.options.legend.enabled,c=this.state.options.plotOptions.series.dataLabels.enabled,d=this.state.options.xAxis.categories),this.state.options=P(this,d),this.state.options.legend.enabled=b,this.state.options.plotOptions.series.dataLabels.enabled=c,X(this),Y(this),this.state.showGrid&&(this.showGrid(),this.state.showGrid=null),aa(this),this.draw()},t.load=function(b){var c=!1;this.indicator.show(),b&&(this.state.config=d.fromDTO(b),b.data&&(this.state.rawData=b.data),!b.queryParams||void 0!==this.isFiltered&&null!==this.isFiltered||(this.aggregateQueryParams=b.queryParams),
b.queryStrParams&&(this.aggregateQueryParams={queryString:!0,queryStrParams:b.queryStrParams}),this.state.catalogItem||(this.state.catalogItem={},this.state.catalogItem.itemType=this.constants.ITEM_TYPE_GRAPH),this.state.catalogItem.key=b.catalogKey,this.state.catalogItem.path=b.catalogPath,c=b.delegateLoadToFilter||!1,b.evalMobile&&(this.evalMobile=!0)),W(this,b?b.data:null),v(this,c)||a.isObject(this.state)&&(this.evalMobile&&(this.state.config.evalMobile=!0),this.state.processData.load(this.state.config).done(N.bind(null,this)).fail(Q.bind(null,this)))};function v(a,b){return!!b&&a.pageFilterConnection.remote.isConnected()}t.reload=function(){w(this)},t.print=function(){this.internal.chart.print()},t.reloadWithPrompts=function(){w(this,!0)};function w(a,b){var c=b||!1;a.indicator.show(),a.state&&a.state.processData?a.state.processData.load(a.state.config,!0,c).done(N.bind(null,a)).fail(Q.bind(null,a)):setTimeout(N.bind(null,a),0)}t.reConfigure=function(){var a={
rawData:this.state.rawData};this.state.processData||W(this,this.state.rawData),this.state.processData.processData(a,this.state.config).done(x.bind(null,this,a))};function x(a,b){M(a,b),a.redraw()}t.handleEvent=function(a){z(this,a),y(this,a)};function y(a,b){"resize"===b.type&&a.redraw()}function z(a,b){"click"!==b.type||B(b.target)||(A(a,b),C(b.target))}function A(a,b){var c=D(b.target);c&&Object.tryMethod(a,c)}function B(a){return a.disabled||a.parentElement.disabled}function C(a){"A"===a.nodeName&&(a.href||a.hash)&&a.setAttribute("target","tab")}function D(a){var b=a.getAttribute("data-action");return b?b:a.parentElement.getAttribute("data-action")}t.toggleLegend=function(){var a;this.state.options&&(a=!this.state.options.legend.enabled,this.state.options.legend.enabled=a,F(this.internal.chart,a),E(this.internal.chart,a),this.internal.chart.render(),X(this))};function E(a,b){a.options.legend.enabled=b,b||a.legend.destroy()}function F(a,b){var c,d
;for(c=0;c<a.series.length;c++)d=a.series[c],d.options.showInLegend=b,b||(d.legendIem=null,a.legend.destroyItem(d))}t.toggleLabels=function(){var a;this.state.options&&(a=!this.state.options.plotOptions.series.dataLabels.enabled,this.state.options.plotOptions.series.dataLabels.enabled=a,G(this.internal.chart.series,a),this.internal.chart.redraw(!1),Y(this))};function G(a,b){var c,d;for(c=0;c<a.length;c++)d=a[c].options,d.dataLabels.enabled=b,a[c].update(d,!1)}t.showChart=function(){this.classList.remove("show-grid"),this.querySelector('button[data-action="toggleLegend"]').disabled=!1,this.querySelector('button[data-action="toggleLabels"]').disabled=!1,this.querySelector('button[data-action="showChart"]').classList.add("active"),this.querySelector('button[data-action="showGrid"]').classList.remove("active"),this.redraw()},t.showGrid=function(){this.classList.add("show-grid"),this.querySelector('button[data-action="toggleLegend"]').disabled=!0,
this.querySelector('button[data-action="toggleLabels"]').disabled=!0,this.querySelector('button[data-action="showChart"]').classList.remove("active"),this.querySelector('button[data-action="showGrid"]').classList.add("active"),this.internal.grid.reload()};function H(a,b){var c,d,e;for(c=0;c<b.length;c++)if(a.user&&b[c].id===a.user.timezoneId){var f=/\(([^)]+)\)/,g=f.exec(b[c].name);null!==g&&(d=g[1].replace(/[UTC]/g,"")),d.indexOf(":")>-1?d=d.split(":"):e=0,d[0]&&d[0].indexOf("-")>-1?(d[0]=Number(d[0].replace("-","")),d[1].indexOf("30")>-1?d[1]=5:d[1].indexOf("45")>-1?d[1]=75:d[1]=0,e=60*Number(d[0]+"."+d[1])):d[0]&&d[0].indexOf("+")>-1&&(d[0]=Number(d[0].replace("+","")),d[1].indexOf("30")>-1?d[1]=5:d[1].indexOf("45")>-1?d[1]=75:d[1]=0,e=-(60*Number(d[0]+"."+d[1]))),I(a)&&(e=4),a.state.timezoneOffset=e}}function I(a){var b=c.user.timezoneId
;return"UTC"===b||J(a,b,"Morocco")||J(a,b,"Dublin")||J(a,b,"Edinburgh")||J(a,b,"Lisbon")||J(a,b,"London")||J(a,b,"Casablanca")||J(a,b,"Coordinated Universal Time")||J(a,b,"Monrovia")||J(a,b,"Reykjavik")||J(a,b,"GMT Standard Time")||J(a,b,"Greenwich Standard Time")}function J(a,b,c){return String.prototype.indexOf.call(b,c)!==-1}function K(b,c){b.pageFilterConnection.remote.isConnected()&&!b.skipFilterLoad&&(c&&c.parmDesigns&&c.parmDesigns.length?b.aggregateQueryParams=c:b.aggregateQueryParams=void 0,a.delay(b.load.bind(b),500))}function L(a){a.dispatchEvent(new CustomEvent("loaded",{bubble:!0}))}function M(a,b){a.state&&(a.state.rawData=b.rawData,a.state.gridData=b.gridData,a.state.chartData=b.chartData,a.state.totalRows=b.totalRows,b.catalogItem&&(a.state.catalogItem=b.catalogItem),b.config&&(a.state.config=b.config),a.state.options=P(a,b.categoryArray),Y(a),X(a))}function N(a,b){b&&M(a,b),L(a),a.draw(),a.indicator.hide()}function O(a){var b=null
;return null===a.getAttribute("hide-title")&&(a.state.catalogItem&&(b=a.state.catalogItem.caption||a.state.catalogItem.id),b=b||a.state.config.title),b}function P(a,b){var c=a.state.config,d=a.querySelector(".chart"),e=O(a),f=g.create(d,c,e);if(f)return f.getOptions(a.state.chartData,b)}function Q(a,b,c,d){if(b&&404===b.status){var e=a.querySelector(".chart-container");e&&(e.innerHTML=a.translator.translate("CHART_NOT_FOUND"),e.className=e.className+" not-found-message")}else{if("abort"===c||"abort"===d)return;var f=new n("AG1",d,(new Error).stack);a.errorOccured.raise(a,f)}}function R(){var a;return a=document.createElement("div"),a.className="chart-detail-view",a}function S(a,b,c,d,e){var f,g;return f=document.createElement("button"),f.className="btn btn-default btn-icon",f.setAttribute("data-action",c),f.setAttribute("title",a.translator.translate(d)),e&&f.classList.add("active"),g=document.createElement("i"),g.className=b,f.appendChild(g),f}function T(a){var c=b.Deferred()
;return a.state&&a.state.gridData&&c.resolve(k.formatGridData(a.state.gridData)),c}function U(a){return a.state.options}function V(b,c){a.isObject(b.state)&&(b.state.options=c),c&&b.state&&b.state.options&&b.state.options.chart&&(b.state.options.chart.renderTo=b.querySelector(".chart"),L(b)),b.redraw()}function W(b,c){
b.state&&b.state.catalogItem&&b.state.catalogItem.graph&&b.state.catalogItem.graph.queryKey?b.state.processData=new h(b.state.catalogItem,b.aggregateQueryParams,b.isFiltered):b.state&&b.state.catalogItem&&b.state.catalogItem.graph&&b.state.catalogItem.graph.datasetKey?b.state.processData=new h(b.state.catalogItem,b.aggregateQueryParams,b.isFiltered):b.state&&b.state.catalogItem&&(b.state.catalogItem.key||b.state.catalogItem.path)?b.state.processData=new h(b.state.catalogItem,b.aggregateQueryParams,b.isFiltered):b.state&&b.state.config&&b.state.config.queryKey?b.state.processData=new i(b.state.config,b.aggregateQueryParams,b.isFiltered):a.isObject(b.state)&&(b.state.processData=new j(c))}function X(a){var b;(b=a.querySelector('button[data-action="toggleLegend"]'))&&(a.state.options&&a.state.options.legend.enabled?b.classList.add("active"):b.classList.remove("active"),b.blur())}function Y(a){var b
;(b=a.querySelector('button[data-action="toggleLabels"]'))&&(a.state.options&&a.state.options.plotOptions.series&&a.state.options.plotOptions.series.dataLabels&&a.state.options.plotOptions.series.dataLabels.enabled?b.classList.add("active"):b.classList.remove("active"),b.blur())}function Z(a){return a.state.catalogItem||(a.state.catalogItem=new f,a.state.catalogItem.itemType=a.constants.ITEM_TYPE_GRAPH),a.state.catalogItem.graph||(a.state.catalogItem.graph={}),a.state.catalogItem.stock||(a.state.catalogItem.stock=!1),a.state.catalogItem.graph.config=d.serialize(a.state.config),a.state.catalogItem}function $(a,b){b.hyperlinkUrl.indexOf("http")>-1?window.open(b.hyperlinkUrl,"_blank"):b.hyperlinkUrl.indexOf("!")>-1?a.navigate.raise(b.hyperlinkUrl.replace("!",""),{isActionRoute:!0}):a.navigate.raise(b.hyperlinkUrl,{tab:!0})}function _(a,b){a.state.catalogItem=b,b&&b.graph&&b.graph.config?a.state.config=d.deserialize(b.graph.config):a.state.config=d.fromDTO({})}function aa(a){
a.state.options.chart.animation=!1,void 0!==a.state.options.plotOptions&&a.state.options.plotOptions.series?a.state.options.plotOptions.series.animation=!1:a.state.options.plotOptions={series:{animation:!1}}}return document.registerElement("mi-chart",{prototype:t}),t});