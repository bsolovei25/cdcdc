/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("application/application-events"),c=require("application/application-context"),d=require("knockout"),e=require("system/globalization/translator"),f=require("./catalog-events"),g=require("./model/folder-model"),h=require("./model/catalog-item-model"),i=require("system/error/error-message"),j=require("spa/ko/knockout-view-model"),k=require("system/knockout/knockout-manager"),l=require("./adapters/catalog-item-adapter"),m=require("./adapters/folder-adapter"),n=require("./services/dto/user-pref-dto"),o=require("./services/catalog-service"),p=require("./services/catalog-constants"),q=require("text!./views/catalog-dialog-details.html");function r(a,b,d,f){s.call(this,q),this.applicationEvents=b,this.events=d,this.kom=a,this.service=f,this.constants=new p,this.translator=Object.resolve(e),this.user=c.user,this.session=c.session,this.catalogService=f,this.intendedTypes=[],this.initPath="",this.isItemPath=!1,
this.selectedFolderKey=null,this.selectedFolder=null,this.catalogItems=null,this.catalogItemCount=null,this.sortColumn=null,this.sortOrder=null,this.headerSortImgName=null,this.headerSortImgCaption=null,this.headerSortImgDesc=null,this.headerSortImgType=null,this.visibleHeaders=null,this.selectedItemVm=null}var s=Object.inherit(j,r);r.dependsOn=[k,b,f,o],r.prototype.load=function b(c){var d=new a.Deferred;return this.selectedFolderKey=this.kom.observable(),this.selectedFolder=this.kom.observable(),this.catalogItems=this.kom.observableArray(),this.catalogItemCount=this.kom.observable(),this.filteredCatalogItems=this.kom.computed(t.bind(null,this)),this.selectedItemVm=this.kom.observable(null),this.sortColumn=this.kom.observable("hdrName"),this.sortOrder=this.kom.observable("asc"),this.headerSortImgName=this.kom.computed(z.bind(null,this,"hdrName")),this.headerSortImgCaption=this.kom.computed(z.bind(null,this,"hdrCaption")),
this.headerSortImgDesc=this.kom.computed(z.bind(null,this,"hdrDesc")),this.headerSortImgType=this.kom.computed(z.bind(null,this,"hdrType")),this.visibleHeaders=this.kom.observable(!1),d.promise()},r.prototype.activate=function a(){this.events.folderNavigated.add(this.onFolderNavigated,this),this.events.beforeFolderNavigated.add(this.onBeforeFolderNavigated,this)},r.prototype.navigateToPath=function b(c){var d=this,e=new a.Deferred;return this.initPath=c||"",this.initPath?d.catalogService.getFolderParents(c).done(u.bind(null,d,e)).fail(y.bind(null,d)):d.catalogService.getFolderRoots(c).done(u.bind(null,d,e)).fail(y.bind(null,d)),e.promise()},r.prototype.attach=function a(b){s.prototype.attach.call(this,b),this.region=b},r.prototype.detach=function a(b){s.prototype.detach.call(this,b)},r.prototype.canUnload=function a(){return!0},r.prototype.deactivate=function a(b){this.kom.disposeSubscriptions(),this.kom.disposeComputeds(),this.events.folderNavigated.remove(this),
this.events.beforeFolderNavigated.remove(this)},r.prototype.unload=function a(){this.kom.disposeObservables()},r.prototype.translate=function a(b){return this.translator.translate(b)},r.prototype.onBeforeFolderNavigated=function a(b){},r.prototype.onFolderNavigated=function a(b){b?v(this,b):(this.selectedFolderKey(null),this.selectedFolder(null),this.selectedItemVm(null))},r.prototype.onItemClicked=function a(b,c){var e=d.dataFor(c.target);e&&e instanceof h&&(this.selectedItemVm()&&this.selectedItemVm().isSelected(!1),this.selectedItemVm(e),this.selectedItemVm().isSelected(!0))},r.prototype.isAdmin=function a(){if(this.user.isSuperUser)return!0;if(void 0===this.user.groups||null===this.user.groups)return!1;for(var b=0;b<this.user.groups.length;b++)if(this.user.groups[b].id===this.constants.GRP_CATALOG_ADMIN||this.user.groups[b].id===this.constants.GRP_POWER_USER)return!0;return!1},r.prototype.onHeaderClick=function a(b,c){var d=c.target.id;""===d&&(d=c.target.parentElement.id),
""===d&&(d=c.target.parentElement.parentElement.id),""===d&&(d=c.target.parentElement.parentElement.parentElement.id),this.sortColumn()===d?"asc"===this.sortOrder()?this.sortOrder("desc"):this.sortOrder("asc"):(this.sortColumn(d),this.sortOrder("asc")),this.catalogItems&&this.catalogItems()&&this.catalogItems.sort(A.bind(null,this))},r.prototype.isIntendedType=function a(b){var c=!1,d=0;for(c=0===this.intendedTypes.length,d=0;d<this.intendedTypes.length;d++)if(b.toLowerCase()===this.intendedTypes[d].toString().toLowerCase()){c=!0;break}return c},d.bindingHandlers.scrollToSelectedItem={update:function(b,c){d.utils.unwrapObservable(c()),a("tr.info")&&a("tr.info")[0]&&a("tr.info")[0].scrollIntoView()}};function t(a){var b,c;return c=a.catalogItems(),0===a.intendedTypes.length?b=c:(c=d.utils.arrayFilter(c,function(b){return a.isIntendedType(b.itemTypeDisplay())}),b=c),b}function u(a,b,c){a.events.navigationRequested.raise(c),v(a,c[c.length-1].key),b.resolve()}function v(b,c){
var d=new a.Deferred,e=new a.Deferred;a.when(d,e).then(function(){b.selectedFolderKey(c)}),b.service.getFolder(c).done(w.bind(null,b,d)).fail(y.bind(null,b)),b.service.getCatalogItems(c).done(x.bind(null,b,e)).fail(y.bind(null,b))}function w(a,b,c){a.selectedFolder(m.toModelObject(c)),b.resolve()}function x(a,b,c){var e,f;if(a.catalogItems(l.toModelObjectArray(c)),a.selectedItemVm(null),void 0===c||null===c?a.catalogItemCount(0):a.catalogItemCount(c.length),a.catalogItems&&a.catalogItems()&&(a.catalogItems.sort(A.bind(null,a)),a.isItemPath&&(null!==a.initPath&&(e=a.initPath.split("\\").pop().toLowerCase()),f=d.utils.arrayFirst(a.catalogItems(),function(a){return a.id().toLowerCase()===e})))){f.isSelected(!0),a.selectedItemVm(f);var g=f.$element}b.resolve()}function y(a,b){var c=2,d=i.fromHttpResponse(c,b);a.applicationEvents.errorOccured.raise(a,d)}function z(a,b){return a.sortColumn()===b?"asc"===a.sortOrder()?"icon-up-arrow":"icon-up-arrow rotate-180":""}function A(a,b,c){
var d="",e="";switch(a.sortColumn()){case"hdrName":d=b.id().toLowerCase(),e=c.id().toLowerCase();break;case"hdrCaption":d=b.caption().toLowerCase(),e=c.caption().toLowerCase();break;case"hdrDesc":d=b.description().toLowerCase(),e=c.description().toLowerCase();break;case"hdrType":d=b.itemTypeDisplay().toLowerCase(),e=c.itemTypeDisplay().toLowerCase()}switch(a.sortOrder()){case"asc":return d<e?-1:d>e?1:0;case"desc":return d>e?-1:d<e?1:0}}return r});