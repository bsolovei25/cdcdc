/* Copyright Â© 1993-2019 Meridium, Inc. All rights reserved.  */
define(function(require){"use strict";var a=require("jquery"),b=require("system/ui/message-box"),c=require("toastr"),d=require("system/globalization/translator"),e=require("application/application-context"),f=require("./application-events"),g=require("./window-event-handler"),h=require("./application-error-handler"),i=require("application/application-service"),j=require("security/model/login-manager"),k=require("system/hardware/device"),l=require("security/offline-login/context/offline-login-context"),m=require("system/mobile/device-connectivity"),n=require("security/view-models/login-view-model"),o=require("ramda"),p=1e3,q=60,r=60,s=24,t="api/core/utility/unauthorizedping";function u(){this.appEvents=Object.resolve(f),this.windowEventHandler=Object.resolve(g),this.applicationErrorHandler=Object.resolve(h),this.applicationService=Object.resolve(i),this.intervalId=null,this.loginManager=Object.resolve(j),this.device=Object.resolve(k),this.deviceConnectivity=Object.resolve(m),
this.login=Object.resolve(n)}u.singleton=!0,u.prototype.load=function(){v()?window.broadcaster.addEventListener("PredixSDK.ReachabilityChanged",w.bind(null,this)):(a(document).ajaxError(A.bind(null,this)),a(document).ajaxSuccess(L.bind(null,this)),a(document).ajaxComplete(Q),a.ajaxPrefilter(S))};function v(){return!!window.PredixSDK}function w(a,b){var c=b.ReachabilityStatus;x(c)?L(a):y(c)?E(a):H(a)}function x(a){return y(a)&&z(a)}function y(a){return o.contains("Online",a)}function z(a){return o.contains("Authenticated",a)}function A(a,b,c){e.sessionStatus.isActive!==!1&&(B(c)?a.notifySessionTimeout():(F(c)||a.deviceConnectivity.getManualOfflineStatus())&&G(a))}function B(a){return 401===a.status&&!a.preventSessionTimeoutDefault}function C(a){return a.device.isMobileApp()}u.prototype.notifySessionTimeout=function(){var a=Object.resolve(d),c=a.translate("SESSION_EXPIRED_TITLE"),f=a.translate("SESSION_EXPIRED_MSG"),g=[{name:a.translate("CANCEL")},{name:a.translate("LOGIN")}]
;e.sessionStatus.isActive!==!1&&(e.sessionStatus.isActive=!1,this.appEvents.sessionChanged.raise(this,e.sessionStatus),this.appEvents.sessionExpired.raise(),b.show(f,c,g).done(D.bind(null,this)))};function D(a,b){1===b&&(a.windowEventHandler.unload(),a.applicationErrorHandler.unload(),window.location.reload())}function E(a){var c=Object.resolve(d),f=c.translate("SESSION_EXPIRED_TITLE"),g=c.translate("SESSION_EXPIRED_MSG"),h=[{name:c.translate("CANCEL")},{name:c.translate("LOGIN")}];e.sessionStatus.isActive=!1,a.appEvents.sessionChanged.raise(a,e.sessionStatus),a.appEvents.sessionExpired.raise(),b.show(g,f,h).done(D.bind(null,a))}function F(a){return 500!==a.status&&((0!==a.status||"abort"!==a.statusText&&"timeout"!==a.statusText)&&null===a.getResponseHeader("X-Meridium-Version"))}function G(a){e.connectionStatus.connected&&(I(a),J(a))}function H(a){e.connectionStatus.connected&&I(a)}function I(a){e.connectionStatus.connected=!e.connectionStatus.connected,
e.connectionStatus.lastStatusChange=new Date,a.appEvents.connectionChanged.raise(a,e.connectionStatus)}function J(a){a.intervalId=setInterval(K.bind(null,a),6e4)}function K(a){a.applicationService.ping().done(L.bind(null,a))}function L(a){a.intervalId&&(clearInterval(a.intervalId),a.intervalId=null),e.connectionStatus.connected||a.deviceConnectivity.getManualOfflineStatus()||(O(a),N(a).done(M.bind(null,a)).done(T.bind(null,a)).fail(P.bind(null,a)))}function M(a,c){if(!c){var e=Object.resolve(d),f=e.translate("SESSION_EXPIRED_TITLE"),g=e.translate("SESSION_EXPIRED_MSG"),h=[{name:e.translate("OK")}];b.show(g,f,h).done(a.login.logout.bind(a.login))}}function N(a){return a.applicationService.checkuserauthentication(e.user.id)}function O(a){I(a)}function P(a){e.sessionStatus.isActive=!1,a.appEvents.sessionChanged.raise(a,e.sessionStatus),V()?aa(a):X(a)}function Q(a,b,c){R(c.url,t)||(e.connectionStatus.lastResponse=new Date)}function R(a,b){return a.indexOf(b)>-1}function S(a){
a.contents.javascript=!1}function T(b){var c=e.session.id,d=a.Deferred();return b.applicationService.checksession(c).done(U.bind(null,d)),d.promise()}function U(a,b){b===!0?a.resolve():a.reject()}function V(){return(new Date-W())/p/q/r>s}function W(){return e.connectionStatus.lastResponse}function X(a){_(a).then(Y.bind(null,a)).then($.bind(null,a)).done(L.bind(null,a))}function Y(a,b){var c=Z(a);return b=a.loginManager.overrideApiServer(b,c),a.loginManager.setContextSession(b),a.loginManager.saveSession(b),a.loginManager.registerAjaxClientWithSession(b),a.loginManager.setLocalStorageUserDataSourceApiServer(b,c),b}function Z(){return e.session.apiServer}function $(a,b){a.loginManager.saveUserCulture(b),a.loginManager.getUser().catch(a.loginManager.onFailedUserLoad).then(a.loginManager.checkIfPasswordHasToChange.bind(a.loginManager)).then(a.loginManager.setContextUser).then(a.loginManager.registerAjaxClientWithUser)}function _(a){
var b=e.session.datasourceId,c=e.session.userId,d=l.user.password;return a.loginManager.login(b,c,d)}function aa(a){a.appEvents.offlineSessionExpired.raise()}return u});